<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; base-uri 'self'; object-src 'none'; script-src 'self' https: 'unsafe-inline' 'unsafe-eval'; style-src 'self' https: 'unsafe-inline'; img-src 'self' https: data: blob:; font-src 'self' https: data:; connect-src 'self' https: wss:; upgrade-insecure-requests">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Wallit">
  <link rel="apple-touch-icon" href="wallit-icon-512.png">
  <link rel="icon" type="image/png" href="wallit-icon-512.png">
  <title>Wallit</title>

  <script>
   // Perf: disable verbose logs by default (set window.DEBUG=true in console if needed)
   window.DEBUG = false;
   window.dlog = (...args) => { if (window.DEBUG) console.log(...args); };
  </script>
  <script>
/* ========================================
  Viewport-Centered Toast (emoji-free)
  ======================================== */
(function(){
  const EMOJI_RE = /[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}\u{FE00}-\u{FE0F}]/gu;

  window.showToast = function(message, type = "success"){
    // Remove emoji icons from messages (e.g., ‚úÖ ‚ùå üì± etc.)
    const clean = String(message || "")
      .replace(EMOJI_RE, "")
      .replace(/\s{2,}/g, " ")
      .trim();

    // Ensure a single toast at a time
    const existing = document.querySelector(".toast-container");
    if(existing) existing.remove();

    const container = document.createElement("div");
    container.className = "toast-container";

    const toast = document.createElement("div");
    toast.className = "toast-notification toast-" + (type === "error" ? "error" : "success");
    toast.textContent = clean || "OK";

    container.appendChild(toast);
    document.body.appendChild(container);

    
// --- v15.1 hotfix: missing instance helper used by year view templates ---
if (typeof FinanceManagerCloud !== 'undefined' && !FinanceManagerCloud.prototype.escapeHtml) {
  FinanceManagerCloud.prototype.escapeHtml = function (value) {
    const s = String(value ?? '');
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return s.replace(/[&<>"']/g, (ch) => map[ch]);
  };
}
// --- end hotfix ---

setTimeout(() => {
      container.style.opacity = "0";
      container.style.transition = "opacity 0.25s ease";
      setTimeout(() => container.remove(), 260);
    }, 2600);
  };
})();

</script>

<script>
/* ========================================
  Perf: Lazy-load heavy libraries on demand
  - Chart.js: dashboard/year/investments charts
  - d3 + d3-sankey: dashboard sankey
  - xlsx: export only
  ======================================== */
(function(){
 const _scriptPromises = new Map();
 function loadScriptOnce(src, {crossOrigin=null} = {}) {
  if (_scriptPromises.has(src)) return _scriptPromises.get(src);
  const p = new Promise((resolve, reject) => {
   const s = document.createElement('script');
   s.src = src;
   s.async = true;
   if (crossOrigin) s.crossOrigin = crossOrigin;
   s.onload = () => resolve(true);
   s.onerror = () => reject(new Error('Failed to load ' + src));
   document.head.appendChild(s);
  });
  _scriptPromises.set(src, p);
  return p;
 }

 window.ensureChartJS = async () => {
  if (window.Chart) return true;
  return loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js');
 };

 window.ensureD3Sankey = async () => {
  if (window.d3 && window.d3.sankey) return true;
  if (!window.d3) await loadScriptOnce('https://d3js.org/d3.v7.min.js');
  // d3-sankey expects d3 global
  if (!window.d3.sankey) await loadScriptOnce('https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js');
  return true;
 };


 window.ensureJSQR = async () => {
  if (window.jsQR) return true;
  // Lightweight QR decoder used for in-modal QR scanning (works on iOS Safari).
  return loadScriptOnce('https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js');
 };

 window.ensureZXing = async () => {
  if (window.ZXingBrowser) return true;
  // Barcode decoder (EAN/UPC/Code128, etc.) - UMD build exposes global ZXingBrowser
  return loadScriptOnce('https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js');
 };

 // Optional: warm up DNS/TLS without blocking
 try {
  const pre = (href) => {
   const l = document.createElement('link');
   l.rel = 'preconnect';
   l.href = href;
   l.crossOrigin = 'anonymous';
   document.head.appendChild(l);
  };
  pre('https://cdnjs.cloudflare.com');
  pre('https://d3js.org');
  pre('https://cdn.jsdelivr.net');
  pre('https://www.gstatic.com');
 } catch(e){}
})();
</script>

<script defer src="https://cdn.tailwindcss.com"></script>
  <script>
/* Wallit Secure API bootstrap (no Firebase client, no API key in HTML) */
(() => {
  const API_BASE = "https://wallit-api-792606369733.europe-west3.run.app";
  window.WALLIT_API_BASE = API_BASE;

  async function apiRequest(path, { method = "GET", body, headers = {}, credentials = "include" } = {}) {
    const url = API_BASE.replace(/\/$/, "") + path;
    const opts = { method, credentials, headers: { ...headers } };

    if (body !== undefined) {
      opts.headers["Content-Type"] = opts.headers["Content-Type"] || "application/json";
      opts.body = (typeof body === "string") ? body : JSON.stringify(body);
    }

    const res = await fetch(url, opts);
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const data = ct.includes("application/json") ? await res.json().catch(() => null) : await res.text().catch(() => null);

    return { ok: res.ok, status: res.status, data, res };
  }

  window.wallitApi = {
    request: apiRequest,
    get: (p) => apiRequest(p),
    post: (p, b) => apiRequest(p, { method: "POST", body: b }),
    put: (p, b) => apiRequest(p, { method: "PUT", body: b }),
  };

  // Ensure old firebase flags exist but are disabled
  window.firebaseReady = false;
  window.firebaseDB = null;
})();
</script>
  <style>
    /* ==========================================
      CSS VARIABLEN - Design System
      ========================================== */
    :root {
      /* Spacing System - 8px Grid */
      --space-0: 0;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      
      /* Farben Light Mode - HOHER KONTRAST */
      --bg-primary: #ffffff;
      --bg-secondary: #f1f5f9;
      --bg-tertiary: #e2e8f0;
      --bg-gradient-page: #e2e8f0;
      
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-tertiary: #64748b;
      --text-inverse: #ffffff;
      
      --border-light: #cbd5e1;
      --border-medium: #94a3b8;
      --border-dark: #64748b;
      
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-hover: #4f46e5;
      
      --status-success: #10b981;
      --status-warning: #f59e0b;
      --status-error: #ef4444;
      --status-info: #3b82f6;
      
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.55);
      --shadow-xl: 0 18px 36px rgba(0, 0, 0, 0.62);
      
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
      --transition-slow: 300ms ease;
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
    }
    
    /* ==========================================
      BASE STYLES
      ========================================== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* ==========================================
      DARK MODE - CSS Variablen √ºberschreiben
      ========================================== */
    body.dark-mode {
      /* Dark Mode Variablen */
      --bg-primary: rgba(50, 50, 70, 0.8);
      --bg-secondary: rgba(60, 60, 80, 0.6);
      --bg-tertiary: rgba(70, 70, 90, 0.5);
      --bg-gradient-page: #252540;
      
      --text-primary: #e0e0e0;
      --text-secondary: #c0c0c0;
      --text-tertiary: #a0a0a0;
      
      --border-light: rgba(255, 255, 255, 0.10);
      --border-medium: rgba(255, 255, 255, 0.14);
      --border-dark: rgba(255, 255, 255, 0.18);
      
      --accent-primary: #818cf8;
      --accent-secondary: #a78bfa;
      --accent-hover: #a5b4fc;
      
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.35);
      --shadow-md: 0 6px 14px rgba(0, 0, 0, 0.45);
      --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.55);
      --shadow-xl: 0 18px 36px rgba(0, 0, 0, 0.62);
      
      /* Legacy Styles (werden nach und nach durch Variablen ersetzt) */
      background: #1a1a2e;
      color: #e0e0e0;
    }
    
    body.dark-mode .bg-gradient-to-br {
      background: linear-gradient(135deg, rgba(30, 30, 50, 0.9) 0%, rgba(20, 20, 35, 0.95) 100%) !important;
    }
    
    body.dark-mode .bg-gradient-to-r {
      background: linear-gradient(135deg, rgba(30, 30, 50, 0.9) 0%, rgba(20, 20, 35, 0.95) 100%) !important;
    }
    
    body.dark-mode .bg-white {
      background: rgba(30, 30, 50, 0.8) !important;
      border-color: rgba(255, 255, 255, 0.10) !important;
    }
    
    body.dark-mode .text-[color:var(--text-primary)],
    body.dark-mode .text-gray-700,
    body.dark-mode .text-[color:var(--text-tertiary)] {
      color: #e0e0e0 !important;
    }
    
    body.dark-mode .text-[color:var(--text-tertiary)] {
      color: #c0c0c0 !important;
    }
    
    body.dark-mode .text-gray-400 {
      color: #d0d0d0 !important;
    }
    
    /* Input Icons - wie Date Picker */
    .input-icon {
      color: #6b7280; /* gray-500 im Light Mode - dunkler */
    }
    
    .input-icon:hover {
      color: #4b5563; /* gray-600 im Light Mode - noch dunkler */
    }
    
    body.dark-mode .input-icon {
      color: #d1d5db !important; /* gray-300 im Dark Mode - gut sichtbar */
    }
    
    body.dark-mode .input-icon:hover {
      color: #f3f4f6 !important; /* gray-100 im Dark Mode */
    }
    
    /* Chart.js Texte im Dark Mode heller machen */
    body.dark-mode canvas {
      filter: brightness(1.4);
    }
    
    body.dark-mode .border-gray-100,
    body.dark-mode .border-gray-200 {
      border-color: rgba(255, 255, 255, 0.10) !important;
    }
    
    /* Navigation Sections: Subtiler Border im Dark Mode */
    body.dark-mode .nav-section {
      border-color: rgba(255, 255, 255, 0.08) !important;
    }
    
    body.dark-mode .bg-gray-50 {
      background: rgba(40, 40, 60, 0.6) !important;
    }
    
    body.dark-mode input,
    body.dark-mode select {
      background: rgba(50, 50, 70, 0.8) !important;
      color: #e0e0e0 !important;
      border-color: rgba(255, 255, 255, 0.14) !important;
    }
    
    /* Select Dropdown Pfeil im Dark Mode - muss direkt nach der Regel oben kommen */
    body.dark-mode select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") !important;
      background-repeat: no-repeat !important;
      background-position: right 1rem center !important;
      background-size: 16px !important;
    }
    
    body.dark-mode input::placeholder,
    body.dark-mode select::placeholder {
      color: #909090 !important;
    }
    
    /* Date Input Calendar Icon im Dark Mode wei√ü */
    body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }
    
    /* Statistik-Karten im Dark Mode */
    body.dark-mode .from-blue-50,
    body.dark-mode .from-green-50,
    body.dark-mode .from-red-50,
    body.dark-mode .from-orange-50,
    body.dark-mode .from-purple-50,
    body.dark-mode .from-emerald-50,
    body.dark-mode .from-indigo-50,
    body.dark-mode .from-cyan-50 {
      background: rgba(40, 40, 60, 0.7) !important;
    }
    
    /* Farben in Dark Mode erhalten */
    body.dark-mode .text-blue-700,
    body.dark-mode .text-blue-800,
    body.dark-mode .text-blue-900 {
      color: #60a5fa !important;
    }
    
    body.dark-mode .text-green-700,
    body.dark-mode .text-green-800,
    body.dark-mode .text-green-900 {
      color: #4ade80 !important;
    }
    
    body.dark-mode .text-red-700,
    body.dark-mode .text-red-800,
    body.dark-mode .text-red-900 {
      color: #f87171 !important;
    }
    
    body.dark-mode .text-orange-700,
    body.dark-mode .text-orange-800,
    body.dark-mode .text-orange-900 {
      color: #fb923c !important;
    }
    
    body.dark-mode .text-purple-700,
    body.dark-mode .text-purple-800,
    body.dark-mode .text-purple-900 {
      color: #c084fc !important;
    }
    
    body.dark-mode .text-emerald-700,
    body.dark-mode .text-emerald-800,
    body.dark-mode .text-emerald-900 {
      color: #34d399 !important;
    }
    
    body.dark-mode .text-indigo-700,
    body.dark-mode .text-indigo-800,
    body.dark-mode .text-indigo-900 {
      color: #818cf8 !important;
    }
    
    body.dark-mode .text-cyan-700,
    body.dark-mode .text-cyan-800 {
      color: #22d3ee !important;
    }
    
    body.dark-mode .bg-indigo-50 {
      background: rgba(99, 102, 241, 0.15) !important;
    }
    
    body.dark-mode .text-indigo-600 {
      color: #818cf8 !important;
    }
    
    body.dark-mode .border-indigo-200 {
      border-color: rgba(99, 102, 241, 0.4) !important;
    }
    
    /* Buttons im Dark Mode - keine Schatten */
    body.dark-mode .bg-red-500 {
      background: #ef4444 !important;
    }
    
    body.dark-mode .bg-green-500 {
      background: #10b981 !important;
    }
    
    body.dark-mode .hover\:bg-red-600:hover {
      background: #dc2626 !important;
    }
    
    body.dark-mode .hover\:bg-green-600:hover {
      background: #059669 !important;
    }
    
    .tab-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.10);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .tab-inactive {
      background: white;
      color: #4b5563;
      border: 2px solid rgba(0, 0, 0, 0.1);
    }
    
    /* üë• USER TABS */
    .user-tab {
      min-width: 100px;
      position: relative;
    }
    
    .user-tab-active {
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: scale(1.05);
      border-width: 3px !important;
    }
    
    .user-tab-active::before {
      content: '‚úì';
      position: absolute;
      top: -6px;
      right: -6px;
      background: #10b981;
      color: white;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }
    
    .user-tab-inactive {
      background: white;
      opacity: 0.5;
      border-width: 2px;
      filter: grayscale(30%);
    }
    
    .user-tab-inactive:hover {
      opacity: 0.8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
      filter: grayscale(0%);
    }
    
    body.dark-mode .user-tab-active::before {
      background: #10b981;
    }
    
    body.dark-mode .user-tab-inactive {
      background: rgba(40, 40, 60, 0.6);
      opacity: 0.5;
      color: #e0e0e0 !important;
      filter: grayscale(30%);
    }
    
    body.dark-mode .user-tab-inactive:hover {
      opacity: 0.8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      filter: grayscale(0%);
    }
    
    /* Fix f√ºr Info-Boxen im Dark Mode */
    
    /* üì± Responsive Tabs - Text verstecken auf sehr kleinen Screens */
    @media (max-width: 480px) {
      .tab-active span,
      .tab-inactive span {
        display: none;
      }
      
      .tab-active,
      .tab-inactive {
        padding: var(--space-3) var(--space-4);
        min-width: auto;
      }
    }
    
    /* üì± Responsive Typography - Kleinere Headlines auf Mobile */
    @media (max-width: 640px) {
      /* ALLE Headlines - sehr aggressiv */
      h1, h2, h3, h4,
      h1 span, h2 span, h3 span, h4 span {
        font-size: 1.125rem !important; /* 18px f√ºr alle */
      }
      
      /* Spezifische Gr√∂√üen */
      .text-4xl,
      .text-4xl span {
        font-size: 1.375rem !important; /* 22px statt 36px */
      }
      
      .text-3xl,
      .text-3xl span {
        font-size: 1.25rem !important; /* 20px statt 30px */
      }
      
      .text-2xl,
      .text-2xl span {
        font-size: 1.125rem !important; /* 18px statt 24px */
      }
      
      .text-xl,
      .text-xl span {
        font-size: 1rem !important; /* 16px statt 20px */
      }
      
      .text-lg,
      .text-lg span {
        font-size: 0.9375rem !important; /* 15px statt 18px */
      }
      
      /* Description text kleiner */
      .text-sm {
        font-size: 0.8125rem !important; /* 13px statt 14px */
      }
      
      .kpi-sub {
        font-size: 0.6875rem !important; /* 11px statt 12px */
      }
      
      /* Section descriptions */
      p.text-sm {
        font-size: 0.8125rem !important;
        line-height: 1.4;
      }
    }
    body.dark-mode .bg-blue-50 {
      background: rgba(59, 130, 246, 0.15) !important;
    }
    
    body.dark-mode .text-blue-700 {
      color: #93c5fd !important;
    }
    
    body.dark-mode .border-blue-200 {
      border-color: rgba(59, 130, 246, 0.4) !important;
    }
    
    /* Fix f√ºr Verwalten-Button im Dark Mode */
    body.dark-mode .bg-gray-100 {
      background: rgba(70, 70, 90, 0.6) !important;
      color: #e0e0e0 !important;
    }
    
    body.dark-mode .bg-gray-100:hover,
    body.dark-mode .hover\:bg-gray-200:hover {
      background: rgba(90, 90, 110, 0.8) !important;
    }
    
    body.dark-mode .tab-inactive {
      background: rgba(40, 40, 60, 0.6);
      color: #b0b0b0;
      border: 2px solid rgba(255, 255, 255, 0.08);
    }

    body.dark-mode .tab-active {
      border: 2px solid rgba(255, 255, 255, 0.14);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    }
    
    .sync-animation {
      animation: rotate 1s linear infinite;
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    
    /* Button Zoom Effect - Smooth & Clean */
    button, .btn-zoom {
      transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
    }
    
    button:hover:not(:disabled), .btn-zoom:hover {
      transform: scale(1.05);
      filter: brightness(1.15);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    button:active:not(:disabled), .btn-zoom:active {
      transform: scale(0.98);
      filter: brightness(1);
    }
    
    /* Collapsible Header: Kein Zoom, kein Schatten */
    .nav-section > div > button:first-child:hover,
    .nav-section > div > button:first-child:active {
      transform: none !important;
      box-shadow: none !important;
      filter: none !important;
    }
    
    /* Dark Mode - st√§rkerer Glow f√ºr bessere Sichtbarkeit */
    body.dark-mode button:hover:not(:disabled), 
    body.dark-mode .btn-zoom:hover {
      filter: brightness(1.2);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }
    
    /* Bunte Action Buttons */
    .btn-upload {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btn-upload:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    .btn-upload:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .btn-download {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btn-download:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    .btn-download:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .btn-export {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btn-export:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    .btn-export:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .btn-reset {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      border-radius: 12px;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btn-reset:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    .btn-reset:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    /* Primary Action Buttons - Indigo/Purple Gradient */
    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      box-shadow: var(--shadow-md);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      border: none;
      color: white;
      font-weight: 600;
      padding: var(--space-3) var(--space-4);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    .btn-primary:active {
      transform: scale(0.98);
      box-shadow: var(--shadow-sm);
    }
    
    /* Success/Edit Buttons - Blue Gradient */
    .btn-edit {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: var(--shadow-md);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      border: none;
      color: white;
      font-weight: 600;
      padding: var(--space-3) var(--space-4);
    }
    
    .btn-edit:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    /* Save/Confirm Buttons - Green Gradient */
    .btn-save {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: var(--shadow-md);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      border: none;
      color: white;
      font-weight: 600;
      padding: var(--space-3) var(--space-4);
    }
    
    .btn-save:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    /* Delete/Danger Buttons - Red Gradient */
    .btn-delete {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: var(--shadow-md);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      border: none;
      color: white;
      font-weight: 600;
      padding: var(--space-3) var(--space-4);
    }
    
    .btn-delete:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    /* Secondary/Cancel Buttons - Gray */
    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      box-shadow: var(--shadow-md);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
      border: none;
      color: white;
      padding: var(--space-3) var(--space-4);
      font-weight: 600;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    /* Dark Mode - Buttons mit subtileren Schatten */
    body.dark-mode .btn-upload,
    body.dark-mode .btn-download,
    body.dark-mode .btn-export,
    body.dark-mode .btn-reset {
      filter: none !important;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    body.dark-mode .btn-upload:hover,
    body.dark-mode .btn-download:hover,
    body.dark-mode .btn-export:hover,
    body.dark-mode .btn-reset:hover {
      filter: none !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    /* Nur TAB-Active Buttons bekommen hellen Gradient */
    body.dark-mode .tab-active {
      background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%) !important;
    }
    
    body.dark-mode .tab-active:hover {
      background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%) !important;
    }
    
    /* Header Gradient im Dark Mode korrigieren */
    body.dark-mode h1.bg-gradient-to-r {
      background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%) !important;
      -webkit-background-clip: text !important;
      background-clip: text !important;
    }
    
    /* Karten und Nicht-Buttons NICHT aufhellen */
    body.dark-mode .bg-gradient-to-r:not(button):not(.tab-active):not(h1) {
      background: linear-gradient(135deg, rgba(30, 30, 50, 0.9) 0%, rgba(20, 20, 35, 0.95) 100%) !important;
      filter: none !important;
    }
    
    /* Top 5 Ausgaben - normale dunkle Karten */
    body.dark-mode .from-gray-50.to-gray-100 {
      background: rgba(40, 40, 60, 0.6) !important;
    }
    
    /* Sparquoten-Balken im Dark Mode - Gleiche Farbe wie Prozent-Text */
    body.dark-mode .bg-indigo-200 {
      background: rgba(129, 140, 248, 0.2) !important;
    }
    
    body.dark-mode .border-indigo-300 {
      border-color: rgba(129, 140, 248, 0.5) !important;
    }
    
    body.dark-mode .from-indigo-500 {
      background: #818cf8 !important;
      filter: none !important;
    }
    
    body.dark-mode .to-purple-600 {
      /* Wird durch .from-indigo-500 √ºberschrieben */
    }
    
    /* Monatswechsel-Pfeile im Dark Mode sichtbar machen */
    body.dark-mode .text-gray-700 {
      color: #e0e0e0 !important;
    }
    
    body.dark-mode button.text-gray-700:hover {
      background: rgba(102, 126, 234, 0.3) !important;
    }
    
    /* Heatmap Styles */
    .heatmap-day {
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .heatmap-day:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .heatmap-label {
      font-size: 10px;
      font-weight: 600;
    }
    
    /* Sankey Diagram */
    .sankey-node rect {
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .sankey-node rect:hover {
      opacity: 0.8;
    }
    
    .sankey-link {
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    
    .sankey-link:hover {
      opacity: 0.8;
    }
    
    /* Modal Dialog */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999998;
      backdrop-filter: blur(4px);
      padding: max(var(--space-4), env(safe-area-inset-top)) var(--space-4) max(var(--space-4), env(safe-area-inset-bottom)) var(--space-4);
      box-sizing: border-box;
      /* removed */
    }
    
    body.dark-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.85);
    }
    
    /* Notification Modals (Cloud warnings, etc.) - Bulletproof Centering */
    .notification-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile */
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999998;
      padding: var(--space-5);
      box-sizing: border-box;
      /* removed */
    }
    
    .notification-modal > div {
      position: relative;
      margin: auto;
      flex-shrink: 0;
    }
    
    body.dark-mode .notification-modal{
  background: rgba(0,0,0,0.85);
}
    
    .modal-content {
      background: white;
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 500px;
      width: 100%;
      /* removed */
      /* removed */
      box-shadow: var(--shadow-xl);
      animation: modalSlideIn 0.3s ease-out;
      margin: auto;
    }
    
    /* iPhone Safe Area Support */
    @supports (padding: max(0px)) {
      .modal-content {
        padding: max(24px, env(safe-area-inset-top)) max(24px, env(safe-area-inset-right)) max(24px, env(safe-area-inset-bottom)) max(24px, env(safe-area-inset-left));
      }
    }
    
    /* Kleinere Modals auf mobilen Ger√§ten */
    @media (max-width: 640px) {
      .modal-content {
        width: calc(100% - 32px);
        padding: 20px;
        /* removed */
      }
      
      .modal-content h3 {
        font-size: 1.25rem;
      }
      
      .modal-content .flex.gap-3 {
        flex-direction: column;
      }
      
      .modal-content .flex.gap-3 button {
        width: 100%;
      }
    }
    
    /* Sehr kleine Screens (iPhone SE, etc.) */
    @media (max-width: 375px) {
      .modal-content {
        padding: 16px;
        border-radius: 12px;
      }
      
      .modal-content h3 {
        font-size: 1.125rem;
        margin-bottom: 0.75rem;
      }
      
      .modal-content p {
        font-size: 0.875rem;
        margin-bottom: 1rem;
      }
    }
    
    /* Gr√∂√üere Modals f√ºr komplexe Inhalte */
    .modal-content-large {
      max-width: 600px;
    }
    
    @media (max-width: 640px) {
      .modal-content-large {
        max-width: 100%;
      }
    }
    
    body.dark-mode .modal-content{
      background: rgba(45, 45, 65, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
    }

    body.dark-mode .modal-content h3{ color: var(--text-primary) !important; }

    body.dark-mode .modal-content p{ color: var(--text-secondary) !important; }

    
    body.dark-mode .modal-content button.bg-gray-300 {
      background: rgba(70, 70, 90, 0.8) !important;
      color: #e0e0e0 !important;
      border: 1px solid rgba(255, 255, 255, 0.10);
    }
    
    body.dark-mode .modal-content button.bg-gray-300:hover {
      background: rgba(90, 90, 110, 0.9) !important;
    }
    
    /* Gr√ºne Buttons in Modals */
    body.dark-mode .modal-content button.bg-green-500 {
      background: #10b981 !important;
      color: white !important;
    }
    
    body.dark-mode .modal-content button.bg-green-500:hover,
    body.dark-mode .modal-content button.hover\:bg-green-600:hover {
      background: #059669 !important;
    }
    
    /* Orange Buttons in Modals (Warnungen) */
    body.dark-mode .modal-content button.bg-orange-500 {
      background: #f59e0b !important;
      color: white !important;
    }
    
    body.dark-mode .modal-content button.bg-orange-500:hover,
    body.dark-mode .modal-content button.hover\:bg-orange-600:hover {
      background: #d97706 !important;
    }
    
    /* Blaue Buttons in Modals (Info) */
    body.dark-mode .modal-content button.bg-blue-500 {
      background: #3b82f6 !important;
      color: white !important;
    }
    
    body.dark-mode .modal-content button.bg-blue-500:hover,
    body.dark-mode .modal-content button.hover\:bg-blue-600:hover {
      background: #2563eb !important;
    }
    
    /* Rote Buttons in Modals (Fehler) */
    body.dark-mode .modal-content button.bg-red-500 {
      background: #ef4444 !important;
      color: white !important;
    }
    
    body.dark-mode .modal-content button.bg-red-500:hover,
    body.dark-mode .modal-content button.hover\:bg-red-600:hover {
      background: #dc2626 !important;
    }
    
    /* Text-white in Modal-Buttons sicherstellen */
    body.dark-mode .modal-content button.text-white {
      color: white !important;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px; /* 16px verhindert Auto-Zoom auf iOS */
      transition: border-color 0.2s;
    }
    
    .modal-input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    body.dark-mode .modal-input {
      background: rgba(50, 50, 70, 0.8);
      color: #e0e0e0;
      border-color: rgba(255, 255, 255, 0.14);
    }

    body.dark-mode .modal-content label {
      color: #e0e0e0 !important;
    }

    /* üé® Pill-Buttons f√ºr User-ID (Modern Style) */
    .bg-indigo-100 {
      background: rgba(99, 102, 241, 0.12) !important;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
    }

    .bg-indigo-100:hover {
      background: rgba(99, 102, 241, 0.18) !important;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }

    .bg-indigo-100:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .bg-orange-100 {
      background: rgba(249, 115, 22, 0.12) !important;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
    }

    .bg-orange-100:hover {
      background: rgba(249, 115, 22, 0.18) !important;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }

    .bg-orange-100:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    body.dark-mode .bg-indigo-100 {
      background: rgba(99, 102, 241, 0.2) !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .bg-orange-100 {
      background: rgba(249, 115, 22, 0.2) !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    /* üé® KONTRAST-FIXES f√ºr bessere Lesbarkeit im Dark Mode */
    
    /* Lila Intervall-Badges */
    body.dark-mode .bg-purple-50 {
      background: rgba(168, 85, 247, 0.15) !important;
    }
    
    body.dark-mode .text-purple-700 {
      color: #c084fc !important;
    }
    
    body.dark-mode .border-purple-200 {
      border-color: rgba(168, 85, 247, 0.4) !important;
    }
    
    /* Blaue Edit-Buttons (au√üerhalb Modals) */
    body.dark-mode .bg-blue-500:not(.modal-content *) {
      background: #3b82f6 !important;
    }
    
    body.dark-mode .hover\:bg-blue-600:hover:not(.modal-content *) {
      background: #2563eb !important;
    }
    
    /* Gelbe Stern-Icons bei Vorlagen */
    body.dark-mode .text-yellow-500 {
      color: #fbbf24 !important;
    }
    
    /* Standard-Badge Blau */
    body.dark-mode .text-blue-600 {
      color: #60a5fa !important;
    }
    
    body.dark-mode .border-blue-200 {
      border-color: rgba(59, 130, 246, 0.4) !important;
    }
    
    /* Gray-600 Text heller machen */
    body.dark-mode .text-[color:var(--text-tertiary)] {
      color: #d0d0d0 !important;
    }

    /* üì± MOBILE OPTIMIERUNGEN - Nur f√ºr Smartphones, Desktop bleibt gleich! */
    @media (max-width: 768px) {
      /* Verhindert Auto-Zoom bei Input-Focus (iOS) */
      input, select, textarea {
        font-size: 16px !important;
      }

      /* Kleinere Abst√§nde auf Mobile */
      .max-w-7xl {
        padding-left: 1rem !important;
        padding-right: 1rem !important;
      }

      /* Buttons touch-friendly */
      button {
        min-height: 44px;
        min-width: 44px;
      }

      /* Tabs scrollbar auf Mobile */
      .flex.gap-3.mb-6 {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Kleinere Schrift auf Mobile */
      h1 {
        font-size: 1.875rem !important;
      }

      h2 {
        font-size: 1.5rem !important;
      }

      /* Kompaktere Cards auf Mobile */
      .rounded-2xl {
        padding: 1rem !important;
      }

      /* Tabellen horizontal scrollbar */
      table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
      }

      /* Kleinere Buttons auf Mobile */
      .px-6 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }

      .py-3 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }
    }

    /* üì± EXTRA KLEIN (iPhone SE) */
    @media (max-width: 375px) {
      h1 {
        font-size: 1.5rem !important;
      }

      .text-4xl, .text-5xl {
        font-size: 1.5rem !important;
      }
    }

    /* üé® Safe Area f√ºr iPhone Notch */
    @supports (padding: max(0px)) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }

    /* üéØ SVG Icon Alignment - Icons INLINE mit Text */
    h1 svg, h2 svg, h3 svg, h4 svg {
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    button svg {
      display: inline-block;
      vertical-align: middle;
    }

    button span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* SVG Icons generell inline */
    svg {
      display: inline-block;
      vertical-align: middle;
    }

    /* üîî Toast Notifications */
    .toast-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
    }

    @media (max-width: 768px) {
      .toast-notification {
        top: 10px;
        right: 10px;
        left: 10px;
      }
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  
    /* ‚úÖ v5.1: Einheitliche H√∂he f√ºr alle Eingabefelder (Input/Select) ‚Äì Layout unver√§ndert */
    :root {
      --fm-control-height: 44px;
      --fm-control-padding-x: 12px;
    }

    /* Standard Form Controls (ohne Checkbox/Radio/Range/File/Color) */
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]):not([type="color"]),
    select {
      height: var(--fm-control-height) !important;
      min-height: var(--fm-control-height) !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      padding-left: var(--fm-control-padding-x) !important;
      padding-right: var(--fm-control-padding-x) !important;
      font-size: 16px !important; /* verhindert iOS Auto-Zoom */
      line-height: var(--fm-control-height) !important;
    }
    
    /* Select Dropdown Pfeil - gleicher Abstand wie Date Picker Icon */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 16px;
      padding-right: 2.5rem !important;
    }

    /* Inputs in Modals (falls separat genutzt) */
    .modal-input {
      height: var(--fm-control-height) !important;
      min-height: var(--fm-control-height) !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      padding-left: var(--fm-control-padding-x) !important;
      padding-right: var(--fm-control-padding-x) !important;
      font-size: 16px !important;
      line-height: var(--fm-control-height) !important;
    }
    
    /* Date-Inputs: Stelle sicher dass padding-right normal bleibt (nicht wie bei Select mit Dropdown-Icon) */
    input[type="date"].modal-input {
      padding-right: var(--fm-control-padding-x) !important;
    }

    /* Textareas bewusst NICHT fixieren (sonst UX kaputt) ‚Äì nur Typo angleichen */
    textarea {
      font-size: 16px !important;
    }

    /* ‚úÖ v5.2: Einheitliche Button-H√∂he & sauberes Alignment zu Inputs (ohne Layout-√Ñnderung) */
    button:not(.tab-active):not(.tab-inactive):not(.user-tab):not(.dark-mode-toggle):not(.text-left) {
      height: var(--fm-control-height) !important;
      min-height: var(--fm-control-height) !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center;
    }

    /* Einheitliches Icon/Text-Alignment */
    button:not(.dark-mode-toggle) svg {
      flex: 0 0 auto;
    }

  
    /* üß≠ v7 Layout: Desktop Sidebar + Mobile Bottom Nav */
    .bottom-nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height:88px;
      padding: var(--space-3) var(--space-2) calc(var(--space-2) + env(safe-area-inset-bottom));
      display:flex;
      gap: var(--space-2);
      justify-content:space-between;
      align-items:stretch;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1.5px solid rgba(0,0,0,0.12);
      box-shadow: 0 -8px 24px rgba(0,0,0,0.12), 0 -1px 0 rgba(255,255,255,0.5);
      z-index: 999;
    }
    .bn-item{
      flex:1;
      position: relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: var(--space-1);
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 0.01em;
      color: #6b7280;
      background: transparent;
      padding: var(--space-2) var(--space-2);
      border: none;
      min-height: 64px;
      cursor: pointer;
      transition: color 180ms ease, background-color 180ms ease;
    }
    
    /* Label with indicator */
    .bn-label{
      position: relative;
      display: inline-block;
      padding-bottom: 6px;
    }
    
    .bn-label::after{
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 2px;
      border-radius: 999px;
      background: transparent;
      transform: scaleX(0);
      transform-origin: center;
      transition: transform 180ms ease, background-color 180ms ease;
    }
    
    .bn-active .bn-label::after{
      background: #4f46e5;
      transform: scaleX(1);
    }
    
    .bn-item svg{ 
      width: 26px;
      height: 26px;
      transition: transform 180ms ease;
    }
    
    .bn-item:not(.bn-active):hover{
      background: rgba(79,70,229,0.06);
    }
    
    .bottom-nav button:hover{ 
      transform:none !important; 
      box-shadow:none !important; 
      filter:none !important; 
    }
    
    .bn-active{
      color: #4f46e5 !important;
      background: transparent !important;
      font-weight: 700;
    }
    
    body.dark-mode .bottom-nav{
      background: rgba(17,24,39,0.95);
      border-top: 1.5px solid rgba(255,255,255,0.15);
      box-shadow: 0 -10px 28px rgba(0,0,0,0.55), 0 -1px 0 rgba(255,255,255,0.05);
    }
    
    body.dark-mode .bn-item{ 
      color: rgba(255,255,255,0.60);
    }
    
    body.dark-mode .bn-item:not(.bn-active):hover{
      background: rgba(165,180,252,0.08);
    }
    
    body.dark-mode .bn-active{
      color: #a5b4fc !important;
      background: transparent !important;
    }
    
    body.dark-mode .bn-active .bn-label::after{
      background: #a5b4fc;
    }
    
    /* üåó Dark Mode Toggle Switch - Separate Class */
    .dark-mode-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
      background-color: #d1d5db;
      border-radius: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      border: none;
      padding: 0;
      outline: none;
      flex-shrink: 0;
    }
    
    .dark-mode-switch:focus {
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.3);
    }
    
    .dark-mode-switch.active {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }
    
    .dark-mode-switch-thumb {
      position: absolute;
      top: 50%;
      left: 4px;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 10px;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .dark-mode-switch.active .dark-mode-switch-thumb {
      transform: translate(24px, -50%);
    }
    
    body.dark-mode .dark-mode-switch {
      background-color: #4b5563;
    }
    
    body.dark-mode .dark-mode-switch.active {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    
    /* ==========================================
      CHECKBOX STYLING - Sch√∂ner & sichtbarer
      ========================================== */
    input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-medium);
      border-radius: 4px;
      background: var(--bg-primary);
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    input[type="checkbox"]:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }
    
    input[type="checkbox"]:checked {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-color: var(--accent-primary);
    }
    
    input[type="checkbox"]:checked::after {
      content: '‚úì';
      position: absolute;
      color: white;
      font-size: 14px;
      font-weight: bold;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    input[type="checkbox"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);
    }
    
    /* Dark Mode */
    body.dark-mode input[type="checkbox"] {
      border-color: var(--border-medium);
    }
    
    body.dark-mode input[type="checkbox"]:checked {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    
    /* ==========================================
      COLOR PICKER STYLING - Sch√∂ner & gr√∂√üer
      ========================================== */
    input[type="color"] {
      appearance: none;
      -webkit-appearance: none;
      width: 80px;
      height: 44px;
      border: 2px solid var(--border-medium);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0;
      background: none;
      overflow: hidden;
    }
    
    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
      margin: 0;
      border: none;
      width: 100%;
      height: 100%;
    }
    
    input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 6px;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }
    
    input[type="color"]::-moz-color-swatch {
      border: none;
      border-radius: 6px;
      width: 100%;
      height: 100%;
    }
    
    input[type="color"]::-moz-focus-inner {
      border: none;
      padding: 0;
    }
    
    input[type="color"]:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
      transform: scale(1.05);
    }
    
    input[type="color"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);
    }
    
    /* Mobile: Gr√∂√üerer Touchbereich */
    @media (max-width: 768px) {
      input[type="color"] {
        width: 100px;
        height: 50px;
      }
    }
    
    /* ==========================================
      NOTIFICATION ANIMATIONS
      ========================================== */
    @keyframes slideDown {
      from {
        transform: translate(-50%, -100%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .animate-slideDown {
      animation: slideDown 0.3s ease-out forwards;
    }
    
    .animate-modalFadeIn {
      animation: modalFadeIn 0.3s ease-out forwards;
    }
    
    .animate-slideUp {
      animation: slideUp 0.3s ease-out forwards;
    }

    /* ==========================================
      ‚úÖ Einheitliche Card-Outline ‚Äì NUR DARK MODE
      ========================================== */
    body.dark-mode{
      --card-outline: #353C6C;
    }

    /* Alle echten Card-Container, die bereits eine Border haben */
    body.dark-mode .bg-white.border,
    body.dark-mode .bg-gray-50.border,
    body.dark-mode .nav-section,
    body.dark-mode .bg-gradient-to-br.border,
    body.dark-mode .bg-gradient-to-r.border{
      border-color: var(--card-outline) !important;
    }

    /* Jahres√ºbersicht-Kacheln & Gradient-Cards ohne Border-Klasse */
    body.dark-mode .bg-gradient-to-br.rounded-lg:not(button):not(h1):not(h2):not(h3):not(h4),
    body.dark-mode .bg-gradient-to-r.rounded-lg:not(button):not(h1):not(h2):not(h3):not(h4){
      border: 1px solid var(--card-outline) !important;
    }

    /* Sicherheit: Tailwind-Status-Border-Klassen im Dark Mode neutralisieren */
    body.dark-mode .border-blue-200,
    body.dark-mode .border-red-200,
    body.dark-mode .border-green-200,
    body.dark-mode .border-orange-200,
    body.dark-mode .border-purple-200,
    body.dark-mode .border-indigo-200,
    body.dark-mode .border-cyan-200,
    body.dark-mode .border-emerald-200,
    body.dark-mode .border-gray-100,
    body.dark-mode .border-gray-200{
      border-color: var(--card-outline) !important;
    }


    /* ==========================================
      PANEL SHADOW SYSTEM (robust, independent of Tailwind)
      ========================================== */
    .panel-card{
      /* Force shadow even if Tailwind shadow-* is present */
      box-shadow: var(--shadow-lg) !important;
    }
    body.dark-mode .panel-card{
      /* mehr Tiefe im Dark Mode, ohne Glow */
      box-shadow: 0 14px 28px rgba(0,0,0,0.45) !important;
    }

    /* ==========================================
      SIDEBAR NAVIGATION SYSTEM
      ========================================== */
    .sidebar-nav-container {
      padding: var(--space-4);
    }
    
    .sidebar-nav-title {
      margin-bottom: var(--space-3);
    }
    
    .sidebar-nav-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .sidebar-nav-button {
      padding: var(--space-3) var(--space-4);
      gap: var(--space-3);
      border-radius: var(--radius-lg);
      transition: var(--transition-base);
    }

    /* ==========================================
      ACTION BUTTONS (URL/√Ñndern, etc.)
      ========================================== */
    .action-btn-small {
      padding: var(--space-1) var(--space-2); /* 4px 8px */
      gap: var(--space-1);           /* 4px */
      border-radius: var(--radius-sm);     /* 8px */
      font-size: 0.75rem;            /* 12px */
      font-weight: 600;
      transition: var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Action Button Variants */
    .action-btn-primary {
      background: #eef2ff;
      color: #4f46e5;
    }
    
    .action-btn-primary:hover {
      background: #e0e7ff;
    }
    
    .action-btn-warning {
      background: #fef3c7;
      color: #d97706;
    }
    
    .action-btn-warning:hover {
      background: #fde68a;
    }
    
    body.dark-mode .action-btn-primary {
      background: rgba(99, 102, 241, 0.15);
      color: #a5b4fc;
    }
    
    body.dark-mode .action-btn-primary:hover {
      background: rgba(99, 102, 241, 0.25);
    }
    
    body.dark-mode .action-btn-warning {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
    }
    
    body.dark-mode .action-btn-warning:hover {
      background: rgba(245, 158, 11, 0.25);
    }

  
/* ========================================
  Robust Notification System (Final)
  ======================================== */

.toast-container {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 10000;
}

.toast-notification {
  pointer-events: auto;
  padding: var(--space-4) var(--space-5);
  border-radius: var(--radius-lg);
  font-weight: 600;
  box-shadow: 0 20px 50px rgba(0,0,0,0.35);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  max-width: 90%;
  text-align: center;
  animation: fadeInScale 0.2s ease-out;
}

.toast-success {
  background: rgba(16,185,129,0.95);
  color: #fff;
}

.toast-error {
  background: rgba(239,68,68,0.95);
  color: #fff;
}

@keyframes fadeInScale {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}


/* ========================================
  Robust Notification System (iPhone-safe, centered)
  ======================================== */

/* ========================================
  Notification Modal Buttons (more prominent)
  Scoped to .notification-modal to avoid affecting app buttons
  ======================================== */
.notification-modal .fm-notify-btn{
  width: 100%;
  min-height: 52px;
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-lg);
  font-size: 16px;
  font-weight: 800;
  letter-spacing: 0.01em;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  transition: transform 180ms ease, filter 180ms ease, box-shadow 180ms ease, background-color 180ms ease, border-color 180ms ease;
  user-select: none;
}
.notification-modal .fm-notify-primary{
  color: #0b2a6f;
  background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(219,234,254,0.98) 100%);
  border: 2px solid rgba(255,255,255,0.65);
  box-shadow: 0 16px 32px rgba(0,0,0,0.28), 0 0 0 1px rgba(255,255,255,0.20) inset;
}
.notification-modal .fm-notify-primary:hover{
  filter: brightness(1.03);
  box-shadow: 0 18px 36px rgba(0,0,0,0.30), 0 0 0 1px rgba(255,255,255,0.28) inset;
}
.notification-modal .fm-notify-secondary{
  color: rgba(255,255,255,0.92);
  background: rgba(255,255,255,0.08);
  border: 1.5px solid rgba(255,255,255,0.22);
  box-shadow: 0 10px 22px rgba(0,0,0,0.18);
  font-weight: 650;
}
.notification-modal .fm-notify-secondary:hover{
  background: rgba(255,255,255,0.12);
  border-color: rgba(255,255,255,0.30);
}
body.dark-mode .notification-modal .fm-notify-primary{
  color: #0b2a6f; /* stays readable on bright button */
}
body.dark-mode .notification-modal .fm-notify-secondary{
  background: rgba(255,255,255,0.10);
  border-color: rgba(255,255,255,0.26);
}


.toast-container{
  position: fixed;
  top: 0; 
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  height: 100dvh;    /* modern browsers */
  height: 100svh;    /* iOS Safari stable viewport */
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  padding:
    max(var(--space-4), env(safe-area-inset-top))
    var(--space-4)
    max(var(--space-4), env(safe-area-inset-bottom))
    var(--space-4);
  pointer-events: none;
  z-index: 999999;
}

/* ‚úÖ FIX v15.1: Toast sichtbar in allen States (auch nach Kredit-Edit/Delete) 
  - Entfernt Konflikt mit √§lterem .toast-notification (fixed/top/right)
  - Toast bleibt im Center der .toast-container (iPhone-safe) */
.toast-container { pointer-events: none; }
.toast-container .toast-notification{
  position: relative !important;
  top: auto !important;
  right: auto !important;
  left: auto !important;
  bottom: auto !important;
  z-index: auto !important;

  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-align: center;

  padding: 14px 16px;
  border-radius: 18px;
  max-width: min(520px, calc(100vw - 32px));
  box-shadow: 0 18px 60px rgba(0,0,0,0.30);
  font-size: 14px;
  line-height: 1.25;
  font-weight: 700;
  letter-spacing: 0.01em;

  animation: fadeInScale 0.2s ease-out;
}

/* Fallback: wenn Toast ohne Container erzeugt wird */
.toast-notification.toast-success,
.toast-notification.toast-error{
  padding: 14px 16px;
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,0.30);
}


.toast-notification{
  pointer-events: auto;
  width: min(400px, calc(100vw - 48px));
  max-width: calc(100vw - 48px);
  /* removed */
  /* removed */
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-md);
  font-size: 15px;
  font-weight: 600;
  line-height: 1.4;
  text-align: center;
  box-shadow: 0 20px 50px rgba(0,0,0,0.35);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  animation: fadeInScale 0.2s ease-out;
  word-wrap: break-word;
}

.toast-success{ background: rgba(16,185,129,0.95); color:#fff; }
.toast-error{ background: rgba(239,68,68,0.95); color:#fff; }

    body.dark-mode .toast-success{ background: rgba(16,185,129,0.90); }
body.dark-mode .toast-error{ background: rgba(239,68,68,0.90); }

@keyframes fadeInScale{
  from{ opacity:0; transform: scale(0.96); }
  to{ opacity:1; transform: scale(1); }
}


/* ========================================
  Floating Action Button (FAB) - Quick Upload
  ======================================== */
#fabUpload {
  transition: transform 0.2s ease;
}

#fabUpload:hover {
  transform: scale(1.05);
}

#fabUpload:active {
  transform: scale(0.98);
}

#fabUpload.has-changes circle {
  fill: #f59e0b;
}

/* FAB sichtbar auf Mobile + Desktop (Visibility wird via JS + Firebase-Status gesteuert) */
/* ==========================================
  Light Mode: Outlines for KPI tiles (Year overview)
  ========================================== */
.fm-outline {
  border: 1px solid var(--border-light);
}
body.dark-mode .fm-outline {
  border-color: #353C6C !important; /* keep consistent with dark-mode card outline system */
}


/* --- Force notification blue card to match light mode in dark mode --- */
body.dark-mode .notification-modal .bg-gradient-to-br{
  background: linear-gradient(135deg, #3b82f6 0%, #4f46e5 100%) !important;
  color: #ffffff !important;
}
body.dark-mode .notification-modal .bg-blue-600{
  background-color: rgba(37, 99, 235, 0.85) !important;
}


    /* ===========================
      Haushalt-Modal (Light + Dark) ‚Äî subtle + aligned + correct layout
      =========================== */

    .household-modal{
      --hm-radius: 18px;
      --hm-pad: 16px;

      --hm-title: clamp(20px, 2.6vw, 26px);
      --hm-label: 13px;

      --hm-input-fs: 15px;
      --hm-input-py: 10px;
      --hm-input-px: 12px;
      --hm-input-radius: 12px;

      --hm-btn-fs: 15px;
      --hm-btn-py: 10px;
      --hm-btn-px: 12px;
      --hm-btn-radius: 12px;

      --hm-card-radius: 18px;
      --hm-card-pad: 14px;

      --hm-emoji: 28px;
      --hm-name: clamp(20px, 2.4vw, 24px);
      --hm-id: 13px;
      --hm-note: 12px;

      border-radius: var(--hm-radius);
      padding: var(--hm-pad);
    }

    .household-modal .hm-title{
      margin: 0 0 var(--space-3) 0;
      font-weight: 700;
      letter-spacing: -0.01em;
      font-size: var(--hm-title);
      line-height: 1.2;
    }

    .household-modal .hm-label{
      display: block;
      font-weight: 500;
      font-size: var(--hm-label);
      margin: var(--space-2) 0 var(--space-2) 0;
    }

    .household-modal .hm-field{ margin-bottom: var(--space-2); }

    .household-modal .hm-input{
      border-radius: var(--hm-input-radius) !important;
      padding: var(--hm-input-py) var(--hm-input-px) !important;
      font-size: var(--hm-input-fs) !important;
    }

    /* Layout: mobile stacks in correct order */
    .household-modal .hm-layout{
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .household-modal .hm-list{
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    /* Cards */
    .household-modal .hm-card{
      border-radius: var(--hm-card-radius);
      padding: var(--hm-card-pad);
    }

    .household-modal .hm-emoji{
      font-size: var(--hm-emoji);
      line-height: 1;
      margin-bottom: var(--space-2);
    }

    .household-modal .hm-name{
      font-size: var(--hm-name);
      font-weight: 750;
      letter-spacing: -0.01em;
      margin: var(--space-1) 0 var(--space-1) 0;
    }

    .household-modal .hm-id{
      font-size: var(--hm-id);
      opacity: 0.9;
      margin-bottom: var(--space-2);
    }

    .household-modal .hm-note{
      margin-top: var(--space-2);
      font-size: var(--hm-note);
      opacity: 0.75;
    }

    .household-modal .hm-card-actions{
      margin-top: var(--space-2);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    /* Buttons: align with existing modal buttons (flat, no gradients) */
    .household-modal .hm-btn{
      width: 100%;
      border: none;
      border-radius: var(--hm-btn-radius);
      padding: var(--hm-btn-py) var(--hm-btn-px);
      font-size: var(--hm-btn-fs);
      font-weight: 600;
      box-shadow: none;
    }

    .household-modal .hm-btn-primary{ background: var(--accent-green, #10b981); color: #fff; }
    .household-modal .hm-btn-edit{ background: var(--accent-blue, #3b82f6); color: #fff; }
    .household-modal .hm-btn-danger{ background: var(--accent-red, #ef4444); color: #fff; }
    .household-modal .hm-btn-secondary{ background: var(--btn-secondary-bg, rgba(148,163,184,0.18)); color: inherit; }

    /* Bottom actions are always below the list now */
    .household-modal .hm-actions-bottom{
      margin-top: var(--space-4);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    /* Dark mode */
    body.dark-mode .household-modal{
      background: var(--modal-bg-dark, rgba(18,21,34,0.98));
      border: 1px solid rgba(255,255,255,0.08);
    }
    body.dark-mode .household-modal .hm-label{ color: rgba(180,188,210,0.85); }
    body.dark-mode .household-modal .hm-card{
      background: rgba(28,32,49,0.72);
      border: 1px solid rgba(255,255,255,0.08);
    }
    body.dark-mode .household-modal .hm-id{ color: rgba(160,168,190,0.92); }
    body.dark-mode .household-modal .hm-input{
      background: rgba(12,14,22,0.65) !important;
      border: 1px solid rgba(255,255,255,0.10) !important;
      color: #fff !important;
    }

    /* Light mode */
    body:not(.dark-mode) .household-modal{
      background: var(--modal-bg-light, #ffffff);
      border: 1px solid rgba(0,0,0,0.08);
    }
    body:not(.dark-mode) .household-modal .hm-label{ color: #6b7280; }
    body:not(.dark-mode) .household-modal .hm-card{
      background: rgba(241,245,249,0.9);
      border: 1px solid rgba(15,23,42,0.08);
    }
    body:not(.dark-mode) .household-modal .hm-id{ color: #6b7280; }
    body:not(.dark-mode) .household-modal .hm-input{
      background: rgba(243,244,246,0.95) !important;
      border: 1px solid #d1d5db !important;
      color: #111827 !important;
    }

    /* Desktop: true 2-column + actions row */
    @media (min-width: 900px){
      .modal-content.household-modal,
      .modal-content-large.household-modal{
        width: min(980px, 92vw) !important;
        max-width: 980px !important;
      }

      .household-modal{
        --hm-pad: 18px;
        --hm-btn-fs: 14px;
        --hm-input-fs: 14px;
        --hm-input-py: 9px;
        --hm-btn-py: 9px;
        --hm-card-pad: 14px;
      }

      .household-modal .hm-layout{
        display: grid;
        grid-template-columns: 1.05fr 1fr;
        gap: 20px;
        align-items: start;
      }

      .household-modal .hm-actions-bottom{
        flex-direction: row;
        justify-content: flex-end;
        gap: 10px;
      }
      .household-modal .hm-actions-bottom .hm-btn{
        width: auto;
        min-width: 160px;
      }
    }

    @media (min-width: 1200px){
      .household-modal .hm-list{
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
    }

    /* ==========================================
      Dashboard Accordion () ‚Äì Wallit Style
      ========================================== */
    .wallit-accordion {
      border-radius: 18px;
      border: 1px solid var(--border-light);
      background: var(--bg-primary);
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }
    body.light-mode .wallit-accordion {
      background: #ffffff !important;
      border: 1px solid #e5e7eb !important;
    }
    .wallit-accordion > summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: var(--text-primary);
    }
    body.light-mode .wallit-accordion > summary {
      background: #ffffff !important;
    }
    .wallit-accordion > summary::-webkit-details-marker { display: none; }
    .wallit-accordion__title {
      font-weight: 800;
      font-size: 14px;
      letter-spacing: 0.01em;
    }
    .wallit-accordion__meta {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--text-tertiary);
      font-size: 12px;
      font-weight: 700;
    }
    .wallit-accordion__chev {
      width: 18px;
      height: 18px;
      opacity: 0.9;
      transform: rotate(0deg);
      transition: transform 0.18s ease;
      flex: 0 0 auto;
    }
    .wallit-accordion[open] .wallit-accordion__chev { transform: rotate(180deg); }
    .wallit-accordion__body {
      padding: 14px 16px 16px;
      border-top: 1px solid var(--border-light);
    }
    .wallit-accordion-item {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-light);
      border-radius: 14px;
      padding: 14px;
    }
    body.dark-mode .wallit-accordion-item {
      background: rgba(255,255,255,0.03);
    }


/* Accordion chevron color fix */
.accordion-summary svg,
.accordion-summary .chevron {
 stroke: var(--text-primary, #ffffff);
 fill: none;
}
.light .accordion-summary svg,
.light .accordion-summary .chevron {
 stroke: #000000;
}



/* ‚úÖ v4.1 Accordion final polish (spacing + contrast + chevron color) */
.wallit-accordion{
  border: 1px solid rgba(120, 150, 255, 0.22);
  background: rgba(255,255,255,0.03);
}
.wallit-accordion > summary{
  padding: 16px 18px;
  background: rgba(255,255,255,0.02);
}
.wallit-accordion__meta{ color: rgba(255,255,255,0.70); }
.wallit-accordion__title {
  color: var(--text-primary);
}
body.light-mode .wallit-accordion{ 
  background: #ffffff !important; 
  border: 1px solid #e5e7eb !important;
  box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
}
body.light-mode .wallit-accordion > summary{ 
  background: #ffffff !important;
  border-bottom: 1px solid #e5e7eb;
}
body.light-mode .wallit-accordion[open] > summary {
  border-bottom: 1px solid #e5e7eb;
}
body.light-mode .wallit-accordion:not([open]) > summary {
  border-bottom: none;
}
body.light-mode .wallit-accordion__title {
  color: #111827 !important;
}
body.light-mode .wallit-accordion__meta{ 
  color: #9ca3af !important;
}
body.light-mode .wallit-accordion__body {
  background: #ffffff !important;
  border-top: none !important;
  padding: 16px 18px;
}
body.light-mode .wallit-accordion-item {
  background: #ffffff !important;
  border: none !important;
  padding: 14px;
}

/* Chevron folgt den Icon-Farben: Dark=#fff, Light=#000 */
.wallit-accordion__chev{
  color: #ffffff;
  opacity: 1;
}
body.light-mode .wallit-accordion__chev{
  color: #111827;
}


/* =============================
   Dashboard KPI Typography (unified)
   ============================= */
.kpi-label{
  font-size: 13px;
  line-height: 1.15;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.kpi-sub{
  font-size: 12px;
  line-height: 1.25;
  font-weight: 600;
  opacity: 0.9;
}
.kpi-value{
  font-size: clamp(22px, 2.0vw, 34px);
  line-height: 1.08;
  font-weight: 800;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-variant-numeric: tabular-nums;
  letter-spacing: -0.01em;
}
@media (max-width: 520px){
  .kpi-value{ font-size: 28px; } /* mobile: big but single-line */
}


/* TYPO REVERT & UNIFY (smaller, calmer) */
.month-header h2,
.month-title {
  font-size: 1.25rem !important;
  line-height: 1.4 !important;
  font-weight: 700;
}

/* KPI typography ‚Äì smaller unification */
.kpi-label { font-size: 0.75rem; opacity: .8; }
.kpi-sub   { font-size: 0.75rem; opacity: .7; }
.kpi-value {
  font-size: 1.1rem;
  font-weight: 700;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}


/* Summary emphasis (Gesamt ausgegeben / √úbrig) */
.summary-row{
  padding-top: 18px;
  margin-top: 18px;
}
.summary-row > .flex{
  padding: 6px 0;
}
.summary-row .text-sm{
  font-size: 0.9rem !important;
  letter-spacing: .01em;
}
.summary-row .kpi-value{
  font-size: 1.55rem !important;
  font-weight: 800 !important;
  line-height: 1.15 !important;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
@media (max-width: 640px){
  .summary-row .text-sm{ font-size: 0.85rem !important; }
  .summary-row .kpi-value{ font-size: 1.35rem !important; }
}


/* Month header emphasis (slightly larger, calm) */
.month-header h2,
.month-title{
  font-size: 1.6rem !important;
  line-height: 1.35 !important;
  font-weight: 700 !important;
}
@media (max-width:640px){
  .month-header h2,
  .month-title{
    font-size: 1.35rem !important;
  }
}


/* Month nav title (Februar 2026) ‚Äì slightly bigger, calm */
.month-nav-title{
  font-size: 1.65rem !important;
  line-height: 1.25 !important;
  font-weight: 800 !important;
  letter-spacing: .01em;
}
@media (max-width: 640px){
  .month-nav-title{
    font-size: 1.4rem !important;
  }
}


/* Month view: Ausgaben accordion chevron contrast */
body.dark-mode .wallit-accordion > summary { color: #ffffff !important; }
body.dark-mode .wallit-accordion__chev { color: #ffffff !important; }
body:not(.dark-mode) .wallit-accordion__chev { color: #111827 !important; }


/* Remove inner scrollbar for month expenses accordion */
.month-expenses-accordion,
.month-expenses-accordion * {
  scrollbar-width: none;
}
.month-expenses-accordion::-webkit-scrollbar {
  display: none;
}
.month-expenses-accordion {
  overflow: visible !important;
  /* removed */
}


/* HARD FIX: remove any inner scrolling in expenses accordion */
.expenses-accordion,
.expenses-accordion-content,
.expenses-list,
.month-expenses,
.month-expenses * {
  overflow: visible !important;
  max-height: none !important;
}
.expenses-accordion::-webkit-scrollbar,
.expenses-accordion-content::-webkit-scrollbar,
.expenses-list::-webkit-scrollbar {
  display: none !important;
}


/* ===== Month Ausgaben Accordion: no inner scrollbar + mobile header layout ===== */
.month-ausgaben-list{
  max-height: none !important;
  overflow: visible !important;
}
.month-ausgaben-list::-webkit-scrollbar{ display:none !important; }
.month-ausgaben-list{ scrollbar-width:none; }

@media (max-width: 640px){
  /* Summary: stack meta under title, keep chevron right */
  #monthAusgabenAccordion > summary{
    align-items: flex-start !important;
    gap: 10px !important;
    padding-top: 14px !important;
    padding-bottom: 14px !important;
  }
  #monthAusgabenAccordion > summary .wallit-accordion__title{
    line-height: 1.15 !important;
  }
  #monthAusgabenAccordion > summary .wallit-accordion__meta{
    margin-top: 6px !important;
    white-space: nowrap;
  }
  #monthAusgabenAccordion > summary .flex.items-center.gap-3.min-w-0{
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 4px !important;
  }
}


/* ===== Year Tab Accordions: Card-Look + WHITE Lightmode ===== */
.year-tab details.wallit-accordion{
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-md);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-3);
  border: 1px solid var(--border-light);
  overflow: hidden;
}

/* Body inherits card background */
.year-tab .wallit-accordion__body{
  background-color: transparent;
}

/* üîí Hard guarantee: Lightmode really white */
html:not(.dark) .year-tab details.wallit-accordion,
html:not(.dark) .year-tab details.wallit-accordion > summary,
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__body{
  background-color: #ffffff !important;
}

/* Lightmode text & chevron contrast */
html:not(.dark) .year-tab details.wallit-accordion > summary{
  color: #0f172a;
}
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__chev{
  color: #0f172a;
}


/* === FIX: Accordions in LIGHT mode must be WHITE + keep shadow (global, not depending on .year-tab) === */
body:not(.dark-mode) details.wallit-accordion{
  background:#ffffff !important;
  border:1px solid rgba(15,23,42,.10) !important;
  box-shadow: var(--shadow-md) !important;
}
body:not(.dark-mode) details.wallit-accordion > summary,
body:not(.dark-mode) details.wallit-accordion .accordion-summary{
  background:#ffffff !important;
  color: var(--text-primary) !important;
}
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body{
  background:#ffffff !important;
}

/* Chevron contrast */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__chev,
body:not(.dark-mode) details.wallit-accordion summary svg{
  color: #0f172a !important;
}

/* Remove tinted inner wrappers inside accordion bodies (charts) */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body > div,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-gray-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-slate-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-white{
  background: transparent !important;
}


/* === Darkmode: restore accordion shadow (matches card elevation) === */
body.dark-mode details.wallit-accordion{
  box-shadow: var(--shadow-md) !important;
  border-color: rgba(255,255,255,.10) !important;
}
body.dark-mode details.wallit-accordion > summary{
  /* keep header crisp */
  background: transparent;
}




/* ===== Unified shadows (Cards + Accordions) ‚Äî NO GLOW (tight drop shadow) ===== */
:root{
  --shadow-card: 0 6px 14px rgba(0,0,0,.10);
  --shadow-card-hover: 0 8px 18px rgba(0,0,0,.12);
}
body.dark-mode{
  /* tighter + darker, reduces "halo" on dark backgrounds */
  --shadow-card: 0 8px 16px rgba(0,0,0,.70);
  --shadow-card-hover: 0 10px 18px rgba(0,0,0,.78);
}

/* Apply same elevation to accordions */
details.wallit-accordion{
  box-shadow: var(--shadow-card) !important;
}
details.wallit-accordion:hover{
  box-shadow: var(--shadow-card-hover) !important;
}

/* Keep borders subtle and consistent */
body.dark-mode details.wallit-accordion{
  border-color: rgba(255,255,255,.08) !important;
}

/* Prevent any glow-like effects from filters */
details.wallit-accordion,
.card, .panel-card, .kpi-card, .month-card, .stat-card, .section-card{
  filter: none !important;
}


/* Apply unified shadow to common card surfaces (non-invasive) */
.card, .panel-card, .kpi-card, .month-card, .stat-card, .section-card{
  box-shadow: var(--shadow-card) !important;
}
.card:hover, .panel-card:hover, .kpi-card:hover, .month-card:hover, .stat-card:hover, .section-card:hover{
  box-shadow: var(--shadow-card-hover) !important;
}

/* Dark mode: replace glow with real shadow */
.dark .card,
.dark .section,
.dark [data-card],
.dark .rounded-xl {
  box-shadow: 0 8px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.5) !important;
}

</style>

<style>

.secondary-btn{
 background: #eef2ff;       /* visible on white */
 color:#0f172a;
 border: 1px solid rgba(37,99,235,.25);
 border-radius: var(--radius-md);
 padding: var(--space-3) var(--space-4);
 font-weight: 700;
 box-shadow: var(--shadow-lg);
 min-height: 54px;
}
.secondary-btn:active{
 transform: translateY(1px);
}
body.dark-mode .secondary-btn{
 background: rgba(255,255,255,.14); /* visible on dark */
 color:#ffffff;
 border-color: rgba(255,255,255,.22);
 box-shadow: 0 10px 26px rgba(0,0,0,.45);
}


/* Accordion chevron color fix */
.accordion-summary svg,
.accordion-summary .chevron {
 stroke: var(--text-primary, #ffffff);
 fill: none;
}
.light .accordion-summary svg,
.light .accordion-summary .chevron {
 stroke: #000000;
}


/* TYPO REVERT & UNIFY (smaller, calmer) */
.month-header h2,
.month-title {
  font-size: 1.25rem !important;
  line-height: 1.4 !important;
  font-weight: 700;
}

/* KPI typography ‚Äì smaller unification */
.kpi-label { font-size: 0.75rem; opacity: .8; }
.kpi-sub   { font-size: 0.75rem; opacity: .7; }
.kpi-value {
  font-size: 1.1rem;
  font-weight: 700;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}


/* Summary emphasis (Gesamt ausgegeben / √úbrig) */
.summary-row{
  padding-top: 18px;
  margin-top: 18px;
}
.summary-row > .flex{
  padding: 6px 0;
}
.summary-row .text-sm{
  font-size: 0.9rem !important;
  letter-spacing: .01em;
}
.summary-row .kpi-value{
  font-size: 1.55rem !important;
  font-weight: 800 !important;
  line-height: 1.15 !important;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
@media (max-width: 640px){
  .summary-row .text-sm{ font-size: 0.85rem !important; }
  .summary-row .kpi-value{ font-size: 1.35rem !important; }
}


/* Month header emphasis (slightly larger, calm) */
.month-header h2,
.month-title{
  font-size: 1.6rem !important;
  line-height: 1.35 !important;
  font-weight: 700 !important;
}
@media (max-width:640px){
  .month-header h2,
  .month-title{
    font-size: 1.35rem !important;
  }
}


/* Month nav title (Februar 2026) ‚Äì slightly bigger, calm */
.month-nav-title{
  font-size: 1.65rem !important;
  line-height: 1.25 !important;
  font-weight: 800 !important;
  letter-spacing: .01em;
}
@media (max-width: 640px){
  .month-nav-title{
    font-size: 1.4rem !important;
  }
}


/* Remove inner scrollbar for month expenses accordion */
.month-expenses-accordion,
.month-expenses-accordion * {
  scrollbar-width: none;
}
.month-expenses-accordion::-webkit-scrollbar {
  display: none;
}
.month-expenses-accordion {
  overflow: visible !important;
  /* removed */
}


/* HARD FIX: remove any inner scrolling in expenses accordion */
.expenses-accordion,
.expenses-accordion-content,
.expenses-list,
.month-expenses,
.month-expenses * {
  overflow: visible !important;
  max-height: none !important;
}
.expenses-accordion::-webkit-scrollbar,
.expenses-accordion-content::-webkit-scrollbar,
.expenses-list::-webkit-scrollbar {
  display: none !important;
}


/* ===== Year Tab Accordions: Card-Look + WHITE Lightmode ===== */
.year-tab details.wallit-accordion{
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-md);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-3);
  border: 1px solid var(--border-light);
  overflow: hidden;
}

/* Body inherits card background */
.year-tab .wallit-accordion__body{
  background-color: transparent;
}

/* üîí Hard guarantee: Lightmode really white */
html:not(.dark) .year-tab details.wallit-accordion,
html:not(.dark) .year-tab details.wallit-accordion > summary,
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__body{
  background-color: #ffffff !important;
}

/* Lightmode text & chevron contrast */
html:not(.dark) .year-tab details.wallit-accordion > summary{
  color: #0f172a;
}
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__chev{
  color: #0f172a;
}


/* === FIX: Accordions in LIGHT mode must be WHITE + keep shadow (global, not depending on .year-tab) === */
body:not(.dark-mode) details.wallit-accordion{
  background:#ffffff !important;
  border:1px solid rgba(15,23,42,.10) !important;
  box-shadow: var(--shadow-md) !important;
}
body:not(.dark-mode) details.wallit-accordion > summary,
body:not(.dark-mode) details.wallit-accordion .accordion-summary{
  background:#ffffff !important;
  color: var(--text-primary) !important;
}
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body{
  background:#ffffff !important;
}

/* Chevron contrast */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__chev,
body:not(.dark-mode) details.wallit-accordion summary svg{
  color: #0f172a !important;
}

/* Remove tinted inner wrappers inside accordion bodies (charts) */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body > div,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-gray-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-slate-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-white{
  background: transparent !important;
}


/* === Darkmode: restore accordion shadow (matches card elevation) === */
body.dark-mode details.wallit-accordion{
  box-shadow: var(--shadow-md) !important;
  border-color: rgba(255,255,255,.10) !important;
}
body.dark-mode details.wallit-accordion > summary{
  /* keep header crisp */
  background: transparent;
}


/* ===== Unified shadows (Cards + Accordions) ===== */
:root{
  --shadow-card: 0 6px 18px rgba(0,0,0,.08);
  --shadow-card-hover: 0 10px 26px rgba(0,0,0,.10);
}
body.dark-mode{
  --shadow-card: 0 10px 28px rgba(0,0,0,.55);
  --shadow-card-hover: 0 14px 34px rgba(0,0,0,.62);
}

/* Apply same elevation to accordions */
details.wallit-accordion{
  box-shadow: var(--shadow-card) !important;
}
details.wallit-accordion:hover{
  box-shadow: var(--shadow-card-hover) !important;
}

/* Keep borders subtle and consistent */
body.dark-mode details.wallit-accordion{
  border-color: rgba(255,255,255,.08) !important;
}

/* Ensure we don't accidentally create a glow via spread/colored shadows from older rules */
details.wallit-accordion{
  filter: none !important;
}

/* Apply unified shadow to common card surfaces (non-invasive: only if they already have shadows) */
.card, .panel-card, .kpi-card, .month-card, .stat-card, .section-card{
  box-shadow: var(--shadow-card);
}
.card:hover, .panel-card:hover, .kpi-card:hover, .month-card:hover, .stat-card:hover, .section-card:hover{
  box-shadow: var(--shadow-card-hover);
}


/* Dark mode: replace glow with real shadow */
.dark .card,
.dark .section,
.dark [data-card],
.dark .rounded-xl {
  box-shadow: 0 8px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.5) !important;
}

</style>


<style>
/* === Receipt scanner modal button contrast fix === */
/* === Receipt scanner state pill === */
#receiptScannerModal .rs-modal-header{
 display:flex;
 align-items:center;
 justify-content:space-between;
 gap: var(--space-3);
}
#receiptScannerModal .rs-pill{
 display:inline-flex;
 align-items:center;
 gap: var(--space-2);
 padding: var(--space-2) var(--space-2);
 border-radius:999px;
 font-size:12px;
 font-weight:800;
 letter-spacing:.2px;
 user-select:none;
 white-space:nowrap;
 border:1px solid rgba(2,6,23,.12);
 background: rgba(2,6,23,.04);
 color:#0f172a;
}
body.dark-mode #receiptScannerModal .rs-pill{
 border-color: rgba(255,255,255,.16);
 background: rgba(255,255,255,.10);
 color:#fff;
}
#receiptScannerModal .rs-pill.rs-pill-camera{
 border-color: rgba(59,130,246,.28);
 background: rgba(59,130,246,.12);
}
#receiptScannerModal .rs-pill.rs-pill-captured{
 border-color: rgba(100,116,139,.28);
 background: rgba(100,116,139,.10);
}
#receiptScannerModal .rs-pill.rs-pill-ocr{
 border-color: rgba(245,158,11,.35);
 background: rgba(245,158,11,.14);
}
#receiptScannerModal .rs-pill.rs-pill-done{
 border-color: rgba(34,197,94,.32);
 background: rgba(34,197,94,.12);
}
#receiptScannerModal .rs-pill.rs-pill-error{
 border-color: rgba(239,68,68,.32);
 background: rgba(239,68,68,.12);
}

/* Spinner (only shown in OCR state) */
#receiptScannerModal .rs-spinner{
 width:14px;
 height:14px;
 border-radius:50%;
 border:2px solid currentColor;
 border-right-color: transparent;
 display:inline-block;
 animation: rsSpin .75s linear infinite;
 opacity:.95;
}
@keyframes rsSpin{ to { transform: rotate(360deg);} }

#receiptScannerModal .btn-primary{
 background: linear-gradient(90deg, rgba(123,97,255,1), rgba(142,110,255,1));
 color: #fff !important;
 border: none;
}
#receiptScannerModal 
.secondary-btn{
 background: #eef2ff;       /* visible on white */
 color:#0f172a;
 border: 1px solid rgba(37,99,235,.25);
 border-radius: 14px;
 padding: 14px 16px;
 font-weight: 700;
 box-shadow: 0 10px 24px rgba(0, 0, 0, .10);
 min-height: 54px;
}
.secondary-btn:active{
 transform: translateY(1px);
}
body.dark-mode .secondary-btn{
 background: rgba(255,255,255,.14); /* visible on dark */
 color:#ffffff;
 border-color: rgba(255,255,255,.22);
 box-shadow: 0 10px 26px rgba(0,0,0,.45);
}

#receiptScannerModal .secondary-btn:active{
 transform: translateY(1px);
}
body.dark-mode #receiptScannerModal 
.secondary-btn{
 background: #eef2ff;       /* visible on white */
 color:#0f172a;
 border: 1px solid rgba(37,99,235,.25);
 border-radius: 14px;
 padding: 14px 16px;
 font-weight: 700;
 box-shadow: 0 10px 24px rgba(0, 0, 0, .10);
 min-height: 54px;
}
.secondary-btn:active{
 transform: translateY(1px);
}
body.dark-mode .secondary-btn{
 background: rgba(255,255,255,.14); /* visible on dark */
 color:#ffffff;
 border-color: rgba(255,255,255,.22);
 box-shadow: 0 10px 26px rgba(0,0,0,.45);
}

#receiptScannerModal button{
 min-height: 52px;
 font-size: 18px;
}

/* Accordion chevron color fix */
.accordion-summary svg,
.accordion-summary .chevron {
 stroke: var(--text-primary, #ffffff);
 fill: none;
}
.light .accordion-summary svg,
.light .accordion-summary .chevron {
 stroke: #000000;
}


/* TYPO REVERT & UNIFY (smaller, calmer) */
.month-header h2,
.month-title {
  font-size: 1.25rem !important;
  line-height: 1.4 !important;
  font-weight: 700;
}

/* KPI typography ‚Äì smaller unification */
.kpi-label { font-size: 0.75rem; opacity: .8; }
.kpi-sub   { font-size: 0.75rem; opacity: .7; }
.kpi-value {
  font-size: 1.1rem;
  font-weight: 700;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}


/* Summary emphasis (Gesamt ausgegeben / √úbrig) */
.summary-row{
  padding-top: 18px;
  margin-top: 18px;
}
.summary-row > .flex{
  padding: 6px 0;
}
.summary-row .text-sm{
  font-size: 0.9rem !important;
  letter-spacing: .01em;
}
.summary-row .kpi-value{
  font-size: 1.55rem !important;
  font-weight: 800 !important;
  line-height: 1.15 !important;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
@media (max-width: 640px){
  .summary-row .text-sm{ font-size: 0.85rem !important; }
  .summary-row .kpi-value{ font-size: 1.35rem !important; }
}


/* Month header emphasis (slightly larger, calm) */
.month-header h2,
.month-title{
  font-size: 1.6rem !important;
  line-height: 1.35 !important;
  font-weight: 700 !important;
}
@media (max-width:640px){
  .month-header h2,
  .month-title{
    font-size: 1.35rem !important;
  }
}


/* Month nav title (Februar 2026) ‚Äì slightly bigger, calm */
.month-nav-title{
  font-size: 1.65rem !important;
  line-height: 1.25 !important;
  font-weight: 800 !important;
  letter-spacing: .01em;
}
@media (max-width: 640px){
  .month-nav-title{
    font-size: 1.4rem !important;
  }
}


/* Remove inner scrollbar for month expenses accordion */
.month-expenses-accordion,
.month-expenses-accordion * {
  scrollbar-width: none;
}
.month-expenses-accordion::-webkit-scrollbar {
  display: none;
}
.month-expenses-accordion {
  overflow: visible !important;
  /* removed */
}


/* HARD FIX: remove any inner scrolling in expenses accordion */
.expenses-accordion,
.expenses-accordion-content,
.expenses-list,
.month-expenses,
.month-expenses * {
  overflow: visible !important;
  max-height: none !important;
}
.expenses-accordion::-webkit-scrollbar,
.expenses-accordion-content::-webkit-scrollbar,
.expenses-list::-webkit-scrollbar {
  display: none !important;
}


/* ===== Year Tab Accordions: Card-Look + WHITE Lightmode ===== */
.year-tab details.wallit-accordion{
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-md);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-3);
  border: 1px solid var(--border-light);
  overflow: hidden;
}

/* Body inherits card background */
.year-tab .wallit-accordion__body{
  background-color: transparent;
}

/* üîí Hard guarantee: Lightmode really white */
html:not(.dark) .year-tab details.wallit-accordion,
html:not(.dark) .year-tab details.wallit-accordion > summary,
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__body{
  background-color: #ffffff !important;
}

/* Lightmode text & chevron contrast */
html:not(.dark) .year-tab details.wallit-accordion > summary{
  color: #0f172a;
}
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__chev{
  color: #0f172a;
}


/* === FIX: Accordions in LIGHT mode must be WHITE + keep shadow (global, not depending on .year-tab) === */
body:not(.dark-mode) details.wallit-accordion{
  background:#ffffff !important;
  border:1px solid rgba(15,23,42,.10) !important;
  box-shadow: var(--shadow-md) !important;
}
body:not(.dark-mode) details.wallit-accordion > summary,
body:not(.dark-mode) details.wallit-accordion .accordion-summary{
  background:#ffffff !important;
  color: var(--text-primary) !important;
}
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body{
  background:#ffffff !important;
}

/* Chevron contrast */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__chev,
body:not(.dark-mode) details.wallit-accordion summary svg{
  color: #0f172a !important;
}

/* Remove tinted inner wrappers inside accordion bodies (charts) */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body > div,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-gray-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-slate-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-white{
  background: transparent !important;
}


/* === Darkmode: restore accordion shadow (matches card elevation) === */
body.dark-mode details.wallit-accordion{
  box-shadow: var(--shadow-md) !important;
  border-color: rgba(255,255,255,.10) !important;
}
body.dark-mode details.wallit-accordion > summary{
  /* keep header crisp */
  background: transparent;
}


/* ===== Unified shadows (Cards + Accordions) ===== */
:root{
  --shadow-card: 0 6px 18px rgba(0,0,0,.08);
  --shadow-card-hover: 0 10px 26px rgba(0,0,0,.10);
}
body.dark-mode{
  --shadow-card: 0 10px 28px rgba(0,0,0,.55);
  --shadow-card-hover: 0 14px 34px rgba(0,0,0,.62);
}

/* Apply same elevation to accordions */
details.wallit-accordion{
  box-shadow: var(--shadow-card) !important;
}
details.wallit-accordion:hover{
  box-shadow: var(--shadow-card-hover) !important;
}

/* Keep borders subtle and consistent */
body.dark-mode details.wallit-accordion{
  border-color: rgba(255,255,255,.08) !important;
}

/* Ensure we don't accidentally create a glow via spread/colored shadows from older rules */
details.wallit-accordion{
  filter: none !important;
}

/* Apply unified shadow to common card surfaces (non-invasive: only if they already have shadows) */
.card, .panel-card, .kpi-card, .month-card, .stat-card, .section-card{
  box-shadow: var(--shadow-card);
}
.card:hover, .panel-card:hover, .kpi-card:hover, .month-card:hover, .stat-card:hover, .section-card:hover{
  box-shadow: var(--shadow-card-hover);
}


/* Dark mode: replace glow with real shadow */
.dark .card,
.dark .section,
.dark [data-card],
.dark .rounded-xl {
  box-shadow: 0 8px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.5) !important;
}

</style>

<style>

/* Ensure buttons that are hidden don't reserve space on some WebKit edge cases */
button[style*="display:none"]{ display:none !important; }


/* Accordion chevron color fix */
.accordion-summary svg,
.accordion-summary .chevron {
 stroke: var(--text-primary, #ffffff);
 fill: none;
}
.light .accordion-summary svg,
.light .accordion-summary .chevron {
 stroke: #000000;
}


/* TYPO REVERT & UNIFY (smaller, calmer) */
.month-header h2,
.month-title {
  font-size: 1.25rem !important;
  line-height: 1.4 !important;
  font-weight: 700;
}

/* KPI typography ‚Äì smaller unification */
.kpi-label { font-size: 0.75rem; opacity: .8; }
.kpi-sub   { font-size: 0.75rem; opacity: .7; }
.kpi-value {
  font-size: 1.1rem;
  font-weight: 700;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}


/* Summary emphasis (Gesamt ausgegeben / √úbrig) */
.summary-row{
  padding-top: 18px;
  margin-top: 18px;
}
.summary-row > .flex{
  padding: 6px 0;
}
.summary-row .text-sm{
  font-size: 0.9rem !important;
  letter-spacing: .01em;
}
.summary-row .kpi-value{
  font-size: 1.55rem !important;
  font-weight: 800 !important;
  line-height: 1.15 !important;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
@media (max-width: 640px){
  .summary-row .text-sm{ font-size: 0.85rem !important; }
  .summary-row .kpi-value{ font-size: 1.35rem !important; }
}


/* Month header emphasis (slightly larger, calm) */
.month-header h2,
.month-title{
  font-size: 1.6rem !important;
  line-height: 1.35 !important;
  font-weight: 700 !important;
}
@media (max-width:640px){
  .month-header h2,
  .month-title{
    font-size: 1.35rem !important;
  }
}


/* Month nav title (Februar 2026) ‚Äì slightly bigger, calm */
.month-nav-title{
  font-size: 1.65rem !important;
  line-height: 1.25 !important;
  font-weight: 800 !important;
  letter-spacing: .01em;
}
@media (max-width: 640px){
  .month-nav-title{
    font-size: 1.4rem !important;
  }
}


/* Remove inner scrollbar for month expenses accordion */
.month-expenses-accordion,
.month-expenses-accordion * {
  scrollbar-width: none;
}
.month-expenses-accordion::-webkit-scrollbar {
  display: none;
}
.month-expenses-accordion {
  overflow: visible !important;
  /* removed */
}


/* HARD FIX: remove any inner scrolling in expenses accordion */
.expenses-accordion,
.expenses-accordion-content,
.expenses-list,
.month-expenses,
.month-expenses * {
  overflow: visible !important;
  max-height: none !important;
}
.expenses-accordion::-webkit-scrollbar,
.expenses-accordion-content::-webkit-scrollbar,
.expenses-list::-webkit-scrollbar {
  display: none !important;
}


/* ===== Year Tab Accordions: Card-Look + WHITE Lightmode ===== */
.year-tab details.wallit-accordion{
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-md);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-3);
  border: 1px solid var(--border-light);
  overflow: hidden;
}

/* Body inherits card background */
.year-tab .wallit-accordion__body{
  background-color: transparent;
}

/* üîí Hard guarantee: Lightmode really white */
html:not(.dark) .year-tab details.wallit-accordion,
html:not(.dark) .year-tab details.wallit-accordion > summary,
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__body{
  background-color: #ffffff !important;
}

/* Lightmode text & chevron contrast */
html:not(.dark) .year-tab details.wallit-accordion > summary{
  color: #0f172a;
}
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__chev{
  color: #0f172a;
}


/* === FIX: Accordions in LIGHT mode must be WHITE + keep shadow (global, not depending on .year-tab) === */
body:not(.dark-mode) details.wallit-accordion{
  background:#ffffff !important;
  border:1px solid rgba(15,23,42,.10) !important;
  box-shadow: var(--shadow-md) !important;
}
body:not(.dark-mode) details.wallit-accordion > summary,
body:not(.dark-mode) details.wallit-accordion .accordion-summary{
  background:#ffffff !important;
  color: var(--text-primary) !important;
}
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body{
  background:#ffffff !important;
}

/* Chevron contrast */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__chev,
body:not(.dark-mode) details.wallit-accordion summary svg{
  color: #0f172a !important;
}

/* Remove tinted inner wrappers inside accordion bodies (charts) */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body > div,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-gray-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-slate-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-white{
  background: transparent !important;
}


/* === Darkmode: restore accordion shadow (matches card elevation) === */
body.dark-mode details.wallit-accordion{
  box-shadow: var(--shadow-md) !important;
  border-color: rgba(255,255,255,.10) !important;
}
body.dark-mode details.wallit-accordion > summary{
  /* keep header crisp */
  background: transparent;
}


/* ===== Unified shadows (Cards + Accordions) ===== */
:root{
  --shadow-card: 0 6px 18px rgba(0,0,0,.08);
  --shadow-card-hover: 0 10px 26px rgba(0,0,0,.10);
}
body.dark-mode{
  --shadow-card: 0 10px 28px rgba(0,0,0,.55);
  --shadow-card-hover: 0 14px 34px rgba(0,0,0,.62);
}

/* Apply same elevation to accordions */
details.wallit-accordion{
  box-shadow: var(--shadow-card) !important;
}
details.wallit-accordion:hover{
  box-shadow: var(--shadow-card-hover) !important;
}

/* Keep borders subtle and consistent */
body.dark-mode details.wallit-accordion{
  border-color: rgba(255,255,255,.08) !important;
}

/* Ensure we don't accidentally create a glow via spread/colored shadows from older rules */
details.wallit-accordion{
  filter: none !important;
}

/* Apply unified shadow to common card surfaces (non-invasive: only if they already have shadows) */
.card, .panel-card, .kpi-card, .month-card, .stat-card, .section-card{
  box-shadow: var(--shadow-card);
}
.card:hover, .panel-card:hover, .kpi-card:hover, .month-card:hover, .stat-card:hover, .section-card:hover{
  box-shadow: var(--shadow-card-hover);
}


/* Dark mode: replace glow with real shadow */
.dark .card,
.dark .section,
.dark [data-card],
.dark .rounded-xl {
  box-shadow: 0 8px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.5) !important;
}

</style>

<style>
/* ‚úÖ iPhone Fix: Kredit bearbeiten ‚Äì Startdatum (type=date) darf nicht aus Modal laufen */
.modal-content .grid { width: 100%; }
.modal-content .grid > div { min-width: 0; } /* wichtig f√ºr iOS + CSS Grid shrink */

.modal-content input[type="date"].modal-input,
#editKreditStart.modal-input{
 width: 100% !important;
 max-width: 100% !important;
 min-width: 0 !important;
 box-sizing: border-box !important;
 -webkit-appearance: none;
 appearance: none;
 display: block;
}

/* iOS Safari: Calendar-Icon/Inner padding kann Layout sprengen ‚Üí clamp */
@supports (-webkit-touch-callout: none){
 .modal-content input[type="date"].modal-input,
 #editKreditStart.modal-input{
  padding-right: 44px !important; /* Platz f√ºr iOS Picker-Icon */
 }
}

/* Accordion chevron color fix */
.accordion-summary svg,
.accordion-summary .chevron {
 stroke: var(--text-primary, #ffffff);
 fill: none;
}
.light .accordion-summary svg,
.light .accordion-summary .chevron {
 stroke: #000000;
}


/* TYPO REVERT & UNIFY (smaller, calmer) */
.month-header h2,
.month-title {
  font-size: 1.25rem !important;
  line-height: 1.4 !important;
  font-weight: 700;
}

/* KPI typography ‚Äì smaller unification */
.kpi-label { font-size: 0.75rem; opacity: .8; }
.kpi-sub   { font-size: 0.75rem; opacity: .7; }
.kpi-value {
  font-size: 1.1rem;
  font-weight: 700;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}


/* Summary emphasis (Gesamt ausgegeben / √úbrig) */
.summary-row{
  padding-top: 18px;
  margin-top: 18px;
}
.summary-row > .flex{
  padding: 6px 0;
}
.summary-row .text-sm{
  font-size: 0.9rem !important;
  letter-spacing: .01em;
}
.summary-row .kpi-value{
  font-size: 1.55rem !important;
  font-weight: 800 !important;
  line-height: 1.15 !important;
  white-space: nowrap;
  font-variant-numeric: tabular-nums;
}
@media (max-width: 640px){
  .summary-row .text-sm{ font-size: 0.85rem !important; }
  .summary-row .kpi-value{ font-size: 1.35rem !important; }
}


/* Month header emphasis (slightly larger, calm) */
.month-header h2,
.month-title{
  font-size: 1.6rem !important;
  line-height: 1.35 !important;
  font-weight: 700 !important;
}
@media (max-width:640px){
  .month-header h2,
  .month-title{
    font-size: 1.35rem !important;
  }
}


/* Month nav title (Februar 2026) ‚Äì slightly bigger, calm */
.month-nav-title{
  font-size: 1.65rem !important;
  line-height: 1.25 !important;
  font-weight: 800 !important;
  letter-spacing: .01em;
}
@media (max-width: 640px){
  .month-nav-title{
    font-size: 1.4rem !important;
  }
}


/* Remove inner scrollbar for month expenses accordion */
.month-expenses-accordion,
.month-expenses-accordion * {
  scrollbar-width: none;
}
.month-expenses-accordion::-webkit-scrollbar {
  display: none;
}
.month-expenses-accordion {
  overflow: visible !important;
  /* removed */
}


/* HARD FIX: remove any inner scrolling in expenses accordion */
.expenses-accordion,
.expenses-accordion-content,
.expenses-list,
.month-expenses,
.month-expenses * {
  overflow: visible !important;
  max-height: none !important;
}
.expenses-accordion::-webkit-scrollbar,
.expenses-accordion-content::-webkit-scrollbar,
.expenses-list::-webkit-scrollbar {
  display: none !important;
}


/* ===== Year Tab Accordions: Card-Look + WHITE Lightmode ===== */
.year-tab details.wallit-accordion{
  background-color: var(--bg-primary);
  box-shadow: var(--shadow-md);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-3);
  border: 1px solid var(--border-light);
  overflow: hidden;
}

/* Body inherits card background */
.year-tab .wallit-accordion__body{
  background-color: transparent;
}

/* üîí Hard guarantee: Lightmode really white */
html:not(.dark) .year-tab details.wallit-accordion,
html:not(.dark) .year-tab details.wallit-accordion > summary,
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__body{
  background-color: #ffffff !important;
}

/* Lightmode text & chevron contrast */
html:not(.dark) .year-tab details.wallit-accordion > summary{
  color: #0f172a;
}
html:not(.dark) .year-tab details.wallit-accordion .wallit-accordion__chev{
  color: #0f172a;
}


/* === FIX: Accordions in LIGHT mode must be WHITE + keep shadow (global, not depending on .year-tab) === */
body:not(.dark-mode) details.wallit-accordion{
  background:#ffffff !important;
  border:1px solid rgba(15,23,42,.10) !important;
  box-shadow: var(--shadow-md) !important;
}
body:not(.dark-mode) details.wallit-accordion > summary,
body:not(.dark-mode) details.wallit-accordion .accordion-summary{
  background:#ffffff !important;
  color: var(--text-primary) !important;
}
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body{
  background:#ffffff !important;
}

/* Chevron contrast */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__chev,
body:not(.dark-mode) details.wallit-accordion summary svg{
  color: #0f172a !important;
}

/* Remove tinted inner wrappers inside accordion bodies (charts) */
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body > div,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-gray-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-slate-50,
body:not(.dark-mode) details.wallit-accordion .wallit-accordion__body .bg-white{
  background: transparent !important;
}


/* === Darkmode: restore accordion shadow (matches card elevation) === */
body.dark-mode details.wallit-accordion{
  box-shadow: var(--shadow-md) !important;
  border-color: rgba(255,255,255,.10) !important;
}
body.dark-mode details.wallit-accordion > summary{
  /* keep header crisp */
  background: transparent;
}


/* ===== Unified shadows (Cards + Accordions) ===== */
:root{
  --shadow-card: 0 6px 18px rgba(0,0,0,.08);
  --shadow-card-hover: 0 10px 26px rgba(0,0,0,.10);
}
body.dark-mode{
  --shadow-card: 0 10px 28px rgba(0,0,0,.55);
  --shadow-card-hover: 0 14px 34px rgba(0,0,0,.62);
}

/* Apply same elevation to accordions */
details.wallit-accordion{
  box-shadow: var(--shadow-card) !important;
}
details.wallit-accordion:hover{
  box-shadow: var(--shadow-card-hover) !important;
}

/* Keep borders subtle and consistent */
body.dark-mode details.wallit-accordion{
  border-color: rgba(255,255,255,.08) !important;
}

/* Ensure we don't accidentally create a glow via spread/colored shadows from older rules */
details.wallit-accordion{
  filter: none !important;
}

/* Apply unified shadow to common card surfaces (non-invasive: only if they already have shadows) */
.card, .panel-card, .kpi-card, .month-card, .stat-card, .section-card{
  box-shadow: var(--shadow-card);
}
.card:hover, .panel-card:hover, .kpi-card:hover, .month-card:hover, .stat-card:hover, .section-card:hover{
  box-shadow: var(--shadow-card-hover);
}


/* Dark mode: replace glow with real shadow */
.dark .card,
.dark .section,
.dark [data-card],
.dark .rounded-xl {
  box-shadow: 0 8px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.5) !important;
}

</style>

</head>
<body>
  <div id="app"></div>

  <script>
    const icons = {
      download: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
      upload: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>',
      plus: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
      trash: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
      calendar: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="20" height="20" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
      trending: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>',
      pie: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>',
      chevronLeft: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>',
      chevronRight: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>',
      chevronDown: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>',
      barChart: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>',
      cloud: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>',
      refresh: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>',
      piggyBank: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4c1-.5 1.7-1 2-2h2v-4h-2c0-1-.5-1.5-1-2h0V5z"></path><path d="M2 9v1c0 1.1.9 2 2 2h1"></path><path d="M16 11h0"></path></svg>',
      arrowUp: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>',
      arrowDown: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>',
      moon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>',
      sun: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>',
      star: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
      bookmark: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>',
      edit: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
      // Neue Icons f√ºr Emojis
      briefcase: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>',
      home: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
      shoppingCart: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>',
      euro: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 10h12"></path><path d="M4 14h9"></path><path d="M19 6a7.7 7.7 0 0 0-5.2-2A7.9 7.9 0 0 0 6 12a7.9 7.9 0 0 0 7.8 8 7.7 7.7 0 0 0 5.2-2"></path></svg>',
      dollar: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
      pound: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 7c0-5.333-8-5.333-8 0"></path><path d="M10 7v10"></path><path d="M6 21h12"></path><path d="M6 13h10"></path></svg>',
      franc: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 2h11"></path><path d="M7 2v20"></path><path d="M7 9h8"></path><path d="M7 14h6"></path></svg>',
      yen: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3l6 8 6-8"></path><path d="M12 11v10"></path><path d="M8 14h8"></path><path d="M8 17h8"></path></svg>',
      eye: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
      repeat: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>',
      fileText: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
      award: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>',
      settings: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>',
      x: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
      check: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',
      alertTriangle: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
      users: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
      user: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
      target: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>',
      lightbulb: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"></path><path d="M10 22h4"></path><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"></path></svg>',
      bank: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="21" x2="21" y2="21"></line><line x1="3" y1="10" x2="21" y2="10"></line><line x1="5" y1="6" x2="19" y2="6"></line><line x1="4" y1="3" x2="20" y2="3"></line><line x1="9" y1="6" x2="9" y2="10"></line><line x1="15" y1="6" x2="15" y2="10"></line><line x1="9" y1="10" x2="9" y2="21"></line><line x1="15" y1="10" x2="15" y2="21"></line><line x1="6" y1="14" x2="6" y2="21"></line><line x1="18" y1="14" x2="18" y2="21"></line></svg>',
      gem: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 22 22 7 12 2"></polygon><polyline points="12 22 12 7"></polyline><polyline points="2 7 12 7 22 7"></polyline><polyline points="7 2 12 7 17 2"></polyline></svg>',
      trendingUp: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>',
      trendingDown: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>',
      pin: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg>',
      package: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4l-9-5.19"></path><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
      creditCard: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>',
      smartphone: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',
      key: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>',
      clipboard: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>',
      waves: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path></svg>',
      zap: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>',
      rocket: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path></svg>',
      bell: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>',
      alert: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
      palette: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>',
      wallet: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path></svg>',
      car: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path><circle cx="7" cy="17" r="2"></circle><path d="M9 17h6"></path><circle cx="17" cy="17" r="2"></circle></svg>',
      building: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><path d="M9 22v-4h6v4"></path><path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path><path d="M12 10h.01"></path><path d="M12 14h.01"></path><path d="M16 10h.01"></path><path d="M16 14h.01"></path><path d="M8 10h.01"></path><path d="M8 14h.01"></path></svg>',
      book: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>',
      dollarSign: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>'
    };


    // ===============================
    // ‚úÖ Security/UX/Perf Helpers (A‚ÄìE)
    // ===============================
    const DATA_VERSION = 2;

    // Escape untrusted strings before injecting into innerHTML / attributes
    function h(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Remove control chars + trim, keep user intent. Stored values become safe-by-default.
    function sanitizeText(value, maxLen = 80) {
      const s = String(value ?? '')
        .replace(/[\u0000-\u001F\u007F]/g, '') // control chars
        .trim()
        .slice(0, maxLen);
      return s;
    }

    // Robust amount parsing for DE locale: "12,34" -> 12.34
    function parseAmount(value) {
      if (typeof value === 'number') return Number.isFinite(value) ? value : 0;
      const s = String(value ?? '').trim();
      if (!s) return 0;
      // allow "1.234,56" or "1,234.56"
      const normalized = s
        .replace(/\s/g, '')
        .replace(/\.(?=\d{3}(\D|$))/g, '') // remove thousands dots
        .replace(/,(?=\d{1,2}(\D|$))/g, '.') // comma decimals
        .replace(/[^0-9.\-]/g, '');
      const n = Number(normalized);
      return Number.isFinite(n) ? n : 0;
    }

    function debounce(fn, wait = 120) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }
    
    // ========================================
    // PERFORMANCE OPTIMIERUNGEN
    // ========================================
    
    // Memoization f√ºr teure Berechnungen
    const memoize = (fn) => {
      const cache = new Map();
      return (...args) => {
        const key = JSON.stringify(args);
        if (cache.has(key)) return cache.get(key);
        const result = fn(...args);
        cache.set(key, result);
        if (cache.size > 100) { // Max 100 Cache-Eintr√§ge
          const firstKey = cache.keys().next().value;
          cache.delete(firstKey);
        }
        return result;
      };
    };
    
    // Throttle f√ºr h√§ufige Events
    const throttle = (func, limit) => {
      let inThrottle;
      return function(...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    };
    
    // Lazy Loading f√ºr Charts mit Intersection Observer
    const lazyRenderChart = (elementId, renderFn) => {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            setTimeout(() => renderFn(), 50); // Slight delay f√ºr smooth rendering
            observer.unobserve(entry.target);
          }
        });
      }, { rootMargin: '50px' }); // Pre-load 50px before visible
      
      const el = document.getElementById(elementId);
      if (el) observer.observe(el);
    };

    class FinanceManagerCloud {
      constructor() {
        dlog('üöÄ Constructor gestartet...');
        
        // üöÄ PERFORMANCE: Cache initialisieren
        this.cache = {
          stats: new Map(),
          charts: new Map(),
          lastUpdate: new Map()
        };
        this.renderQueue = [];
        this.isRendering = false;
        
        // üîÑ REAL-TIME SYNC: Initialisieren
        this.localLastModified = Date.now();
        this.cloudLastModified = null;
        this.syncListener = null;
        this.hasUnsavedChanges = false;
        
        // Teste LocalStorage Verf√ºgbarkeit
        dlog('üì¶ Teste LocalStorage...');
        this.testLocalStorage();
        
        // User-ID aus URL-Parameter oder LocalStorage oder neu generieren
        dlog('üîë Lade User-ID...');
        this.userId = this.getUserIdFromURL() || this.loadData('userId', null) || this.generateUserId();
        this.saveData('userId', this.userId);
        this.updateURLWithUserId();
        dlog('‚úÖ User-ID geladen:', this.userId);
        
        dlog('üìÖ Initialisiere Daten...');
        const now = new Date();
        this.currentMonth = this.loadData('currentMonth', `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`);
        this.currentYear = parseInt(this.currentMonth.split('-')[0]);
        this.fixkosten = this.loadData('fixkosten', [
          { id: 1, name: 'Miete', betrag: 800, kategorie: 'Wohnen' },
          { id: 2, name: 'Strom', betrag: 80, kategorie: 'Wohnen' },
          { id: 3, name: 'Internet', betrag: 40, kategorie: 'Wohnen' }
        ]);
        this.ausgabenAll = this.loadData('ausgabenAll', {});
        this.einkommenAll = this.loadData('einkommenAll', {});
        this.zusatzeinkommenAll = this.loadData('zusatzeinkommenAll', {});
        
        // Neue Datenstrukturen f√ºr Anlagen/Sparkonten
        this.sparkonten = this.loadData('sparkonten', []);
        this.sparraten = this.loadData('sparraten', []);
        this.kontobewegungen = this.loadData('kontobewegungen', {});
        
        // Kredite/Darlehen
        this.kredite = this.loadData('kredite', []);
        
        // Vorlagen f√ºr Ausgaben
        this.ausgabenVorlagen = this.loadData('ausgabenVorlagen', []);
        
        // üë• MULTI-USER: Haushalt-Daten
        this.haushalt = this.loadData('haushalt', {
          name: 'Mein Haushalt',
          erstellt: new Date().toISOString()
        });
        
        this.benutzer = this.loadData('benutzer', {
          'ich': {
            id: 'ich',
            name: 'Ich',
            farbe: '#10b981',
            emoji: 'üë§',
            aktiv: true
          }
        });
        
        this.aktiverBenutzer = this.loadData('aktiverBenutzer', 'ich');
        
        // Standard-Einkommen pro Person (gilt f√ºr alle Monate wenn nicht √ºberschrieben)
        this.standardEinkommen = this.loadData('standardEinkommen', {});
        
        

        // üß± DATA VERSIONING (E): Migrationen & Sanitizing
        this.dataVersion = this.loadData('dataVersion', 1);
        if (this.dataVersion < DATA_VERSION) {
          this.migrateData(this.dataVersion, DATA_VERSION);
          this.dataVersion = DATA_VERSION;
          this.saveData('dataVersion', this.dataVersion);
        }

        // üîÑ Migration f√ºr alte Daten ohne Benutzer-Feld
        this.migrateToMultiUser();
        
        // Dark Mode
        this.darkMode = this.loadData('darkMode', false);
        if (this.darkMode) {
          document.body.classList.add('dark-mode');
        }
        
        this.kategorien = [
          'Auto', 
          'Bildung', 
          'Elektronik',
          'Essen', 
          'Freizeit', 
          'Geschenke',
          'Gesundheit', 
          'Haustiere',
          'Kleidung',
          'Luxus', 
          'Medien',
          'Reisen',
          'Sport',
          'Telekom',
          'Transport', 
          'Versicherungen',
          'Wohnen', 
          'Sonstiges'
        ];
        
        // üí± W√ÑHRUNGS-EINSTELLUNGEN
        this.settings = this.loadData('settings', {
          currency: 'EUR',
          dateFormat: 'de-DE'
        });
        
        this.currencies = {
          EUR: { symbol: '‚Ç¨', name: 'Euro', position: 'after', icon: 'euro' },
          USD: { symbol: '$', name: 'US-Dollar', position: 'before', icon: 'dollar' },
          GBP: { symbol: '¬£', name: 'Britisches Pfund', position: 'before', icon: 'pound' },
          CHF: { symbol: 'CHF', name: 'Schweizer Franken', position: 'after', icon: 'franc' },
          JPY: { symbol: '¬•', name: 'Japanischer Yen', position: 'before', icon: 'yen' },
          CNY: { symbol: '¬•', name: 'Chinesischer Yuan', position: 'before', icon: 'yen' },
          AUD: { symbol: 'A$', name: 'Australischer Dollar', position: 'before', icon: 'dollar' },
          CAD: { symbol: 'C$', name: 'Kanadischer Dollar', position: 'before', icon: 'dollar' }
        };
        
        this.activeTab = 'month';
        this.charts = {};
        this.isSyncing = false;
        this.isProcessingCloudUpdate = false;
        this.isAcceptingCloudUpdate = false;
        this.lastSync = this.loadData('lastSync', null);
        this.initIndexedDB();
        this.setupEventListeners();
        this.initModalObserver();
        
        // üöÄ PERFORMANCE: Debounced render erstellen
        this.debouncedRender = this.debounce(() => {
          dlog('üé® Rendering...');
          this.render();
        }, 150);
        
        this.render();
        
        // üîÑ INITIAL SYNC CHECK: Pr√ºfe ob Cloud-Daten neuer sind
        setTimeout(() => this.checkForCloudUpdates(), 1000);
      }

      // üöÄ PERFORMANCE HELPER FUNKTIONEN
      
      // Debounce f√ºr Input-Events
      debounce(func, wait) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }
      
      // Throttle f√ºr Scroll/Resize
      throttle(func, limit) {
        let inThrottle;
        return (...args) => {
          if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
          }
        };
      }

// üß± DATA MIGRATION (E): Sanitizing + Normalisierung f√ºr alte Datenst√§nde
migrateData(fromVersion, toVersion) {
  try {
    console.warn(`‚ö†Ô∏è Migriere Daten von v${fromVersion} ‚Üí v${toVersion}...`);

    // Helper: Array mit Objects sanitizen
    const sanitizeArray = (arr, fieldMaxLen = 80) => {
      if (!Array.isArray(arr)) return [];
      return arr.map(item => {
        if (!item || typeof item !== 'object') return item;
        const out = { ...item };
        if (typeof out.name !== 'undefined') out.name = sanitizeText(out.name, fieldMaxLen);
        if (typeof out.kategorie !== 'undefined') out.kategorie = sanitizeText(out.kategorie, fieldMaxLen);
        if (typeof out.benutzer !== 'undefined') out.benutzer = sanitizeText(out.benutzer, 32);
        if (typeof out.typ !== 'undefined') out.typ = sanitizeText(out.typ, 16);
        if (typeof out.notiz !== 'undefined') out.notiz = sanitizeText(out.notiz, 200);
        if (typeof out.betrag !== 'undefined') out.betrag = parseAmount(out.betrag);
        if (typeof out.betragMonat !== 'undefined') out.betragMonat = parseAmount(out.betragMonat);
        if (typeof out.betragStart !== 'undefined') out.betragStart = parseAmount(out.betragStart);
        if (typeof out.rate !== 'undefined') out.rate = parseAmount(out.rate);
        if (typeof out.ziel !== 'undefined') out.ziel = parseAmount(out.ziel);
        return out;
      });
    };

    const sanitizeMonthMap = (obj) => {
      if (!obj || typeof obj !== 'object') return {};
      const out = {};
      Object.keys(obj).forEach(monthKey => {
        out[monthKey] = sanitizeArray(obj[monthKey], 80);
      });
      return out;
    };

    // v1 -> v2: Eingaben normalisieren & gef√§hrliche Zeichen raus
    if (fromVersion < 2) {
      // Core Daten
      this.fixkosten = sanitizeArray(this.fixkosten, 80);
      this.ausgabenAll = sanitizeMonthMap(this.ausgabenAll);
      this.einkommenAll = sanitizeMonthMap(this.einkommenAll);
      this.zusatzeinkommenAll = sanitizeMonthMap(this.zusatzeinkommenAll);
      this.ausgabenVorlagen = sanitizeArray(this.ausgabenVorlagen, 80);

      // Multi-User & Settings
      if (this.haushalt && typeof this.haushalt === 'object') {
        this.haushalt = { ...this.haushalt, name: sanitizeText(this.haushalt.name, 80) };
      }
      if (this.benutzer && typeof this.benutzer === 'object') {
        const bOut = {};
        Object.keys(this.benutzer).forEach(k => {
          const u = this.benutzer[k] || {};
          bOut[k] = {
            ...u,
            id: sanitizeText(u.id || k, 32),
            name: sanitizeText(u.name || 'User', 32),
            emoji: sanitizeText(u.emoji || 'üë§', 8),
            farbe: u.farbe || '#10b981',
            aktiv: !!u.aktiv
          };
        });
        this.benutzer = bOut;
      }
      this.aktiverBenutzer = sanitizeText(this.aktiverBenutzer || 'ich', 32);

      if (this.standardEinkommen && typeof this.standardEinkommen === 'object') {
        const seOut = {};
        Object.keys(this.standardEinkommen).forEach(k => {
          seOut[k] = parseAmount(this.standardEinkommen[k]);
        });
        this.standardEinkommen = seOut;
      }

      // Sparkonten / Anlagen
      this.sparkonten = sanitizeArray(this.sparkonten, 80);
      this.sparraten = sanitizeArray(this.sparraten, 80);
      if (this.kontobewegungen && typeof this.kontobewegungen === 'object') {
        const kbOut = {};
        Object.keys(this.kontobewegungen).forEach(k => {
          kbOut[k] = sanitizeArray(this.kontobewegungen[k], 120);
        });
        this.kontobewegungen = kbOut;
      }
    }

    // Persistiere migrierte Daten
    this.saveData('fixkosten', this.fixkosten);
    this.saveData('ausgabenAll', this.ausgabenAll);
    this.saveData('einkommenAll', this.einkommenAll);
    this.saveData('zusatzeinkommenAll', this.zusatzeinkommenAll);
    this.saveData('ausgabenVorlagen', this.ausgabenVorlagen);
    this.saveData('haushalt', this.haushalt);
    this.saveData('benutzer', this.benutzer);
    this.saveData('aktiverBenutzer', this.aktiverBenutzer);
    this.saveData('standardEinkommen', this.standardEinkommen);
    this.saveData('sparkonten', this.sparkonten);
    this.saveData('sparraten', this.sparraten);
    this.saveData('kontobewegungen', this.kontobewegungen);

    dlog('‚úÖ Datenmigration abgeschlossen');
  } catch (e) {
    console.error('‚ùå Datenmigration fehlgeschlagen:', e);
  }
}

      
      // Cache Getter mit TTL
      getCached(cacheType, key, ttl = 60000) {
        const cache = this.cache[cacheType];
        if (!cache || !cache.has(key)) return null;
        
        const lastUpdate = this.cache.lastUpdate.get(key);
        if (lastUpdate && (Date.now() - lastUpdate) > ttl) {
          cache.delete(key);
          this.cache.lastUpdate.delete(key);
          return null;
        }
        
        return cache.get(key);
      }
      
      // Cache Setter
      setCached(cacheType, key, value) {
        const cache = this.cache[cacheType];
        if (cache) {
          cache.set(key, value);
          this.cache.lastUpdate.set(key, Date.now());
        }
      }
      
      // Cache invalidieren
      invalidateCache(pattern = null) {
        if (pattern) {
          // Nur bestimmte Keys l√∂schen
          ['stats', 'charts'].forEach(cacheType => {
            const cache = this.cache[cacheType];
            if (cache) {
              cache.forEach((_, key) => {
                if (key.includes(pattern)) {
                  cache.delete(key);
                  this.cache.lastUpdate.delete(key);
                }
              });
            }
          });
        } else {
          // Alles l√∂schen
          this.cache.stats.clear();
          this.cache.charts.clear();
          this.cache.lastUpdate.clear();
        }
      }
      
      // Batch Rendering
      queueRender(renderFn) {
        this.renderQueue.push(renderFn);
        if (!this.isRendering) {
          this.processRenderQueue();
        }
      }
      
      processRenderQueue() {
        if (this.renderQueue.length === 0) {
          this.isRendering = false;
          return;
        }
        
        this.isRendering = true;
        requestAnimationFrame(async () => {
          const batch = this.renderQueue.splice(0, 10); // 10 pro Frame
          batch.forEach(fn => {
            try {
              fn();
            } catch (error) {
              console.error('Render error:', error);
            }
          });
          this.processRenderQueue();
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              // Added
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
              // Removed (Cleanup von Keydown-Listenern/Fokus)
              for (const node of m.removedNodes) {
                if (node && node._cleanupA11y) {
                  try { node._cleanupA11y(); } catch {}
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      // üí± W√ÑHRUNGS-HELPER-FUNKTIONEN
      
      formatCurrency(amount) {
        const curr = this.currencies[this.settings.currency];
        const nbsp = ' ';
        if (!curr) {
          const formatted = new Intl.NumberFormat('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(amount);
          return formatted + nbsp + '‚Ç¨';
        }

        const formatted = new Intl.NumberFormat('de-DE', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);

        if (curr.position === 'before') {
          return curr.symbol + nbsp + formatted;
        } else {
          return formatted + nbsp + curr.symbol;
        }
      }
      
      formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
      }
      
      getCurrentCurrencyIcon() {
        const curr = this.currencies[this.settings.currency];
        return curr ? icons[curr.icon] : icons.euro;
      }
      
      changeCurrency(newCurrency) {
        if (!this.currencies[newCurrency]) return;
        
        this.settings.currency = newCurrency;
        this.saveData('settings', this.settings);
        this.invalidateCache(); // Cache leeren
        this.render();
        this.showNotification(`W√§hrung ge√§ndert zu ${this.currencies[newCurrency].name}`, 'success');
      }

      setupEventListeners() {
        // Event Delegation f√ºr Einkommen-Speichern Buttons
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('einkommen-save-btn')) {
            const userId = e.target.getAttribute('data-user-id');
            dlog('Einkommen-Button geklickt:', userId);
            this.saveUserEinkommen(userId);
          }
        });
        dlog('‚úÖ Event Listeners eingerichtet');
      }

      getUserIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('userId');
        if (userId) {
          dlog('‚úÖ User-ID aus URL geladen:', userId);
        }
        return userId;
      }

      updateURLWithUserId() {
        const url = new URL(window.location);
        url.searchParams.set('userId', this.userId);
        window.history.replaceState({}, '', url);
        dlog('‚úÖ URL aktualisiert mit User-ID');
      }

      testLocalStorage() {
        try {
          const testKey = '__storage_test__';
          localStorage.setItem(testKey, 'test');
          const testValue = localStorage.getItem(testKey);
          localStorage.removeItem(testKey);
          
          if (testValue !== 'test') {
            throw new Error('LocalStorage funktioniert nicht korrekt');
          }
          
          dlog('‚úÖ LocalStorage funktioniert');
          this.localStorageWorks = true;
        } catch (error) {
          console.error('‚ùå LocalStorage blockiert:', error);
          this.localStorageWorks = false;
          
          setTimeout(() => {
            if (!this.getUserIdFromURL()) {
              this.showModal(
                '‚ö†Ô∏è WICHTIG: Safari blockiert die Datenspeicherung!',
                'L√ñSUNG:\n' +
                '1. Setze ein LESEZEICHEN f√ºr diese Seite\n' +
                '2. Die User-ID bleibt in der URL gespeichert\n' +
                '3. Nutze immer das Lesezeichen zum √ñffnen\n\n' +
                'Oder: Safari ‚Üí Einstellungen ‚Üí Datenschutz\n' +
                '‚Üí "Alle Website-Daten blockieren" DEAKTIVIEREN',
                [{ text: 'Verstanden', class: 'bg-orange-500 hover:bg-orange-600 text-white' }]
              );
            }
          }, 1000);
        }
      }

      generateUserId() {
        // üîê Crypto-starke ID (keine erratbaren Zeitstempel/Math.random)
        const bytes = new Uint8Array(16);
        crypto.getRandomValues(bytes);
        const hex = Array.from(bytes, b => b.toString(16).padStart(2, '0')).join('');
        const id = 'u_' + hex;
        this.saveData('userId', id);
        return id;
      }

      async initIndexedDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open('FinanceManagerDB', 2);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.db = request.result;
            this.loadFromIndexedDB();
            resolve();
          };
          
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('finances')) {
              db.createObjectStore('finances', { keyPath: 'key' });
            }
          };
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      async loadFromIndexedDB() {
        if (!this.db) return;
        
        const tx = this.db.transaction(['finances'], 'readonly');
        const store = tx.objectStore('finances');
        const request = store.getAll();
        
        request.onsuccess = () => {
          const data = request.result;
          data.forEach(item => {
            if (item.key === 'fixkosten') this.fixkosten = item.value;
            if (item.key === 'ausgabenAll') this.ausgabenAll = item.value;
            if (item.key === 'einkommenAll') this.einkommenAll = item.value;
            if (item.key === 'zusatzeinkommenAll') this.zusatzeinkommenAll = item.value;
            if (item.key === 'sparkonten') this.sparkonten = item.value;
            if (item.key === 'sparraten') this.sparraten = item.value;
            if (item.key === 'kontobewegungen') this.kontobewegungen = item.value;
          });
          this.render();
        };
      }

      async saveToIndexedDB(key, value) {
        if (!this.db) return;
        
        const tx = this.db.transaction(['finances'], 'readwrite');
        const store = tx.objectStore('finances');
        await store.put({ key, value });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      loadData(key, defaultValue) {
        try {
          const stored = localStorage.getItem(key);
          if (stored) {
            dlog(`‚úÖ ${key} aus LocalStorage geladen`);
            return JSON.parse(stored);
          }
        } catch (error) {
          console.error(`‚ùå Fehler beim Laden von ${key}:`, error);
        }
        dlog(`‚ö†Ô∏è ${key} nicht gefunden, verwende Standardwert`);
        return defaultValue;
      }

      saveData(key, value) {
        try {
          // PERF: batch persistence (localStorage + IndexedDB) to avoid repeated JSON.stringify on rapid updates
          this._persistQueue = this._persistQueue || new Map();
          this._persistQueue.set(key, value);

          if (!this._persistTimer) {
            this._persistTimer = setTimeout(() => {
              const flush = () => {
                try {
                  for (const [k, v] of this._persistQueue.entries()) {
                    localStorage.setItem(k, JSON.stringify(v));
                    this.saveToIndexedDB(k, v);
                  }
                } catch (e) {
                  console.error('‚ùå Persist-Flush fehlgeschlagen:', e);
                } finally {
                  this._persistQueue.clear();
                  this._persistTimer = null;
                }
              };
              if (window.requestIdleCallback) {
                requestIdleCallback(flush, { timeout: 800 });
              } else {
                setTimeout(flush, 0);
              }
            }, 120);
          }

          dlog(`‚úÖ ${key} gespeichert (queued)`);

          // üöÄ PERFORMANCE: Cache invalidieren wenn Daten sich √§ndern
          if (key === 'ausgabenAll' || key === 'einkommenAll' || key === 'fixkosten' || key === 'zusatzeinkommenAll' || key === 'kredite') {
            this.invalidateCache();
          }
          
          // üîÑ REAL-TIME SYNC: Markiere als ge√§ndert (au√üer Metadaten und UI-Einstellungen)
          // Ausgeschlossen: Metadaten (userId, lastSync, lastModified, dataVersion, currentMonth)
          //         UI-Einstellungen (aktiverBenutzer, darkMode, settings)
          const excludedKeys = ['userId', 'lastSync', 'currentMonth', 'lastModified', 'dataVersion', 'aktiverBenutzer', 'darkMode', 'settings'];
          if (!excludedKeys.includes(key) && !this.isSyncing && !this.isProcessingCloudUpdate && !this.isAcceptingCloudUpdate) {
            this.markAsChanged();
          }
        } catch (error) {
          console.error(`‚ùå Fehler beim Speichern von ${key}:`, error);
          if (key === 'userId') {
            this.showModal(
              '‚ö†Ô∏è WICHTIG: Safari blockiert die Speicherung!',
              'Deine User-ID kann nicht gespeichert werden.\n\n' +
              'L√∂sung:\n' +
              '1. Safari ‚Üí Einstellungen ‚Üí Datenschutz\n' +
              '2. "Alle Website-Daten blockieren" DEAKTIVIEREN\n' +
              '3. Seite neu laden\n\n' +
              'Alternativ: Nutze Chrome/Firefox',
              [{ text: 'Verstanden', class: 'bg-orange-500 hover:bg-orange-600 text-white' }]
            );
          }
        }
      }

      async syncToCloud() {
        if (!window.firebaseReady) {
          this.showModal('‚ùå Firebase nicht verf√ºgbar', 
            'M√∂gliche Gr√ºnde:\n‚Ä¢ Safari blockiert Third-Party-Cookies\n‚Ä¢ Tracking-Schutz ist aktiviert\n‚Ä¢ Firewall/VPN blockiert Firebase\n\nFehler: ' + (window.firebaseError || 'Unbekannt') + '\n\nDeine Daten werden lokal gespeichert und sind sicher.',
            [{ text: 'Verstanden', class: 'bg-orange-500 hover:bg-orange-600 text-white' }]
          );
          return;
        }
        
        if (!window.firebaseDB || this.isSyncing) return;
        
        // Best√§tigungsabfrage mit Modal
        this.showModal('‚òÅÔ∏è Daten in Cloud hochladen?', 
          'Deine lokalen Daten werden in die Cloud hochgeladen.\nVorhandene Cloud-Daten werden √úBERSCHRIEBEN!\n\nM√∂chtest du fortfahren?',
          [
            { text: 'Hochladen', class: 'btn-upload', callback: () => this.performSync() },
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' }
          ]
        );
      }

      
  async performSync() {
    try {
      await this.ensureSecureLogin();
      await this.ensureHousehold();

      const payload = this.exportCloudPayload();
      const r = await window.wallitApi.put("/households/" + encodeURIComponent(this.householdId) + "/data", { data: payload });

      if (!r.ok) throw new Error("Upload failed (" + r.status + ")");
      this.lastSyncAt = Date.now();
      this.updateCloudStatusUI();
      this.showToast("In Cloud gespeichert ‚úÖ", "success");
    } catch (e) {
      console.error("performSync error:", e);
      this.showToast("Cloud Sync fehlgeschlagen", "error");
      this.showModal("Cloud Sync", "Fehler: " + (e && (e.message || e.toString()) || "unknown"), [{ text: "OK", primary: true }]);
    }
  }

  async performLoad() {
    try {
      await this.ensureSecureLogin();
      await this.ensureHousehold();

      const r = await window.wallitApi.get("/households/" + encodeURIComponent(this.householdId) + "/data");
      if (!r.ok) throw new Error("Load failed (" + r.status + ")");

      const incoming = (r.data && r.data.data) ? r.data.data : {};
      this.applyCloudPayload(incoming);

      this.lastSyncAt = Date.now();
      this.updateCloudStatusUI();
      this.saveToLocalStorage();
      this.refreshAllUI();
      this.showToast("Aus Cloud geladen ‚úÖ", "success");
    } catch (e) {
      console.error("performLoad error:", e);
      this.showToast("Cloud Load fehlgeschlagen", "error");
      this.showModal("Cloud Load", "Fehler: " + (e && (e.message || e.toString()) || "unknown"), [{ text: "OK", primary: true }]);
    }
  }

  updateCloudStatusUI() {
    const el = document.querySelector("[data-cloud-status]");
    if (el) {
      const hh = this.householdId ? (String(this.householdId).slice(0, 6) + "‚Ä¶") : "‚Äî";
      const dt = this.lastSyncAt ? new Date(this.lastSyncAt).toLocaleString() : "nie";
      el.textContent = "Cloud: HH " + hh + " ¬∑ Sync: " + dt;
    }
  }

  exportCloudPayload() {
    const nowIso = new Date().toISOString();
    return {
      fixkosten: this.fixkosten || [],
      ausgabenAll: this.ausgabenAll || {},
      einkommenAll: this.einkommenAll || {},
      zusatzeinkommenAll: this.zusatzeinkommenAll || {},
      sparkonten: this.sparkonten || [],
      sparraten: this.sparraten || [],
      kontobewegungen: this.kontobewegungen || {},
      kredite: this.kredite || [],
      ausgabenVorlagen: this.ausgabenVorlagen || [],
      standardEinkommen: this.standardEinkommen || {},
      currentMonth: this.currentMonth || nowIso.slice(0, 7),
      benutzer: this.users || [],
      haushalt: this.householdName || "Mein Haushalt",
      meta: { schemaVersion: 1, clientUpdatedAt: nowIso }
    };
  }

  applyCloudPayload(data) {
    if (!data || typeof data !== "object") return;

    this.fixkosten = Array.isArray(data.fixkosten) ? data.fixkosten : [];
    this.ausgabenAll = (data.ausgabenAll && typeof data.ausgabenAll === "object") ? data.ausgabenAll : {};
    this.einkommenAll = (data.einkommenAll && typeof data.einkommenAll === "object") ? data.einkommenAll : {};
    this.zusatzeinkommenAll = (data.zusatzeinkommenAll && typeof data.zusatzeinkommenAll === "object") ? data.zusatzeinkommenAll : {};
    this.sparkonten = Array.isArray(data.sparkonten) ? data.sparkonten : [];
    this.sparraten = Array.isArray(data.sparraten) ? data.sparraten : [];
    this.kontobewegungen = (data.kontobewegungen && typeof data.kontobewegungen === "object") ? data.kontobewegungen : {};
    this.kredite = Array.isArray(data.kredite) ? data.kredite : [];
    this.ausgabenVorlagen = Array.isArray(data.ausgabenVorlagen) ? data.ausgabenVorlagen : [];
    this.standardEinkommen = (data.standardEinkommen && typeof data.standardEinkommen === "object") ? data.standardEinkommen : {};
    this.currentMonth = (typeof data.currentMonth === "string") ? data.currentMonth : new Date().toISOString().slice(0, 7);

    if (Array.isArray(data.benutzer)) this.users = data.benutzer;
    if (typeof data.haushalt === "string") this.householdName = data.haushalt;
  }

  async ensureSecureLogin() {
    const me = await window.wallitApi.get("/auth/me");
    if (me.ok) return true;

    await this.openLoginModal();
    const me2 = await window.wallitApi.get("/auth/me");
    if (!me2.ok) throw new Error("Nicht eingeloggt (Session fehlt)");
    return true;
  }

  async ensureHousehold() {
    const u = new URL(location.href);
    const urlHH = u.searchParams.get("household");
    if (urlHH) localStorage.setItem("wallit_household_id", urlHH);

    this.householdId = localStorage.getItem("wallit_household_id") || this.householdId || "";

    if (this.householdId) {
      const t = await window.wallitApi.get("/households/" + encodeURIComponent(this.householdId) + "/data");
      if (t.ok) return this.householdId;
      localStorage.removeItem("wallit_household_id");
      this.householdId = "";
    }

    const created = await window.wallitApi.post("/households", { name: "Mein Haushalt" });
    if (!created.ok || !created.data || !created.data.id) throw new Error("Household create failed (" + created.status + ")");

    this.householdId = String(created.data.id);
    localStorage.setItem("wallit_household_id", this.householdId);
    this.updateCloudStatusUI();
    return this.householdId;
  }

  openLoginModal() {
    const self = this;
    return new Promise(function(resolve) {
      const old = document.getElementById("wallit-login-overlay");
      if (old) old.remove();

      const overlay = document.createElement("div");
      overlay.id = "wallit-login-overlay";
      overlay.className = "modal-overlay";
      overlay.style.display = "flex";

      overlay.innerHTML =
        '<div class="modal-content" style="max-width:420px;">' +
          '<div class="modal-header">' +
            '<h3 style="margin:0;">Login</h3>' +
            '<button class="icon-btn" id="wlClose" aria-label="Close">‚úï</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<p style="margin-top:0;">F√ºr die Cloud-Synchronisation musst du dich anmelden.</p>' +
            '<label class="form-label">E‚ÄëMail</label>' +
            '<input id="wlEmail" class="input" type="email" autocomplete="email" placeholder="you@example.com" />' +
            '<div style="height:10px;"></div>' +
            '<label class="form-label">Passwort</label>' +
            '<input id="wlPass" class="input" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />' +
            '<div id="wlErr" style="display:none;margin-top:10px;color:var(--danger,#ef4444);font-size:13px;"></div>' +
          '</div>' +
          '<div class="modal-footer">' +
            '<button class="btn btn-secondary" id="wlCancel">Abbrechen</button>' +
            '<button class="btn btn-primary" id="wlLogin">Einloggen</button>' +
          '</div>' +
        '</div>';

      document.body.appendChild(overlay);

      function close() { overlay.remove(); resolve(); }
      overlay.querySelector("#wlClose").onclick = close;
      overlay.querySelector("#wlCancel").onclick = close;

      overlay.querySelector("#wlLogin").onclick = async function() {
        const email = overlay.querySelector("#wlEmail").value.trim();
        const password = overlay.querySelector("#wlPass").value;
        const err = overlay.querySelector("#wlErr");
        err.style.display = "none";
        if (!email || !password) {
          err.textContent = "Bitte E‚ÄëMail und Passwort eingeben.";
          err.style.display = "block";
          return;
        }
        const r = await window.wallitApi.post("/auth/login", { email: email, password: password });
        if (!r.ok) {
          const msg = (r.data && r.data.error) ? r.data.error : ("Login fehlgeschlagen (" + r.status + ")");
          err.textContent = msg;
          err.style.display = "block";
          return;
        }
        overlay.remove();
        resolve();
      };
    });
  }

  setupRealtimeSync();
            }
          } else {
            // Lokale Daten sind aktuell - aktiviere nur Listener
            this.setupRealtimeSync();
            dlog('‚úÖ Lokale Daten sind aktuell');
          }
          
        } catch (error) {
          console.error('‚ùå Fehler beim Cloud-Check:', error);
        }
      }
      
      compareData(cloudData) {
        // Vergleiche die wichtigsten Datenstrukturen
        try {
          // Erstelle einfache Hashes der Daten
          const localHash = this.createDataHash();
          const cloudHash = this.createCloudDataHash(cloudData);
          
          const isDifferent = localHash !== cloudHash;
          dlog('üîç Datenvergleich:', isDifferent ? 'UNTERSCHIEDLICH' : 'IDENTISCH');
          
          return isDifferent;
        } catch (error) {
          console.error('‚ùå Fehler beim Datenvergleich:', error);
          // Im Fehlerfall: Annahme dass Daten unterschiedlich sind (sicherer)
          return true;
        }
      }
      
      createDataHash() {
  // Performance: KEIN JSON.stringify √ºber gro√üe Objekte (blockiert UI bei onSnapshot)
  // Wir bilden einen "good-enough" Hash aus L√§ngen + einfachen Z√§hlern.
  const countObj = (o) => o ? Object.keys(o).length : 0;
  const countArr = (a) => Array.isArray(a) ? a.length : 0;

  const monthsAusgaben = this.ausgabenAll || {};
  const monthsEinkommen = this.einkommenAll || {};

  let ausgabenItems = 0;
  for (const k in monthsAusgaben) ausgabenItems += countArr(monthsAusgaben[k]);
  let einkommenItems = 0;
  for (const k in monthsEinkommen) einkommenItems += countArr(monthsEinkommen[k]);

  // Arrays: Anzahl + Checksumme f√ºr √Ñnderungserkennung
  const fix = countArr(this.fixkosten);
  const sk = countArr(this.sparkonten);
  const sr = countArr(this.sparraten);
  const kred = countArr(this.kredite);
  
  // Checksummen: ID + Betrag als Fingerprint (erkennt Bearbeitungen)
  let fixSum = 0;
  if (Array.isArray(this.fixkosten)) {
    this.fixkosten.forEach(f => fixSum += (f.id || 0) + Math.round((f.betrag || 0) * 100));
  }
  
  let skSum = 0;
  if (Array.isArray(this.sparkonten)) {
    this.sparkonten.forEach(s => skSum += (s.id || 0) + Math.round((s.betrag || 0) * 100));
  }
  
  let kredSum = 0;
  // String-Hash (leichtgewichtig) ‚Äì damit auch √Ñnderungen an Name/Kategorie/Benutzer erkannt werden
  const strHash = (s) => {
    s = String(s ?? '');
    let h = 0;
    for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
    return h;
  };
  const dateNum = (d) => d ? (parseInt(String(d).replace(/-/g, ''), 10) || 0) : 0;

  if (Array.isArray(this.kredite)) {
    this.kredite.forEach(k => {
      kredSum += (k.id || 0)
        + Math.round((k.betrag || 0) * 100)
        + Math.round((k.rate || 0) * 100)
        + Math.round((k.zinssatz || 0) * 100)
        + (k.laufzeit || 0)
        + Math.round((k.gesamtbetrag || 0) * 100)
        + dateNum(k.startdatum)
        + strHash(k.name)
        + strHash(k.kategorie)
        + strHash(k.benutzer);
    });
  }

  // Shapes/Key-counts als zus√§tzlicher Stabilizer
  const ausKeys = countObj(monthsAusgaben);
  const einKeys = countObj(monthsEinkommen);

  return `v5|fix:${fix}:${fixSum}|sk:${sk}:${skSum}|sr:${sr}|kred:${kred}:${kredSum}|ausM:${ausKeys}|einM:${einKeys}|ausI:${ausgabenItems}|einI:${einkommenItems}`;
}

      
      createCloudDataHash(cloudData) {
  // Performance: analog zu createDataHash ‚Äì keine riesigen Stringify-Operationen.
  const countObj = (o) => o ? Object.keys(o).length : 0;
  const countArr = (a) => Array.isArray(a) ? a.length : 0;

  const monthsAusgaben = (cloudData && cloudData.ausgabenAll) ? cloudData.ausgabenAll : {};
  const monthsEinkommen = (cloudData && cloudData.einkommenAll) ? cloudData.einkommenAll : {};

  let ausgabenItems = 0;
  for (const k in monthsAusgaben) ausgabenItems += countArr(monthsAusgaben[k]);
  let einkommenItems = 0;
  for (const k in monthsEinkommen) einkommenItems += countArr(monthsEinkommen[k]);

  const fix = countArr(cloudData && cloudData.fixkosten);
  const sk = countArr(cloudData && cloudData.sparkonten);
  const sr = countArr(cloudData && cloudData.sparraten);
  const kred = countArr(cloudData && cloudData.kredite);
  
  // Checksummen f√ºr √Ñnderungserkennung
  let fixSum = 0;
  if (cloudData && Array.isArray(cloudData.fixkosten)) {
    cloudData.fixkosten.forEach(f => fixSum += (f.id || 0) + Math.round((f.betrag || 0) * 100));
  }
  
  let skSum = 0;
  if (cloudData && Array.isArray(cloudData.sparkonten)) {
    cloudData.sparkonten.forEach(s => skSum += (s.id || 0) + Math.round((s.betrag || 0) * 100));
  }
  
  let kredSum = 0;
  // String-Hash (leichtgewichtig) ‚Äì damit auch √Ñnderungen an Name/Kategorie/Benutzer erkannt werden
  const strHash = (s) => {
    s = String(s ?? '');
    let h = 0;
    for (let i = 0; i < s.length; i++) h = (h * 31 + s.charCodeAt(i)) >>> 0;
    return h;
  };
  const dateNum = (d) => d ? (parseInt(String(d).replace(/-/g, ''), 10) || 0) : 0;

  if (cloudData && Array.isArray(cloudData.kredite)) {
    cloudData.kredite.forEach(k => {
      kredSum += (k.id || 0)
        + Math.round((k.betrag || 0) * 100)
        + Math.round((k.rate || 0) * 100)
        + Math.round((k.zinssatz || 0) * 100)
        + (k.laufzeit || 0)
        + Math.round((k.gesamtbetrag || 0) * 100)
        + dateNum(k.startdatum)
        + strHash(k.name)
        + strHash(k.kategorie)
        + strHash(k.benutzer);
    });
  }

  const ausKeys = countObj(monthsAusgaben);
  const einKeys = countObj(monthsEinkommen);

  return `v5|fix:${fix}:${fixSum}|sk:${sk}:${skSum}|sr:${sr}|kred:${kred}:${kredSum}|ausM:${ausKeys}|einM:${einKeys}|ausI:${ausgabenItems}|einI:${einkommenItems}`;
}

      
      showInitialLoadPrompt(cloudData) {
        const notification = document.createElement('div');
        notification.className = 'notification-modal';
        notification.innerHTML = `
          <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-modalFadeIn">
            <div class="text-center mb-4">
              <div class="text-5xl mb-3">‚òÅÔ∏è</div>
              <h3 class="kpi-value text-[color:var(--text-primary)] mb-2">Cloud-Daten gefunden!</h3>
              <p class="text-[color:var(--text-tertiary)]">
                F√ºr diese User-ID existieren bereits Daten in der Cloud.
                M√∂chtest du sie laden?
              </p>
            </div>
            <div class="flex gap-3">
              <button onclick="app.loadInitialCloudData()" 
                  class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
                Ja, laden
              </button>
              <button onclick="app.dismissInitialPrompt()" 
                  class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                Nein, lokal starten
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(notification);
      }
      
      showOutdatedDataWarning(cloudData) {
        const notification = document.createElement('div');
        notification.className = 'notification-modal';
        notification.innerHTML = `
          <div class="bg-orange-50 rounded-2xl shadow-2xl max-w-md w-full p-6 animate-modalFadeIn border-4 border-orange-500">
            <div class="text-center mb-4">
              <div class="text-5xl mb-3">‚ö†Ô∏è</div>
              <h3 class="kpi-value text-orange-800 mb-2">Achtung: Veraltete Daten!</h3>
              <p class="text-orange-700 font-medium mb-2">
                Die Cloud hat neuere Daten als dein Ger√§t.
              </p>
              <p class="text-sm text-orange-600">
                Wenn du jetzt √Ñnderungen machst, k√∂nnten Daten von anderen Usern √ºberschrieben werden!
              </p>
            </div>
            <div class="bg-white rounded-lg p-3 mb-4 text-sm text-gray-700">
              <strong>Empfehlung:</strong> Lade zuerst die aktuellen Cloud-Daten, bevor du √Ñnderungen machst.
            </div>
            <div class="flex flex-col gap-2">
              <button onclick="app.loadInitialCloudData()" 
                  class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all">
                ‚úì Jetzt Cloud-Daten laden (empfohlen)
              </button>
              <button onclick="app.continueWithLocalData()" 
                  class="w-full bg-orange-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-orange-600 transition-all">
                ‚ö†Ô∏è Trotzdem mit lokalen Daten weitermachen
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(notification);
      }
      
      async loadInitialCloudData() {
        // Schlie√üe Prompt
        document.querySelectorAll('.notification-modal, .fixed.inset-0').forEach(n => n.remove());
        
        // Lade Cloud-Daten
        await this.performLoad();
        
        // Aktiviere Real-time Sync
        this.setupRealtimeSync();
      }
      
      dismissInitialPrompt() {
        // Schlie√üe Prompt
        document.querySelectorAll('.notification-modal, .fixed.inset-0').forEach(n => n.remove());
        
        // Speichere lokalen Timestamp
        this.localLastModified = Date.now();
        this.saveData('lastModified', this.localLastModified);
        
        // Aktiviere Real-time Sync
        this.setupRealtimeSync();
        
        dlog('‚úÖ Mit lokalen Daten gestartet');
      }
      
      continueWithLocalData() {
        // Schlie√üe Warning
        document.querySelectorAll('.notification-modal, .fixed.inset-0').forEach(n => n.remove());
        
        // Warnung: User will trotzdem mit alten Daten arbeiten
        this.showModal('‚ö†Ô∏è Warnung', 
          'Du arbeitest jetzt mit veralteten lokalen Daten.\n\nWenn du speicherst, werden neuere Cloud-Daten √ºberschrieben!\n\nBitte synchronisiere regelm√§√üig mit der Cloud.',
          [{ text: 'Verstanden', class: 'bg-orange-500 hover:bg-orange-600 text-white' }]
        );
        
        // Aktiviere Real-time Sync trotzdem (f√ºr zuk√ºnftige Updates)
        this.setupRealtimeSync();
      }
      
      setupRealtimeSync() {
    // Realtime sync was Firestore-based. In secure mode we use explicit API load/save.
    if (this.syncUnsubscribe) {
      try { this.syncUnsubscribe(); } catch {}
      this.syncUnsubscribe = null;
    }
    return;
  }
      
      handleCloudUpdate(cloudData) {
        // Pr√ºfe ob Daten wirklich unterschiedlich sind
        const dataChanged = this.compareData(cloudData);
        
        // Debug: Zeige beide Hashes
        const localHash = this.createDataHash();
        const cloudHash = this.createCloudDataHash(cloudData);
        dlog('üîç Hash-Vergleich:');
        dlog('  Lokal:', localHash);
        dlog('  Cloud:', cloudHash);
        dlog('  Unterschiedlich?', dataChanged);
        
        if (!dataChanged) {
          // Daten sind identisch - nur Timestamp aktualisieren, keine Notification
          dlog('‚úÖ Daten unver√§ndert - nur Timestamp aktualisiert');
          this.localLastModified = cloudData.lastModified;
          
          // Flag setzen um markAsChanged zu verhindern
          this.isProcessingCloudUpdate = true;
          this.saveData('lastModified', cloudData.lastModified);
          this.isProcessingCloudUpdate = false;
          
          // WICHTIG: hasUnsavedChanges auf false setzen da Daten identisch sind
          this.hasUnsavedChanges = false;
          this.updateFAB();
          return;
        }
        
        // Daten sind unterschiedlich
        if (this.hasUnsavedChanges) {
          this.showConflictNotification(cloudData);
        } else {
          // Keine lokalen √Ñnderungen - einfach Cloud-Daten √ºbernehmen
          this.showUpdateNotification(cloudData);
        }
      }
      
      showConflictNotification(cloudData) {
        const notification = document.createElement('div');
        notification.className = 'notification-modal';
        // Extra inline styles for bulletproof positioning
        notification.style.cssText = 'position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; display: flex !important; align-items: center !important; justify-content: center !important; z-index: 999998 !important;';
        notification.innerHTML = `
          <div class="bg-gradient-to-br from-orange-500 to-red-500 text-white rounded-2xl shadow-2xl max-w-md w-full animate-modalFadeIn">
            <!-- Header -->
            <div class="bg-orange-600 bg-opacity-30 px-5 py-4 rounded-t-2xl flex items-center justify-between">
              <div class="flex items-center gap-2">
                <svg class="w-7 h-7 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div class="font-bold text-lg">Konflikt erkannt!</div>
              </div>
              <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center transition-all flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            
            <!-- Content -->
            <div class="px-5 py-4">
              <div class="mb-4">
                <p class="text-sm leading-relaxed">
                  Ein anderer User hat √Ñnderungen gemacht, aber du hast auch lokale √Ñnderungen.
                </p>
              </div>
              
              <!-- Info Box -->
              <div class="bg-white bg-opacity-20 rounded-xl p-3 mb-4">
                <p class="kpi-sub">
                  <strong>Tipp:</strong> W√§hle, welche Version du behalten m√∂chtest.
                </p>
              </div>
              
              <!-- Buttons -->
              <div class="flex flex-col gap-2.5">
                <button onclick="app.resolveConflict('cloud', ${JSON.stringify(cloudData).replace(/"/g, '&quot;')})" 
                    class="fm-notify-btn fm-notify-primary">
                  Cloud √ºbernehmen
                </button>
                <button onclick="app.resolveConflict('keep', null)" 
                    class="fm-notify-btn fm-notify-secondary">
                  Meine behalten
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(notification);
      }
      
      showUpdateNotification(cloudData) {
        const notification = document.createElement('div');
        notification.className = 'notification-modal';
        // Extra inline styles for bulletproof positioning
        notification.style.cssText = 'position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; display: flex !important; align-items: center !important; justify-content: center !important; z-index: 999998 !important;';
        notification.innerHTML = `
          <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl shadow-2xl max-w-md w-full animate-modalFadeIn">
            <!-- Header -->
            <div class="bg-blue-600 bg-opacity-30 px-5 py-4 rounded-t-2xl flex items-center justify-between">
              <div class="flex items-center gap-2">
                <svg class="w-7 h-7 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <div class="font-bold text-lg">Neue Daten verf√ºgbar!</div>
              </div>
              <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="text-white hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center transition-all flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            
            <!-- Content -->
            <div class="px-5 py-4">
              <div class="mb-4">
                <p class="text-sm leading-relaxed">
                  Ein anderer User hat √Ñnderungen gemacht. M√∂chtest du die aktuellen Daten laden?
                </p>
              </div>
              
              <!-- Info Box -->
              <div class="bg-white bg-opacity-20 rounded-xl p-3 mb-4">
                <p class="kpi-sub">
                  <strong>Empfehlung:</strong> Lade die Daten jetzt, um auf dem neuesten Stand zu bleiben.
                </p>
              </div>
              
              <!-- Buttons -->
              <div class="flex flex-col gap-2.5">
                <button onclick="app.acceptCloudUpdate(${JSON.stringify(cloudData).replace(/"/g, '&quot;')})" 
                    class="fm-notify-btn fm-notify-primary">
                  Jetzt laden
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                    class="fm-notify-btn fm-notify-secondary">
                  Sp√§ter
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(notification);
      }
      
      resolveConflict(action, cloudData) {
        // Schlie√üe Notification
        document.querySelectorAll('.notification-modal').forEach(n => n.remove());
        
        if (action === 'cloud') {
          this.acceptCloudUpdate(cloudData);
        } else {
          // Behalte lokale √Ñnderungen - markiere als "muss hochgeladen werden"
          this.showModal('üíæ √Ñnderungen behalten', 
            'Deine lokalen √Ñnderungen wurden beibehalten.\n\nBitte speichere sie bald in die Cloud, um sie mit anderen zu teilen!',
            [{ text: 'OK', class: 'bg-gradient-to-r from-indigo-600 to-purple-600' }]
          );
        }
      }
      
      acceptCloudUpdate(cloudData) {
        // Schlie√üe Notification
        document.querySelectorAll('.notification-modal').forEach(n => n.remove());
        
        // Flag setzen um markAsChanged zu verhindern
        this.isAcceptingCloudUpdate = true;
        
        // Cloud-Daten √ºbernehmen
        this.fixkosten = cloudData.fixkosten || [];
        this.ausgabenAll = cloudData.ausgabenAll || {};
        this.einkommenAll = cloudData.einkommenAll || {};
        this.zusatzeinkommenAll = cloudData.zusatzeinkommenAll || {};
        this.sparkonten = cloudData.sparkonten || [];
        this.sparraten = cloudData.sparraten || [];
        this.kontobewegungen = cloudData.kontobewegungen || {};
        this.ausgabenVorlagen = cloudData.ausgabenVorlagen || [];
        this.kredite = cloudData.kredite || [];
        this.benutzer = cloudData.benutzer || this.benutzer;
        this.haushalt = cloudData.haushalt || this.haushalt;
        this.standardEinkommen = cloudData.standardEinkommen || {};
        // WICHTIG: aktiverBenutzer NICHT √ºberschreiben - jeder User beh√§lt seine Auswahl!
        // this.aktiverBenutzer = cloudData.aktiverBenutzer || 'ich';
        this.settings = cloudData.settings || { currency: 'EUR', dateFormat: 'de-DE' };
        this.lastSync = cloudData.lastSync;
        
        // LocalStorage aktualisieren
        this.saveData('fixkosten', this.fixkosten);
        this.saveData('ausgabenAll', this.ausgabenAll);
        this.saveData('einkommenAll', this.einkommenAll);
        this.saveData('zusatzeinkommenAll', this.zusatzeinkommenAll);
        this.saveData('sparkonten', this.sparkonten);
        this.saveData('sparraten', this.sparraten);
        this.saveData('kontobewegungen', this.kontobewegungen);
        this.ausgabenVorlagen = this.ausgabenVorlagen;
        this.saveData('kredite', this.kredite);
        this.saveData('benutzer', this.benutzer);
        this.saveData('haushalt', this.haushalt);
        this.saveData('standardEinkommen', this.standardEinkommen);
        // aktiverBenutzer wird NICHT gespeichert - bleibt lokal!
        // this.saveData('aktiverBenutzer', this.aktiverBenutzer);
        this.saveData('settings', this.settings);
        this.saveData('lastSync', this.lastSync);
        
        // Reset flags
        this.hasUnsavedChanges = false;
        this.localLastModified = Date.now();
        if (cloudData.lastModified) {
          this.localLastModified = cloudData.lastModified;
          this.saveData('lastModified', cloudData.lastModified);
        }
        
        // Flag zur√ºcksetzen
        this.isAcceptingCloudUpdate = false;
        
        // FAB aktualisieren
        this.updateFAB();
        
        // UI neu rendern
        this.render();
        
        // Kurze Best√§tigung
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-28 md:bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-auto z-50 animate-slideUp';
        toast.innerHTML = `
          <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3">
            <div class="text-2xl">‚úÖ</div>
            <div class="font-bold text-base">Daten aktualisiert!</div>
          </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
      
      markAsChanged() {
        this.hasUnsavedChanges = true;
        this.localLastModified = Date.now();
        this.updateFAB();
      }

      resetAllData() {
        this.showModal('‚ö†Ô∏è Alle Daten zur√ºcksetzen?', 
          'ACHTUNG: Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!\n\nAlle deine Daten werden gel√∂scht:\n‚Ä¢ Fixkosten\n‚Ä¢ Ausgaben\n‚Ä¢ Einkommen\n‚Ä¢ Sparkonten\n‚Ä¢ Sparraten\n‚Ä¢ Kontobewegungen\n\nBist du dir absolut sicher?',
          [
            { text: 'Ja, alles l√∂schen', class: 'btn-reset', callback: () => this.confirmReset() },
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' }
          ]
        );
      }

      confirmReset() {
        this.showModal(icons.alert + ' Letzte Warnung!', 
          'Bist du dir 100% sicher?\nAlle Daten werden unwiderruflich gel√∂scht!',
          [
            { text: 'JA, WIRKLICH L√ñSCHEN', class: 'btn-reset', callback: () => this.performReset() },
            { text: 'Nein, abbrechen', class: 'bg-gray-300 text-gray-700' }
          ]
        );
      }

      performReset() {
        // Alle Daten zur√ºcksetzen (inkl. Haushalt, Benutzer, Standard-Einkommen, Kredite, Vorlagen)
        this.fixkosten = [];
        this.ausgabenAll = {};
        this.einkommenAll = {};
        this.zusatzeinkommenAll = {};
        this.sparkonten = [];
        this.sparraten = [];
        this.kontobewegungen = {};
        this.kredite = [];
        this.ausgabenVorlagen = [];

        // üë• MULTI-USER: Haushalt zur√ºcksetzen
        this.haushalt = {
          name: 'Mein Haushalt',
          erstellt: new Date().toISOString()
        };

        // Standard: nur "ich"
        this.benutzer = {
          'ich': {
            id: 'ich',
            name: 'Ich',
            farbe: '#10b981',
            emoji: 'üë§',
            aktiv: true
          }
        };

        // aktiver Benutzer + Standard-Einkommen zur√ºcksetzen
        this.aktiverBenutzer = 'ich';
        this.standardEinkommen = {};

        // State / Meta
        this.currentMonth = new Date().toISOString().slice(0, 7);
        this.lastSync = null;

        // Flags / Timestamps
        this.hasUnsavedChanges = false;
        this.localLastModified = Date.now();
        this.saveData('lastModified', this.localLastModified);

        // LocalStorage persistieren
        this.saveData('fixkosten', this.fixkosten);
        this.saveData('ausgabenAll', this.ausgabenAll);
        this.saveData('einkommenAll', this.einkommenAll);
        this.saveData('zusatzeinkommenAll', this.zusatzeinkommenAll);
        this.saveData('sparkonten', this.sparkonten);
        this.saveData('sparraten', this.sparraten);
        this.saveData('kontobewegungen', this.kontobewegungen);
        this.saveData('kredite', this.kredite);
        this.saveData('ausgabenVorlagen', this.ausgabenVorlagen);
        this.saveData('haushalt', this.haushalt);
        this.saveData('benutzer', this.benutzer);
        this.saveData('aktiverBenutzer', this.aktiverBenutzer);
        this.saveData('standardEinkommen', this.standardEinkommen);
        this.saveData('currentMonth', this.currentMonth);
        this.saveData('lastSync', this.lastSync);

        // Cache/Charts/UI
        try { this.invalidateCache?.(); } catch(e) {}
        try { this.clearCache?.(); } catch(e) {}
        try { this.updateFAB?.(); } catch(e) {}

        this.showModal('‚úÖ Gel√∂scht',
          'Alle Daten wurden vollst√§ndig zur√ºckgesetzt!',
          [{ text: 'OK', class: 'bg-green-500 hover:bg-green-600 text-white', callback: () => this.render() }]
        );
      }

      showModal(title, message, buttons) {
        // Erstelle Modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        const buttonsHTML = buttons.map((btn, idx) => {
          let style = '';
          if (btn.class === 'btn-upload') {
            style = 'background: linear-gradient(135deg, #10b981 0%, #059669 100%);';
          } else if (btn.class === 'btn-download') {
            style = 'background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);';
          } else if (btn.class === 'btn-reset') {
            style = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);';
          } else if (btn.class.includes('from-indigo-600')) {
            style = 'background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);';
          }
          
          return `
            <button 
              onclick="app.handleModalButton(${idx})" 
              class="flex-1 px-4 py-3 text-white rounded-lg font-semibold hover:shadow-lg transition-all ${btn.class}"
              style="${style}"
            >
              ${btn.text}
            </button>
          `;
        }).join('');
        
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="kpi-value text-[color:var(--text-primary)] mb-4">${title}</h3>
            <p class="text-gray-700 mb-6 whitespace-pre-line">${message}</p>
            <div class="flex gap-3">
              ${buttonsHTML}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Speichere Button-Callbacks
        this._modalButtons = buttons;
        
        // Schlie√üen bei Klick au√üerhalb
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            try { modal._cleanupA11y?.(); } catch {}
        modal.remove();
          }
        });
      }

      // üîí Pflichtfelder-Hinweis (einheitliches Modal bei allen ‚ÄûHinzuf√ºgen‚Äú-Aktionen)
      showRequiredFieldsModal() {
        this.showModal(
          'Pflichtfelder',
          'Bitte alle Pflichtfelder ausf√ºllen',
          [
            {
              text: 'OK',
              class: 'from-indigo-600 to-purple-600',
              callback: () => this.closeModal()
            }
          ]
        );
      }



      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      handleModalButton(index) {
        const btn = this._modalButtons[index];
        document.querySelector('.modal-overlay')?.remove();
        if (btn.callback) {
          btn.callback();
        }
      }

      // Helper-Funktion: Heutiges Datum im Format YYYY-MM-DD
      getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      showNotification(message, type = 'info', duration = 3000) {
        // Remove existing notification
        document.querySelector('.toast-container')?.remove();
        
        // Create container
        const container = document.createElement('div');
        container.className = 'toast-container';
        
        // Create notification
        const toast = document.createElement('div');
        toast.className = 'toast-notification toast-' + (type === 'error' ? 'error' : 'success');
        toast.textContent = message;
        
        container.appendChild(toast);
        document.body.appendChild(container);
        
        // Auto-remove after duration
        setTimeout(() => {
          container.remove();
        }, duration);
      }

      changeUserId() {
        // Modal mit Input-Feld f√ºr User-ID
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.key} <span>User-ID √§ndern</span></h3>
            <div class="mb-4">
              <label class="block text-sm font-semibold text-gray-700 mb-2">Aktuelle User-ID:</label>
              <input 
                type="text" 
                value="${this.userId}" 
                readonly 
                class="modal-input bg-gray-100 cursor-not-allowed"
              />
            </div>
            <div class="mb-6">
              <label class="block text-sm font-semibold text-gray-700 mb-2">Neue User-ID eingeben:</label>
              <input 
                type="text" 
                id="newUserIdInput"
                value="${this.userId}"
                placeholder="Kopiere User-ID aus anderem Browser/Ger√§t"
                class="modal-input"
                autocomplete="off"
              />
              <p class="kpi-sub text-[color:var(--text-tertiary)] mt-2">
                ${icons.lightbulb} Tipp: Kopiere die User-ID aus dem anderen Ger√§t und f√ºge sie hier ein.
              </p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <button 
                onclick="app.closeModal()" 
                class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-all"
              >
                Abbrechen
              </button>
              <button 
                onclick="app.confirmUserIdChange()" 
                class="flex-1 px-4 py-3 text-white rounded-lg font-semibold hover:shadow-lg transition-all"
                style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"
              >
                ID √Ñndern
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Fokus auf Input-Feld
        setTimeout(() => {
          document.getElementById('newUserIdInput')?.focus();
          document.getElementById('newUserIdInput')?.select();
        }, 100);
        
        // Enter-Taste zum Best√§tigen
        document.getElementById('newUserIdInput')?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.confirmUserIdChange();
          }
        });
        
        // Schlie√üen bei Klick au√üerhalb
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            try { modal._cleanupA11y?.(); } catch {}
        modal.remove();
          }
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      confirmUserIdChange() {
        const newId = document.getElementById('newUserIdInput')?.value.trim();
        const currentId = this.userId;
        
        if (!newId) {
          this.showModal('‚ùå Fehler', 'Bitte gib eine User-ID ein!', [
            { text: 'OK', class: 'bg-red-500 hover:bg-red-600 text-white' }
          ]);
          return;
        }
        
        if (newId === currentId) {
          this.closeModal();
          return;
        }
        
        // Best√§tigungsdialog
        this.closeModal();
        
        this.showModal('‚ö†Ô∏è User-ID √§ndern?', 
          `Neue ID: ${newId.substring(0, 40)}${newId.length > 40 ? '...' : ''}\n\nNach dem √Ñndern kannst du auf die Cloud-Daten dieser ID zugreifen.\n\nDeine aktuellen lokalen Daten bleiben erhalten.`, 
          [
            { 
              text: 'Abbrechen', 
              class: 'bg-gray-300 text-gray-700' 
            },
            { 
              text: 'Jetzt √Ñndern', 
              class: 'bg-gradient-to-r from-orange-500 to-orange-600',
              callback: () => {
                this.userId = newId;
                this.saveData('userId', this.userId);
                this.updateURLWithUserId();
                
                this.showModal('‚úÖ User-ID ge√§ndert!', 
                  icons.pin + ' WICHTIG: Setze ein LESEZEICHEN f√ºr diese Seite!\nDie User-ID ist jetzt in der URL gespeichert.\n\nKlicke auf "Laden" um die Daten aus der Cloud zu laden.', 
                  [
                    { text: 'OK', class: 'bg-gradient-to-r from-green-500 to-green-600' }
                  ]
                );
                
                this.render();
              }
            }
          ]
        );
      }

      closeModal() {
        document.querySelector('.modal-overlay')?.remove();
      }

      copyUserId() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          this.showNotification('‚úÖ URL mit User-ID kopiert!\n\nSetze ein Lesezeichen f√ºr diese Seite.', 'success', 4000);
        }).catch(() => {
          // Fallback: Show modal with input to copy manually
          const modal = document.createElement('div');
          modal.className = 'modal-overlay';
          modal.innerHTML = `
            <div class="modal-content">
              <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.clipboard} <span>URL kopieren</span></h3>
              <p class="text-gray-700 mb-4">Kopiere diese URL (enth√§lt deine User-ID):</p>
              <input type="text" value="${url}" readonly class="modal-input" id="urlToCopy" />
              <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">
                  Schlie√üen
                </button>
                <button onclick="document.getElementById('urlToCopy').select();document.execCommand('copy');app.showNotification('‚úÖ Kopiert!', 'success');document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 rounded-lg font-semibold text-white" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);">
                  Kopieren
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          setTimeout(() => document.getElementById('urlToCopy')?.select(), 100);
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      toggleDarkMode() {
        this.darkMode = !this.darkMode;
        document.body.classList.toggle('dark-mode');
        this.saveData('darkMode', this.darkMode);
        this.render();
      }

      // üë• MULTI-USER FUNCTIONS
      
      switchUser(benutzerId) {
        if (this.benutzer[benutzerId]) {
          this.aktiverBenutzer = benutzerId;
          this.saveData('aktiverBenutzer', this.aktiverBenutzer);
          this.render();
        }
      }

      showUserManagement() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        const benutzerList = Object.values(this.benutzer).map(b => `
          <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
            <div class="flex items-start gap-4 mb-3">
              <div class="text-5xl">${b.emoji}</div>
              <div class="flex-1">
                <h4 class="text-xl font-bold text-[color:var(--text-primary)]">${b.name}</h4>
                <p class="text-sm text-[color:var(--text-tertiary)]">ID: ${b.id}</p>
              </div>
            </div>
            
            <div class="flex gap-2">
              <button onclick="app.editBenutzer('${b.id}')" class="flex-1 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                Bearbeiten
              </button>
              ${b.id !== 'ich' ? `
                <button onclick="app.deleteBenutzer('${b.id}')" class="flex-1 p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-semibold">
                  L√∂schen
                </button>
              ` : `
                <button disabled class="flex-1 p-2 bg-gray-400 text-white rounded-lg hover:bg-gray-400 transition-colors font-semibold cursor-not-allowed opacity-75 text-sm">
                  Nicht l√∂schbar
                </button>
              `}
            </div>
          </div>
        `).join('');
        
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;">
            <h3 class="kpi-value text-[color:var(--text-primary)] mb-6">Haushalt verwalten</h3>

            <!-- Grid: Mobile 1 Spalte, Desktop 2 Spalten -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Linke Seite: Haushalt-Name & Person hinzuf√ºgen -->
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Haushalt-Name</label>
                  <input type="text" id="haushaltsName" value="${this.haushalt.name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Personen im Haushalt</label>
                  <button onclick="app.addBenutzerForm()" class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold flex items-center justify-center gap-2">
                    ${icons.plus} Person hinzuf√ºgen
                  </button>
                </div>
              </div>

              <!-- Rechte Seite: Benutzer-Liste -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Personen</label>
                <div class="space-y-3 max-h-[400px] overflow-y-auto">
                  ${benutzerList}
                </div>
              </div>
            </div>

            <!-- Bottom Actions -->
            <div class="flex gap-3 mt-6 pt-6 border-t border-gray-200">
              <button onclick="app.saveHaushaltSettings()" class="flex-1 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold">
                Speichern
              </button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-semibold">
                Schlie√üen
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      addBenutzerForm() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        const emojis = ['üë®', 'üë©', 'üë¶', 'üëß', 'üë¥', 'üëµ', 'üë∂', 'üë®‚Äçüë©‚Äçüë¶', 'üè†'];
        const farben = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
        
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.user} <span>Person hinzuf√ºgen</span></h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                <input type="text" id="neuBenutzername" placeholder="z.B. Anna" class="modal-input" />
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Emoji w√§hlen</label>
                <div class="flex gap-2 flex-wrap">
                  ${emojis.map(e => `
                    <button onclick="document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('ring-4'));this.classList.add('ring-4');document.getElementById('selectedEmoji').value='${e}'" 
                        class="emoji-btn text-3xl p-2 hover:bg-gray-100 rounded-lg transition-all ring-blue-500">
                      ${e}
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="selectedEmoji" value="${emojis[0]}" />
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Farbe w√§hlen</label>
                <div class="flex gap-2 flex-wrap">
                  ${farben.map(f => `
                    <button onclick="document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('ring-4'));this.classList.add('ring-4');document.getElementById('selectedColor').value='${f}'" 
                        class="color-btn w-12 h-12 rounded-lg ring-blue-500 transition-all" 
                        style="background: ${f}">
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="selectedColor" value="${farben[0]}" />
              </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
              <button onclick="app.saveNeuerBenutzer()" class="flex-1 px-4 py-3 text-white rounded-lg font-semibold" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                Hinzuf√ºgen
              </button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">
                Abbrechen
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Erstes Emoji & Farbe vorselektieren
        setTimeout(() => {
          document.querySelector('.emoji-btn')?.classList.add('ring-4');
          document.querySelector('.color-btn')?.classList.add('ring-4');
        }, 100);
      }

      saveNeuerBenutzer() {
        const name = document.getElementById('neuBenutzername')?.value.trim();
        const emoji = document.getElementById('selectedEmoji')?.value;
        const farbe = document.getElementById('selectedColor')?.value;
        
        if (!name) {
          this.showNotification('‚ùå Bitte einen Namen eingeben!', 'error');
          return;
        }
        
        const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
        
        this.benutzer[id] = {
          id,
          name,
          emoji,
          farbe,
          aktiv: true
        };
        
        this.saveData('benutzer', this.benutzer);
        this.showNotification(`‚úÖ ${name} wurde hinzugef√ºgt!`, 'success');
        
        document.querySelector('.modal-overlay').remove();
        this.showUserManagement();
      }

      editBenutzer(id) {
        const benutzer = this.benutzer[id];
        if (!benutzer) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        const emojis = ['üë®', 'üë©', 'üë¶', 'üëß', 'üë¥', 'üëµ', 'üë∂', 'üë®‚Äçüë©‚Äçüë¶', 'üè†', 'üë§'];
        const farben = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
        
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.edit} <span>Person bearbeiten</span></h3>
            
            ${id === 'ich' ? `
              <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-700">
                  ‚ÑπÔ∏è Dies ist der Standard-Benutzer. Du kannst Name, Emoji und Farbe anpassen, aber nicht l√∂schen.
                </p>
              </div>
            ` : ''}
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                <input type="text" id="editBenutzername" value="${benutzer.name}" class="modal-input" />
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Emoji w√§hlen</label>
                <div class="flex gap-2 flex-wrap">
                  ${emojis.map(e => `
                    <button onclick="document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('ring-4'));this.classList.add('ring-4');document.getElementById('editSelectedEmoji').value='${e}'" 
                        class="emoji-btn text-3xl p-2 hover:bg-gray-100 rounded-lg transition-all ring-blue-500 ${e === benutzer.emoji ? 'ring-4' : ''}">
                      ${e}
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="editSelectedEmoji" value="${benutzer.emoji}" />
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Farbe w√§hlen</label>
                <div class="flex gap-2 flex-wrap">
                  ${farben.map(f => `
                    <button onclick="document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('ring-4'));this.classList.add('ring-4');document.getElementById('editSelectedColor').value='${f}'" 
                        class="color-btn w-12 h-12 rounded-lg ring-blue-500 transition-all ${f === benutzer.farbe ? 'ring-4' : ''}" 
                        style="background: ${f}">
                    </button>
                  `).join('')}
                </div>
                <input type="hidden" id="editSelectedColor" value="${benutzer.farbe}" />
              </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
              <button onclick="app.saveEditedBenutzer('${id}')" class="flex-1 px-4 py-3 text-white rounded-lg font-semibold" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                Speichern
              </button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">
                Abbrechen
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      saveEditedBenutzer(id) {
        const name = document.getElementById('editBenutzername')?.value.trim();
        const emoji = document.getElementById('editSelectedEmoji')?.value;
        const farbe = document.getElementById('editSelectedColor')?.value;
        
        if (!name) {
          this.showNotification('‚ùå Bitte einen Namen eingeben!', 'error');
          return;
        }
        
        // Aktualisiere Benutzer
        this.benutzer[id] = {
          ...this.benutzer[id],
          name,
          emoji,
          farbe
        };
        
        this.saveData('benutzer', this.benutzer);
        this.showNotification(`‚úÖ ${name} wurde aktualisiert!`, 'success');
        
        document.querySelector('.modal-overlay').remove();
        this.showUserManagement();
      }

      deleteBenutzer(id) {
        if (id === 'ich') {
          this.showNotification('‚ùå Standard-Benutzer kann nicht gel√∂scht werden!', 'error');
          return;
        }
        
        const benutzer = this.benutzer[id];
        if (!benutzer) return;
        
        this.showModal(
          '‚ö†Ô∏è Person l√∂schen?',
          `M√∂chtest du ${benutzer.emoji} ${benutzer.name} wirklich l√∂schen?\n\nDie zugeordneten Ausgaben bleiben erhalten, sind dann aber keiner Person mehr zugeordnet.`,
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            {
              text: 'L√∂schen',
              class: 'btn-reset',
              callback: () => {
                delete this.benutzer[id];
                this.saveData('benutzer', this.benutzer);
                
                if (this.aktiverBenutzer === id) {
                  this.aktiverBenutzer = 'ich';
                  this.saveData('aktiverBenutzer', 'ich');
                }
                
                this.showNotification(`‚úÖ ${benutzer.name} wurde gel√∂scht`, 'success');
                this.showUserManagement();
              }
            }
          ]
        );
      }

      saveHaushaltSettings() {
        const name = document.getElementById('haushaltsName')?.value.trim();
        if (name) {
          this.haushalt.name = name;
          this.saveData('haushalt', this.haushalt);
        }
        
        this.showNotification('‚úÖ Einstellungen gespeichert!', 'success');
        document.querySelector('.modal-overlay').remove();
        this.render();
      }

      // üîÑ MIGRATION F√úR ALTE DATEN
      migrateToMultiUser() {
        let migrated = false;
        
        // Ausgaben migrieren
        Object.keys(this.ausgabenAll).forEach(month => {
          this.ausgabenAll[month] = this.ausgabenAll[month].map(a => {
            if (!a.benutzer) {
              a.benutzer = 'ich';
              a.typ = 'privat';
              migrated = true;
            }
            return a;
          });
        });
        
        // Fixkosten migrieren
        this.fixkosten = this.fixkosten.map(f => {
          if (!f.benutzer) {
            f.benutzer = 'gemeinsam';
            f.typ = 'gemeinsam';
            migrated = true;
          }
          if (!f.intervall) {
            f.intervall = 'monatlich';
            migrated = true;
          }
          return f;
        });
        
        // Sparkonten migrieren
        this.sparkonten = this.sparkonten.map(k => {
          if (!k.benutzer) {
            k.benutzer = 'ich';
            migrated = true;
          }
          // Konvertiere benutzer zu teilnehmer Array falls nicht vorhanden
          if (!k.teilnehmer) {
            k.teilnehmer = [k.benutzer];
            migrated = true;
          }
          return k;
        });
        
        // Sparraten migrieren
        this.sparraten = this.sparraten.map(r => {
          if (!r.benutzer) {
            r.benutzer = 'ich';
            migrated = true;
          }
          return r;
        });
        
        // Einkommen migrieren (von Number zu Object mit User-IDs)
        Object.keys(this.einkommenAll).forEach(month => {
          // Wenn es eine Zahl ist, migriere zu Object-Struktur
          if (typeof this.einkommenAll[month] === 'number') {
            const oldEinkommen = this.einkommenAll[month];
            this.einkommenAll[month] = {
              'ich': oldEinkommen
            };
            migrated = true;
          }
          // Wenn es ein Object ist, stelle sicher dass 'ich' existiert
          else if (typeof this.einkommenAll[month] === 'object') {
            if (!this.einkommenAll[month]['ich']) {
              this.einkommenAll[month]['ich'] = 0;
            }
          }
        });
        
        if (migrated) {
          this.saveData('ausgabenAll', this.ausgabenAll);
          this.saveData('einkommenAll', this.einkommenAll);
          this.saveData('fixkosten', this.fixkosten);
          this.saveData('sparkonten', this.sparkonten);
          this.saveData('sparraten', this.sparraten);
          dlog('‚úÖ Migration zu Multi-User abgeschlossen - alle alten Daten wurden migriert');
        }
      }

      // üë• FILTER & STATISTIK FUNKTIONEN
      
      getAusgabenByUser(month, userId = null) {
        const ausgaben = this.ausgabenAll[month] || [];
        if (!userId || userId === 'all') return ausgaben;
        return ausgaben.filter(a => a.benutzer === userId);
      }

      getTotalByUser(month, userId = null) {
        const ausgaben = this.getAusgabenByUser(month, userId);
        return ausgaben.reduce((sum, a) => sum + a.betrag, 0);
      }

      getFixkostenAnteil(userId) {
        // Helper: Konvertiere zu monatlichem Betrag
        const toMonthly = (betrag, intervall) => {
          switch(intervall) {
            case 'viertelj√§hrlich': return betrag / 3;
            case 'halbj√§hrlich': return betrag / 6;
            case 'j√§hrlich': return betrag / 12;
            default: return betrag; // monatlich
          }
        };
        
        // Private Fixkosten des Users (umgerechnet auf monatlich)
        const privateFixkosten = this.fixkosten
          .filter(f => f.benutzer === userId)
          .reduce((sum, f) => sum + toMonthly(f.betrag, f.intervall || 'monatlich'), 0);
        
        // Gemeinsame Fixkosten (umgerechnet auf monatlich, geteilt durch Anzahl User)
        const gemeinsameFixkosten = this.fixkosten
          .filter(f => f.benutzer === 'gemeinsam')
          .reduce((sum, f) => sum + toMonthly(f.betrag, f.intervall || 'monatlich'), 0);
        
        const userCount = Object.keys(this.benutzer).filter(k => k !== 'gemeinsam').length;
        const gemeinsamerAnteil = userCount > 0 ? gemeinsameFixkosten / userCount : 0;
        
        return privateFixkosten + gemeinsamerAnteil;
      }

      getUserStats(month, userId) {
  const user = this.benutzer[userId];
  if (!user) return null;

  const userIds = Object.keys(this.benutzer).filter(k => k !== 'gemeinsam');
  const nUsers = Math.max(1, userIds.length);

  // Einkommen (monatsspezifisch -> fallback Standard)
  const einkommenMonth = this.einkommenAll[month] || {};
  const einkommen = einkommenMonth[userId] || this.standardEinkommen?.[userId] || 0;

  // Variable Ausgaben: privat + (nur wenn als "gemeinsam" angelegt) fairer Anteil
  const variablePrivat = this.getTotalByUser(month, userId);
  const variableGemeinsamTotal = this.getTotalByUser(month, 'gemeinsam');
  const variableGemeinsamAnteil = variableGemeinsamTotal > 0 ? (variableGemeinsamTotal / nUsers) : 0;
  const variableAusgaben = variablePrivat + variableGemeinsamAnteil;

  // Fixkosten: privat + (nur "gemeinsam") fairer Anteil (monatlich normalisiert)
  const fixkostenMonatlich = this.getFixkostenAnteil(userId); // beinhaltet bereits den gemeinsamen Anteil
  // F√ºr UI-Details: private vs. gemeinsamer Anteil separat bestimmen
  const toMonthly = (betrag, intervall) => {
    switch(intervall) {
      case 'viertelj√§hrlich': return betrag / 3;
      case 'halbj√§hrlich': return betrag / 6;
      case 'j√§hrlich': return betrag / 12;
      default: return betrag;
    }
  };
  const fixkostenPrivat = this.fixkosten
    .filter(f => f.benutzer === userId)
    .reduce((sum, f) => sum + toMonthly(f.betrag, f.intervall || 'monatlich'), 0);
  const fixkostenGemeinsamTotal = this.fixkosten
    .filter(f => f.benutzer === 'gemeinsam')
    .reduce((sum, f) => sum + toMonthly(f.betrag, f.intervall || 'monatlich'), 0);
  const fixkostenGemeinsamAnteil = fixkostenGemeinsamTotal > 0 ? (fixkostenGemeinsamTotal / nUsers) : 0;

  // Kreditraten: nur aktive Kredite im Monat; privat + (nur "gemeinsam") fairer Anteil
  const kreditraten = this.getKreditratenByUser(month, userId);
  // F√ºr UI-Details (optional)
  const kreditratenGemeinsamAnteil = this.getKreditratenByUser(month, 'gemeinsam') > 0 ? (this.getKreditratenByUser(month, 'gemeinsam') / nUsers) : 0;

  const gesamt = variableAusgaben + fixkostenMonatlich + kreditraten;
  return {
    user,
    einkommen,

    // Variable Ausgaben
    privateAusgaben: variablePrivat,
    gemeinsameAusgabenAnteil: variableGemeinsamAnteil,
    variableAusgaben,

    // Fixkosten
    fixkostenAnteil: fixkostenMonatlich,
    fixkostenPrivat,
    fixkostenGemeinsamAnteil,

    // Kredite
    kreditraten,
    kreditratenGemeinsamAnteil,

    // Totals
    gesamt,
    uebrig: einkommen - gesamt
  };
}

      // Vorlagen-Funktionen
      addVorlage(name, betrag, kategorie) {
        name = sanitizeText(name, 120);
        kategorie = sanitizeText(kategorie, 40);

        const id = Date.now();
        this.ausgabenVorlagen.push({ id, name, betrag: parseAmount(betrag), kategorie });
        this.saveData('ausgabenVorlagen', this.ausgabenVorlagen);
        this.render();
      }

      // üí≥ KREDIT-FUNKTIONEN
      
      // Berechne monatliche Rate mit Annuit√§tenformel
      calculateMonthlyPayment(betrag, zinssatz, laufzeit) {
        if (!betrag || !laufzeit || betrag <= 0 || laufzeit <= 0) {
          return 0;
        }
        
        // Wenn kein Zinssatz: einfache Division
        if (!zinssatz || zinssatz === 0) {
          return betrag / laufzeit;
        }
        
        // Annuit√§tenformel: R = K * (i * (1 + i)^n) / ((1 + i)^n - 1)
        const i = zinssatz / 100 / 12; // Monatlicher Zinssatz
        const n = laufzeit; // Laufzeit in Monaten
        const rate = betrag * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1);
        
        return rate;
      }
      
      // Hilfsfunktion: Parse deutsche Zahlen (mit Komma)
      parseGermanNumber(value) {
        if (!value) return 0;
        // Entferne Tausenderpunkte und ersetze Komma durch Punkt
        const cleaned = String(value).replace(/\./g, '').replace(',', '.');
        return parseFloat(cleaned) || 0;
      }
      
      // Formatiere Zahl f√ºr Anzeige
      formatGermanNumber(value, decimals = 2) {
        if (!value && value !== 0) return '';
        const number = typeof value === 'string' ? this.parseGermanNumber(value) : value;
        return new Intl.NumberFormat('de-DE', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        }).format(number);
      }
      
      // Richte Auto-Formatierung f√ºr Eingabefelder ein
      setupNumberFormatting() {
        const fields = [
          'kreditBetrag', 'kreditGesamtbetrag', 'kreditZins', 'kreditRate'
        ];
        
        fields.forEach(id => {
          const input = document.getElementById(id);
          if (!input) return;
          
          // Bei Blur: Formatieren
          input.addEventListener('blur', (e) => {
            const value = this.parseGermanNumber(e.target.value);
            if (value) {
              e.target.value = this.formatGermanNumber(value);
            }
          });
          
          // Bei Focus: Unformatiert f√ºr einfache Bearbeitung
          input.addEventListener('focus', (e) => {
            const value = this.parseGermanNumber(e.target.value);
            if (value) {
              e.target.value = value.toString().replace('.', ',');
            }
          });
        });
      }
      
      // Berechne Gesamtbetrag aus Rate √ó Laufzeit
      calculateTotalFromForm() {
        const rate = this.parseGermanNumber(document.getElementById('kreditRate').value);
        const laufzeit = parseInt(document.getElementById('kreditLaufzeit').value) || 0;
        
        if (!rate || !laufzeit) {
          this.showNotification('Bitte Rate und Laufzeit eingeben', 'error');
          return;
        }
        
        const gesamtbetrag = rate * laufzeit;
        document.getElementById('kreditGesamtbetrag').value = gesamtbetrag.toFixed(2);
        
        this.showNotification('Gesamtbetrag berechnet: ' + this.formatCurrency(gesamtbetrag), 'success');
      }
      
      // Berechne Rate f√ºr Formular
      calculateRateFromForm() {
        const betrag = this.parseGermanNumber(document.getElementById('kreditBetrag').value);
        const gesamtbetrag = this.parseGermanNumber(document.getElementById('kreditGesamtbetrag').value);
        const zinssatz = this.parseGermanNumber(document.getElementById('kreditZins').value);
        const laufzeit = parseInt(document.getElementById('kreditLaufzeit').value) || 0;
        
        if (!laufzeit) {
          this.showNotification('Bitte Laufzeit eingeben', 'error');
          return;
        }
        
        let rate = 0;
        
        // Wenn Gesamtbetrag angegeben: einfache Division
        if (gesamtbetrag > 0) {
          rate = gesamtbetrag / laufzeit;
        }
        // Sonst: Annuit√§tenformel mit Kreditbetrag
        else if (betrag > 0) {
          rate = this.calculateMonthlyPayment(betrag, zinssatz, laufzeit);
        } else {
          this.showNotification('Bitte Kreditbetrag oder Gesamtbetrag eingeben', 'error');
          return;
        }
        
        document.getElementById('kreditRate').value = rate.toFixed(2);
        
        // Zeige Zinsdetails
        this.showLoanCalculationDetails(betrag, gesamtbetrag, zinssatz, laufzeit, rate);
      }
      
      // Zeige Berechnungsdetails
      showLoanCalculationDetails(betrag, gesamtbetrag, zinssatz, laufzeit, rate) {
        const gesamtZahlung = rate * laufzeit;
        const mehrkosten = gesamtZahlung - betrag;
        
        let detailsHTML = `
          <div class="mt-3 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm">
            <div class="font-semibold text-indigo-900 mb-2">üìä Berechnungsdetails</div>
            <div class="grid grid-cols-2 gap-2 text-gray-700">
              <div>Monatliche Rate:</div>
              <div class="font-bold text-indigo-900">${this.formatCurrency(rate)}</div>
              ${gesamtbetrag > 0 ? `
                <div>Gesamtbetrag (Vertrag):</div>
                <div class="font-semibold">${this.formatCurrency(gesamtbetrag)}</div>
              ` : ''}
              <div>Gesamtzahlung:</div>
              <div class="font-semibold">${this.formatCurrency(gesamtZahlung)}</div>
              <div>Mehrkosten (Zinsen${gesamtbetrag > 0 ? ' + Geb√ºhren' : ''}):</div>
              <div class="font-semibold ${mehrkosten > 0 ? 'text-orange-600' : 'text-green-600'}">${this.formatCurrency(mehrkosten)}</div>
            </div>
          </div>
        `;
        
        // Entferne alte Details
        const oldDetails = document.getElementById('loanCalculationDetails');
        if (oldDetails) oldDetails.remove();
        
        // F√ºge neue Details hinzu
        const container = document.createElement('div');
        container.id = 'loanCalculationDetails';
        container.innerHTML = detailsHTML;
        
        const addButton = document.querySelector('button[onclick="app.addKreditFromForm()"]');
        if (addButton) {
          addButton.closest('.grid').insertAdjacentElement('afterend', container);
        }
      }
      
      calculateKreditDetails(kredit) {
        // Berechne Kredit-Details
        const startDate = new Date(kredit.startdatum);
        const now = new Date();
        const monthsPassed = Math.max(0, (now.getFullYear() - startDate.getFullYear()) * 12 + (now.getMonth() - startDate.getMonth()));
        
        // Restschuld berechnen
        const gezahlt = Math.min(monthsPassed * kredit.rate, kredit.betrag);
        const restschuld = Math.max(0, kredit.betrag - gezahlt);
        
        // Enddatum
        const endDate = new Date(startDate);
        endDate.setMonth(endDate.getMonth() + kredit.laufzeit);
        
        // Gesamtzinsen
        const gesamtZahlung = kredit.rate * kredit.laufzeit;
        const gesamtZinsen = gesamtZahlung - kredit.betrag;
        
        // Bereits gezahlte Zinsen (vereinfacht)
        const gezahlteZinsen = monthsPassed > 0 ? (gesamtZinsen * (gezahlt / kredit.betrag)) : 0;
        
        // Fortschritt
        const fortschritt = kredit.betrag > 0 ? ((kredit.betrag - restschuld) / kredit.betrag) * 100 : 0;
        
        // Status - Kredit ist abbezahlt wenn:
        // 1. Das Enddatum erreicht wurde, ODER
        // 2. Die Restschuld 0 ist UND der Kredit bereits gestartet hat
        const hasStarted = now >= startDate;
        const isAbbezahlt = now >= endDate || (restschuld === 0 && hasStarted && monthsPassed > 0);
        
        return {
          restschuld,
          fortschritt,
          endDate,
          gesamtZinsen,
          gezahlteZinsen,
          isAbbezahlt,
          hasStarted,
          monthsPassed,
          gezahlt
        };
      }
      
      getAktiveKredite() {
        return this.kredite.filter(k => {
          const details = this.calculateKreditDetails(k);
          return !details.isAbbezahlt;
        });
      }
      
      
      // ‚úÖ Kreditraten-Helper: Monatsgenau + User-genau (wie Variable Ausgaben)
      parseKreditStartMonthKey(startdatum) {
        if (!startdatum) return null;
        const s = String(startdatum).trim();
        // ISO: YYYY-MM-DD
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
          return s.slice(0, 7);
        }
        // DE: DD.MM.YYYY
        const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
        if (m) {
          const dd = String(m[1]).padStart(2, '0');
          const mm = String(m[2]).padStart(2, '0');
          const yyyy = m[3];
          return `${yyyy}-${mm}`;
        }
        // Fallback: versuche Date.parse
        const d = new Date(s);
        if (!isNaN(d.getTime())) {
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          return `${yyyy}-${mm}`;
        }
        return null;
      }

      monthKeyToIndex(monthKey) {
        const [y, m] = String(monthKey).split('-').map(Number);
        if (!y || !m) return null;
        return y * 12 + (m - 1);
      }

      isKreditAktivInMonth(kredit, monthKey) {
        const startMK = this.parseKreditStartMonthKey(kredit?.startdatum);
        const startIdx = this.monthKeyToIndex(startMK);
        const monthIdx = this.monthKeyToIndex(monthKey);
        const laufzeit = parseInt(kredit?.laufzeit, 10);

        if (startIdx === null || monthIdx === null || !laufzeit || laufzeit <= 0) return false;

        // Ende inkl.: Startmonat z√§hlt als Monat 1
        const endIdx = startIdx + (laufzeit - 1);
        return monthIdx >= startIdx && monthIdx <= endIdx;
      }

      getKreditratenForMonth(monthKey) {
        const list = Array.isArray(this.kredite) ? this.kredite : [];
        return list.reduce((sum, k) => {
          if (!this.isKreditAktivInMonth(k, monthKey)) return sum;
          const r = parseFloat(k?.rate);
          if (!isFinite(r) || r <= 0) return sum;
          return sum + r;
        }, 0);
      }

      getKreditratenByUser(monthKey, userId) {
        const list = Array.isArray(this.kredite) ? this.kredite : [];
        const userIds = Object.keys(this.benutzer).filter(k => k !== 'gemeinsam');
        const nUsers = Math.max(1, userIds.length);

        let sum = 0;
        for (const k of list) {
          if (!this.isKreditAktivInMonth(k, monthKey)) continue;
          const r = parseFloat(k?.rate);
          if (!isFinite(r) || r <= 0) continue;

          const owner = k?.benutzer || k?.userId || k?.owner || null;

          if (owner === 'gemeinsam') {
            // Gemeinsamer Kredit: fair split (wie gemeinsame Ausgaben)
            if (userId !== 'gemeinsam') sum += (r / nUsers);
          } else if (owner === userId) {
            sum += r;
          }
        }
        return sum;
      }


      getAktiveKrediteForUserMonth(monthKey, userId) {
        const list = Array.isArray(this.kredite) ? this.kredite : [];
        return list.filter(k => {
          // Nur Kredite ber√ºcksichtigen, die im aktuellen Monat aktiv sind
          if (!this.isKreditAktivInMonth(k, monthKey)) return false;

          // Owner / Benutzer-Logik: nur privat vom User + "gemeinsam"
          const owner = k?.benutzer || k?.userId || k?.owner || null;
          if (owner !== userId && owner !== 'gemeinsam') return false;

          // "Aktiv" im Sinne der Kreditlogik (nicht abbezahlt)
          const details = this.calculateKreditDetails(k);
          return !details.isAbbezahlt;
        });
      }

      getGesamtKreditlastForUserMonth(monthKey, userId) {
        const aktive = this.getAktiveKrediteForUserMonth(monthKey, userId);
        const userIds = Object.keys(this.benutzer).filter(k => k !== 'gemeinsam');
        const nUsers = Math.max(1, userIds.length);

        let restschuld = 0;
        let monatlicheRate = 0;

        for (const k of aktive) {
          const details = this.calculateKreditDetails(k);
          const r = parseFloat(k?.rate);
          if (!isFinite(r) || r <= 0) continue;

          const owner = k?.benutzer || k?.userId || k?.owner || null;
          if (owner === 'gemeinsam') {
            restschuld += (details.restschuld / nUsers);
            monatlicheRate += (r / nUsers);
          } else {
            restschuld += details.restschuld;
            monatlicheRate += r;
          }
        }

        return { restschuld, monatlicheRate, anzahl: aktive.length };
      }

getGesamtKreditlast() {
        const aktive = this.getAktiveKredite();
        return {
          restschuld: aktive.reduce((sum, k) => sum + this.calculateKreditDetails(k).restschuld, 0),
          monatlicheRate: aktive.reduce((sum, k) => sum + k.rate, 0),
          anzahl: aktive.length
        };
      }
      
      addKredit(name, betrag, zinssatz, laufzeit, rate, startdatum, kategorie = 'Sonstiges', benutzer = 'ich', gesamtbetrag = null) {
        const id = Date.now();
        this.kredite.push({
          id,
          name,
          betrag: parseFloat(betrag),
          zinssatz: parseFloat(zinssatz),
          laufzeit: parseInt(laufzeit),
          rate: parseFloat(rate),
          startdatum,
          kategorie,
          benutzer,
          gesamtbetrag: gesamtbetrag ? parseFloat(gesamtbetrag) : null
        });
        this.saveData('kredite', this.kredite);
        this.markAsChanged();
        this.invalidateCache();
        this.render();
      }
      
      addKreditFromForm() {
        const name = document.getElementById('kreditName').value.trim();
        const betrag = document.getElementById('kreditBetrag').value;
        const zinssatz = document.getElementById('kreditZins').value;
        const laufzeit = document.getElementById('kreditLaufzeit').value;
        const rate = document.getElementById('kreditRate').value;
        const gesamtbetrag = document.getElementById('kreditGesamtbetrag').value;
        const startdatum = document.getElementById('kreditStart').value;
        const kategorie = document.getElementById('kreditKat').value;
        const benutzer = document.getElementById('kreditBenutzer').value;
        
        if (!name || !betrag || !laufzeit || !rate || !startdatum) {
          this.showRequiredFieldsModal();
          return;
        }
        
        this.addKredit(name, betrag, zinssatz || 0, laufzeit, rate, startdatum, kategorie, benutzer, gesamtbetrag || null);
        
        // Felder leeren
        document.getElementById('kreditName').value = '';
        document.getElementById('kreditBetrag').value = '';
        document.getElementById('kreditZins').value = '';
        document.getElementById('kreditLaufzeit').value = '';
        document.getElementById('kreditRate').value = '';
        document.getElementById('kreditGesamtbetrag').value = '';
        document.getElementById('kreditStart').value = new Date().toISOString().split('T')[0];
        
        // Entferne alte Details
        const oldDetails = document.getElementById('loanCalculationDetails');
        if (oldDetails) oldDetails.remove();
        
        this.showNotification('Kredit hinzugef√ºgt', 'success');
      }
      
      // Berechne Rate f√ºr Edit-Modal
      calculateRateFromEditModal() {
        const betrag = this.parseGermanNumber(document.getElementById('editKreditBetrag').value);
        const gesamtbetrag = this.parseGermanNumber(document.getElementById('editKreditGesamtbetrag').value);
        const zinssatz = this.parseGermanNumber(document.getElementById('editKreditZins').value);
        const laufzeit = parseInt(document.getElementById('editKreditLaufzeit').value) || 0;
        
        if (!laufzeit) {
          this.showNotification('Bitte Laufzeit eingeben', 'error');
          return;
        }
        
        let rate = 0;
        
        // Wenn Gesamtbetrag angegeben: einfache Division
        if (gesamtbetrag > 0) {
          rate = gesamtbetrag / laufzeit;
        }
        // Sonst: Annuit√§tenformel mit Kreditbetrag
        else if (betrag > 0) {
          rate = this.calculateMonthlyPayment(betrag, zinssatz, laufzeit);
        } else {
          this.showNotification('Bitte Kreditbetrag oder Gesamtbetrag eingeben', 'error');
          return;
        }
        
        document.getElementById('editKreditRate').value = rate.toFixed(2);
        
        this.showNotification('Rate berechnet: ' + this.formatCurrency(rate), 'success');
      }
      
      editKredit(id) {
        const kredit = this.kredite.find(k => k.id === id);
        if (!kredit) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        const kategorien = ['Auto', 'Immobilie', 'Konsumkredit', 'Bildung', 'Sonstiges'];
        
        modal.innerHTML = `
          <div class="modal-content" style="max-width:600px;">
            <h3 class="kpi-value text-[color:var(--text-primary)] mb-4">Kredit bearbeiten</h3>
            
            <div class="grid grid-cols-1 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                <input type="text" id="editKreditName" value="${kredit.name}" class="modal-input">
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Kreditbetrag (‚Ç¨)</label>
                  <input type="number" id="editKreditBetrag" value="${kredit.betrag}" step="0.01" class="modal-input">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Gesamtbetrag (‚Ç¨) - optional</label>
                  <input type="number" id="editKreditGesamtbetrag" value="${kredit.gesamtbetrag || ''}" step="0.01" class="modal-input">
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Zinssatz (%)</label>
                  <input type="number" id="editKreditZins" value="${kredit.zinssatz}" step="0.01" class="modal-input">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Laufzeit (Monate)</label>
                  <input type="number" id="editKreditLaufzeit" value="${kredit.laufzeit}" class="modal-input">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Monatliche Rate (‚Ç¨)</label>
                <div class="relative">
                  <input type="number" id="editKreditRate" value="${kredit.rate}" step="0.01" class="modal-input" style="padding-right: 40px;">
                  <button type="button" onclick="app.calculateRateFromEditModal()" class="input-icon absolute right-0 top-0 bottom-0 w-10 flex items-center justify-center transition-colors" style="pointer-events: auto;" title="Rate berechnen">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="4" y="2" width="16" height="20" rx="2"/>
                      <line x1="8" y1="6" x2="16" y2="6"/>
                      <line x1="16" y1="14" x2="16" y2="18"/>
                      <path d="M16 10h.01"/>
                      <path d="M12 10h.01"/>
                      <path d="M8 10h.01"/>
                      <path d="M12 14h.01"/>
                      <path d="M8 14h.01"/>
                      <path d="M12 18h.01"/>
                      <path d="M8 18h.01"/>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Startdatum</label>
                  <input type="date" id="editKreditStart" value="${kredit.startdatum}" class="modal-input" style="width: 100%; box-sizing: border-box;">
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Kategorie</label>
                  <select id="editKreditKat" class="modal-input">
                    ${kategorien.map(k => `<option value="${k}" ${k === kredit.kategorie ? 'selected' : ''}>${k}</option>`).join('')}
                  </select>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Benutzer</label>
                <select id="editKreditBenutzer" class="modal-input">
                  <option value="gemeinsam" ${kredit.benutzer === 'gemeinsam' ? 'selected' : ''}>Gemeinsam</option>
                  ${Object.values(this.benutzer).map(u => `
                    <option value="${u.id}" ${u.id === kredit.benutzer ? 'selected' : ''}>${u.emoji} ${u.name}</option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <div class="flex gap-3 mt-6">
              <button onclick="app.saveKreditEdit(${id})" class="flex-1 btn-primary">Speichern</button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 btn-secondary">Abbrechen</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }
      
      saveKreditEdit(id) {
        const kredit = this.kredite.find(k => k.id === id);
        if (!kredit) return;
        
        kredit.name = document.getElementById('editKreditName').value;
        kredit.betrag = parseFloat(document.getElementById('editKreditBetrag').value);
        kredit.zinssatz = parseFloat(document.getElementById('editKreditZins').value);
        kredit.laufzeit = parseInt(document.getElementById('editKreditLaufzeit').value);
        kredit.rate = parseFloat(document.getElementById('editKreditRate').value);
        kredit.startdatum = document.getElementById('editKreditStart').value;
        kredit.kategorie = document.getElementById('editKreditKat').value;
        kredit.benutzer = document.getElementById('editKreditBenutzer').value;
        
        const gesamtbetrag = document.getElementById('editKreditGesamtbetrag').value;
        kredit.gesamtbetrag = gesamtbetrag ? parseFloat(gesamtbetrag) : null;
        
        this.saveData('kredite', this.kredite);
        this.markAsChanged();
        this.invalidateCache();
        document.querySelector('.modal-overlay').remove();
        this.render();
        this.showNotification('Kredit aktualisiert', 'success');
      }
      
      deleteKredit(id) {
        const kredit = this.kredite.find(k => k.id === id);
        if (!kredit) return;
        
        const details = this.calculateKreditDetails(kredit);
        
        this.showModal(
          '‚ö†Ô∏è Kredit l√∂schen?',
          `M√∂chtest du diesen Kredit wirklich l√∂schen?\n\n${kredit.name}\nRestschuld: ${this.formatCurrency(details.restschuld)}\nMonatliche Rate: ${this.formatCurrency(kredit.rate)}`,
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            {
              text: 'L√∂schen',
              class: 'bg-red-500 text-white',
              callback: () => {
                this.kredite = this.kredite.filter(k => k.id !== id);
                this.saveData('kredite', this.kredite);
                this.markAsChanged();
                this.invalidateCache();
                this.render();
                this.showNotification('Kredit gel√∂scht', 'success');
              }
            }
          ]
        );
      }

      editVorlage(id) {
        const vorlage = this.ausgabenVorlagen.find(v => v.id === id);
        if (!vorlage) return;
        
        // Erstelle Modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.edit} <span>Vorlage bearbeiten</span></h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                <input type="text" id="editVorlName" value="${vorlage.name}" class="modal-input">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Betrag (‚Ç¨)</label>
                <input type="number" id="editVorlBetrag" value="${vorlage.betrag}" step="0.01" class="modal-input">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Kategorie</label>
                <select id="editVorlKat" class="modal-input">
                  ${this.kategorien.map(k => `<option value="${k}" ${k === vorlage.kategorie ? 'selected' : ''}>${k}</option>`).join('')}
                </select>
              </div>
              <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button onclick="app.saveVorlageEdit(${id}, '${vorlage.name}', ${vorlage.betrag}, '${vorlage.kategorie}')" class="flex-1 px-4 py-3 text-white rounded-lg font-semibold hover:shadow-lg transition-all" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);">
                  Speichern
                </button>
                <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-all">
                  Abbrechen
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Schlie√üen bei Klick au√üerhalb
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            try { modal._cleanupA11y?.(); } catch {}
        modal.remove();
          }
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      saveVorlageEdit(id, oldName, oldBetrag, oldKategorie) {
        const vorlage = this.ausgabenVorlagen.find(v => v.id === id);
        if (!vorlage) return;
        
        const newName = document.getElementById('editVorlName').value;
        const newBetrag = parseFloat(document.getElementById('editVorlBetrag').value);
        const newKategorie = document.getElementById('editVorlKat').value;
        
        if (!newName || !newBetrag || !newKategorie) {
          this.showNotification('‚ùå Bitte alle Felder ausf√ºllen!', 'error');
          return;
        }
        
        // Update Vorlage
        vorlage.name = newName;
        vorlage.betrag = newBetrag;
        vorlage.kategorie = newKategorie;
        
        // Update alle Ausgaben die diese Vorlage verwendet haben
        Object.keys(this.ausgabenAll).forEach(month => {
          this.ausgabenAll[month] = this.ausgabenAll[month].map(ausgabe => {
            if (ausgabe.name === oldName && 
              ausgabe.betrag === oldBetrag && 
              ausgabe.kategorie === oldKategorie &&
              ausgabe.vonVorlage === id) {
              return {
                ...ausgabe,
                name: newName,
                betrag: newBetrag,
                kategorie: newKategorie
              };
            }
            return ausgabe;
          });
        });
        
        this.saveData('ausgabenVorlagen', this.ausgabenVorlagen);
        this.saveData('ausgabenAll', this.ausgabenAll);
        
        // Schlie√üe Modal
        document.querySelector('.modal-overlay').remove();
        
        this.showNotification('‚úÖ Vorlage und alle zugeh√∂rigen Ausgaben wurden aktualisiert!', 'success');
        this.render();
      }

      deleteVorlage(id) {
        this.showModal('‚ö†Ô∏è Vorlage l√∂schen?', 'Die Vorlage wird gel√∂scht, aber bereits erstellte Ausgaben bleiben erhalten.', [
          { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
          { 
            text: 'L√∂schen', 
            class: 'btn-reset',
            callback: () => {
              this.ausgabenVorlagen = this.ausgabenVorlagen.filter(v => v.id !== id);
              this.saveData('ausgabenVorlagen', this.ausgabenVorlagen);
              this.showNotification('‚úÖ Vorlage gel√∂scht', 'success');
              this.render();
            }
          }
        ]);
      }

      useVorlage(vorlageId) {
        const vorlage = this.ausgabenVorlagen.find(v => v.id === vorlageId);
        if (!vorlage) return;
        
        // Best√§tigungs-Modal
        this.showModal(
          icons.fileText + ' Vorlage verwenden?',
          `M√∂chtest du diese Vorlage als Ausgabe f√ºr heute hinzuf√ºgen?\n\n${vorlage.name}\nKategorie: ${vorlage.kategorie}\nBetrag: ${this.formatCurrency(vorlage.betrag)}`,
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            {
              text: 'Verwenden',
              class: 'btn-upload',
              callback: () => {
                const heute = new Date().toISOString().split('T')[0];
                
                // F√ºge Ausgabe hinzu und markiere sie als von Vorlage
                const monthKey = heute.substring(0, 7);
                if (!this.ausgabenAll[monthKey]) {
                  this.ausgabenAll[monthKey] = [];
                }
                
                const id = Date.now();
                this.ausgabenAll[monthKey].push({
                  id,
                  datum: heute,
                  name: vorlage.name,
                  betrag: vorlage.betrag,
                  kategorie: vorlage.kategorie,
                  vonVorlage: vorlageId, // Markiere Herkunft
                  benutzer: this.aktiverBenutzer, // Zuordnung zum aktiven Benutzer
                  typ: 'privat' // Standardm√§√üig private Ausgabe
                });
                
                this.saveData('ausgabenAll', this.ausgabenAll);
                this.showNotification(`‚úÖ Ausgabe "${vorlage.name}" (${this.formatCurrency(vorlage.betrag)}) hinzugef√ºgt!`, 'success');
                this.render();
              }
            }
          ]
        );
      }

      getTop5Ausgaben(month) {
        const ausgaben = this.ausgabenAll[month] || [];
        return ausgaben
          .sort((a, b) => b.betrag - a.betrag)
          .slice(0, 5);
      }

      calculateYearPrognosis() {
        const now = new Date();
        const currentMonthIndex = now.getMonth(); // 0-11
        const currentYear = now.getFullYear();
        
        // Berechne Durchschnitt der bisherigen Monate
        let totalSaved = 0;
        let monthsCount = 0;
        
        for (let i = 0; i <= currentMonthIndex; i++) {
          const monthKey = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
          const stats = this.getMonthStats(monthKey);
          totalSaved += stats.verfuegbar;
          monthsCount++;
        }
        
        const avgPerMonth = totalSaved / monthsCount;
        const remainingMonths = 12 - currentMonthIndex - 1;
        const projectedTotal = totalSaved + (avgPerMonth * remainingMonths);
        
        return {
          currentSaved: totalSaved,
          avgPerMonth: avgPerMonth,
          projectedTotal: projectedTotal,
          remainingMonths: remainingMonths
        };
      }

      calculateYearStats(year) {
        let totalIncome = 0;
        let totalExpenses = 0;
        let totalSaved = 0;
        
        for (let i = 1; i <= 12; i++) {
          const monthKey = `${year}-${String(i).padStart(2, '0')}`;
          const stats = this.getMonthStats(monthKey);
          totalIncome += stats.gesamtEinkommen;
          totalExpenses += stats.gesamtAusgaben;
          totalSaved += stats.verfuegbar;
        }
        
        const avgSavingsRate = totalIncome > 0 ? (totalSaved / totalIncome * 100) : 0;
        
        return {
          totalIncome,
          totalExpenses,
          totalSaved,
          avgSavingsRate
        };
      }

      getDashboardStats() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = `${currentYear}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        const lastMonth = `${now.getMonth() === 0 ? currentYear - 1 : currentYear}-${String(now.getMonth() === 0 ? 12 : now.getMonth()).padStart(2, '0')}`;
        
        const currentStats = this.getMonthStats(currentMonth);
        const lastStats = this.getMonthStats(lastMonth);
        
        const yearlyStats = this.calculateYearStats(currentYear);
        const prognosis = this.calculateYearPrognosis();
        
        // Gesamtverm√∂gen (Sparkonten)
        const totalAssets = this.sparkonten.reduce((sum, k) => sum + k.aktuellerStand, 0);
        
        return {
          current: currentStats,
          last: lastStats,
          yearly: yearlyStats,
          prognosis: prognosis,
          totalAssets: totalAssets,
          ausgabenChange: lastStats.ausgaben > 0 ? ((currentStats.ausgaben - lastStats.ausgaben) / lastStats.ausgaben * 100) : 0,
          sparquoteChange: lastStats.gesamtEinkommen > 0 ? (((currentStats.verfuegbar / currentStats.gesamtEinkommen) - (lastStats.verfuegbar / lastStats.gesamtEinkommen)) * 100) : 0
        };
      }

      // Sparkonten-Funktionen
      addSparkonto(name, typ, ziel = 0, farbe = '#667eea', benutzer = null) {
        const id = Date.now();
        const owner = benutzer || this.aktiverBenutzer;
        
        // Teilnehmer als Array - kann mehrere Personen enthalten
        const teilnehmer = Array.isArray(owner) ? owner : [owner];
        
        this.sparkonten.push({
          id,
          name,
          typ,
          ziel,
          farbe,
          teilnehmer, // Array von User-IDs
          benutzer: teilnehmer[0], // Backwards compatibility - Hauptbesitzer
          erstelltAm: new Date().toISOString(),
          aktuellerStand: 0
        });
        this.kontobewegungen[id] = [];
        this.saveData('sparkonten', this.sparkonten);
        this.saveData('kontobewegungen', this.kontobewegungen);
        this.render();
      }

      editSparkonto(id) {
        const konto = this.sparkonten.find(k => k.id === id);
        if (!konto) return;
        
        // Erstelle Modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.edit} <span>Sparkonto bearbeiten</span></h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                <input type="text" id="editKontoName" value="${konto.name}" class="modal-input">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Typ</label>
                <select id="editKontoTyp" class="modal-input">
                  <option value="Sparen" ${konto.typ === 'Sparen' ? 'selected' : ''}>${this.getCurrentCurrencyIcon()} Sparen</option>
                  <option value="ETF" ${konto.typ === 'ETF' ? 'selected' : ''}>${icons.trendingUp} ETF</option>
                  <option value="Aktien" ${konto.typ === 'Aktien' ? 'selected' : ''}>${icons.barChart} Aktien</option>
                  <option value="Festgeld" ${konto.typ === 'Festgeld' ? 'selected' : ''}>${icons.bank} Festgeld</option>
                  <option value="Tagesgeld" ${konto.typ === 'Tagesgeld' ? 'selected' : ''}>${icons.creditCard} Tagesgeld</option>
                  <option value="Krypto" ${konto.typ === 'Krypto' ? 'selected' : ''}>‚Çø Krypto</option>
                  <option value="Sonstiges" ${konto.typ === 'Sonstiges' ? 'selected' : ''}>Sonstiges</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Sparziel (‚Ç¨, 0 f√ºr kein Ziel)</label>
                <input type="number" id="editKontoZiel" value="${konto.ziel}" step="100" class="modal-input">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Farbe</label>
                <div class="flex gap-2 items-center">
                  <input type="color" id="editKontoFarbe" value="${konto.farbe}">
                  <input type="text" id="editKontoFarbeText" value="${konto.farbe}" class="flex-1 modal-input" placeholder="#667eea">
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Teilnehmer</label>
                <div class="space-y-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                  ${Object.values(this.benutzer).map(u => {
                    const teilnehmer = konto.teilnehmer || (konto.benutzer ? [konto.benutzer] : []);
                    const isChecked = teilnehmer.includes(u.id);
                    return `
                      <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="editKontoTeilnehmer" value="${u.id}" ${isChecked ? 'checked' : ''}>
                        <span class="text-sm">${u.emoji} ${u.name}</span>
                      </label>
                    `;
                  }).join('')}
                </div>
              </div>
              <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button onclick="app.saveKontoEdit(${id})" class="btn-save flex-1 px-4 py-3">
                  Speichern
                </button>
                <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-all">
                  Abbrechen
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Sync Color Picker mit Text Input
        const colorPicker = modal.querySelector('#editKontoFarbe');
        const colorText = modal.querySelector('#editKontoFarbeText');
        
        colorPicker.addEventListener('input', (e) => {
          colorText.value = e.target.value;
        });
        
        colorText.addEventListener('input', (e) => {
          if (e.target.value.match(/^#[0-9A-Fa-f]{6}$/)) {
            colorPicker.value = e.target.value;
          }
        });
        
        // Schlie√üen bei Klick au√üerhalb
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            try { modal._cleanupA11y?.(); } catch {}
        modal.remove();
          }
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      saveKontoEdit(id) {
        const konto = this.sparkonten.find(k => k.id === id);
        if (!konto) return;
        
        const newName = document.getElementById('editKontoName').value;
        const newTyp = document.getElementById('editKontoTyp').value;
        const newZiel = parseFloat(document.getElementById('editKontoZiel').value) || 0;
        const newFarbe = document.getElementById('editKontoFarbeText').value;
        
        // Lese alle ausgew√§hlten Teilnehmer
        const checkboxes = document.querySelectorAll('input[name="editKontoTeilnehmer"]:checked');
        const newTeilnehmer = Array.from(checkboxes).map(cb => cb.value);
        
        if (!newName || !newTyp || !newFarbe) {
          this.showNotification('‚ùå Bitte alle Felder ausf√ºllen!', 'error');
          return;
        }
        
        if (newTeilnehmer.length === 0) {
          this.showRequiredFieldsModal();
          return;
        }
        
        // Update Konto
        konto.name = newName;
        konto.typ = newTyp;
        konto.ziel = newZiel;
        konto.farbe = newFarbe;
        konto.teilnehmer = newTeilnehmer;
        konto.benutzer = newTeilnehmer[0]; // Backwards compatibility
        
        this.saveData('sparkonten', this.sparkonten);
        
        // Schlie√üe Modal
        document.querySelector('.modal-overlay').remove();
        
        this.showNotification('‚úÖ Sparkonto aktualisiert!', 'success');
        this.render();
      }

      deleteSparkonto(id) {
        const konto = this.sparkonten.find(k => k.id === id);
        if (!konto) return;
        
        const bewegungenCount = (this.kontobewegungen[id] || []).length;
        const sparratenCount = this.sparraten.filter(r => r.kontoId === id).length;
        
        this.showModal(
          '‚ö†Ô∏è Sparkonto l√∂schen?',
          `M√∂chtest du dieses Sparkonto wirklich l√∂schen?\n\n${konto.name} (${konto.typ})\nAktueller Stand: ${this.formatCurrency(konto.aktuellerStand)}\n\n‚ö†Ô∏è Es werden auch gel√∂scht:\n‚Ä¢ ${bewegungenCount} Bewegung(en)\n‚Ä¢ ${sparratenCount} Sparrate(n)`,
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            {
              text: 'L√∂schen',
              class: 'bg-red-500 text-white',
              callback: () => {
                this.sparkonten = this.sparkonten.filter(k => k.id !== id);
                delete this.kontobewegungen[id];
                this.sparraten = this.sparraten.filter(r => r.kontoId !== id);
                this.saveData('sparkonten', this.sparkonten);
                this.saveData('kontobewegungen', this.kontobewegungen);
                this.saveData('sparraten', this.sparraten);
                this.invalidateCache();
                this.render();
                this.showNotification('Sparkonto gel√∂scht', 'success');
              }
            }
          ]
        );
      }

      addSparrate(kontoId, betrag, intervall = 'monatlich', startDatum = null, benutzer = null) {
        const id = Date.now();
        const owner = benutzer || this.aktiverBenutzer;
        this.sparraten.push({
          id,
          kontoId,
          betrag: parseAmount(betrag),
          intervall,
          startDatum: startDatum || new Date().toISOString().split('T')[0],
          benutzer: owner,
          aktiv: true
        });
        this.saveData('sparraten', this.sparraten);
        this.render();
      }

      editSparrate(id) {
        const rate = this.sparraten.find(r => r.id === id);
        if (!rate) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.edit} <span>Sparrate bearbeiten</span></h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Betrag (‚Ç¨)</label>
                <input type="number" step="0.01" id="editSparrateBetrag" value="${rate.betrag}" class="modal-input" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Intervall</label>
                <select id="editSparrateIntervall" class="modal-input">
                  <option value="monatlich" ${rate.intervall === 'monatlich' ? 'selected' : ''}>Monatlich</option>
                  <option value="viertelj√§hrlich" ${rate.intervall === 'viertelj√§hrlich' ? 'selected' : ''}>Viertelj√§hrlich</option>
                  <option value="j√§hrlich" ${rate.intervall === 'j√§hrlich' ? 'selected' : ''}>J√§hrlich</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Person</label>
                <select id="editSparrateBenutzer" class="modal-input">
                  ${Object.values(this.benutzer).map(u => `
                    <option value="${u.id}" ${u.id === rate.benutzer ? 'selected' : ''}>
                      ${u.emoji} ${u.name}
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
              <button onclick="app.saveEditedSparrate(${id})" class="btn-save flex-1 px-4 py-3">
                Speichern
              </button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">
                Abbrechen
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      saveEditedSparrate(id) {
        const betrag = parseFloat(document.getElementById('editSparrateBetrag').value);
        const intervall = document.getElementById('editSparrateIntervall').value;
        const benutzer = document.getElementById('editSparrateBenutzer').value;
        
        if (!betrag || isNaN(betrag) || betrag <= 0) {
          this.showNotification('‚ùå Bitte einen g√ºltigen Betrag eingeben!', 'error');
          return;
        }
        
        const rateIndex = this.sparraten.findIndex(r => r.id === id);
        if (rateIndex !== -1) {
          this.sparraten[rateIndex] = {
            ...this.sparraten[rateIndex],
            betrag,
            intervall,
            benutzer
          };
          
          this.saveData('sparraten', this.sparraten);
          this.showNotification('‚úÖ Sparrate aktualisiert!', 'success');
          document.querySelector('.modal-overlay').remove();
          this.render();
        } else {
          this.showNotification('‚ùå Sparrate nicht gefunden!', 'error');
        }
      }

      deleteSparrate(id) {
        const rate = this.sparraten.find(r => r.id === id);
        if (!rate) return;
        
        const konto = this.sparkonten.find(k => k.id === rate.kontoId);
        const kontoName = konto ? konto.name : 'Unbekanntes Konto';
        const benutzerInfo = rate.benutzer && this.benutzer[rate.benutzer] 
          ? `${this.benutzer[rate.benutzer].emoji} ${this.benutzer[rate.benutzer].name}` 
          : '';
        
        this.showModal(
          '‚ö†Ô∏è Sparrate l√∂schen?',
          `M√∂chtest du diese Sparrate wirklich l√∂schen?\n\n${this.formatCurrency(rate.betrag)} ${rate.intervall}\nKonto: ${kontoName}${benutzerInfo ? '\nBenutzer: ' + benutzerInfo : ''}`,
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            {
              text: 'L√∂schen',
              class: 'bg-red-500 text-white',
              callback: () => {
                this.sparraten = this.sparraten.filter(r => r.id !== id);
                this.saveData('sparraten', this.sparraten);
                this.invalidateCache();
                this.render();
                this.showNotification('Sparrate gel√∂scht', 'success');
              }
            }
          ]
        );
      }

      addKontobewegung(kontoId, datum, betrag, typ, beschreibung = '') {
        if (!this.kontobewegungen[kontoId]) {
          this.kontobewegungen[kontoId] = [];
        }
        
        const bewegung = {
          id: Date.now(),
          datum,
          betrag: parseAmount(betrag),
          typ,
          beschreibung
        };
        
        this.kontobewegungen[kontoId].push(bewegung);
        this.updateKontostand(kontoId);
        this.saveData('kontobewegungen', this.kontobewegungen);
        this.render();
      }

      deleteKontobewegung(kontoId, bewegungId) {
        if (!this.kontobewegungen[kontoId]) return;
        
        const bewegung = this.kontobewegungen[kontoId].find(b => b.id === bewegungId);
        if (!bewegung) return;
        
        const konto = this.sparkonten.find(k => k.id === kontoId);
        const kontoName = konto ? konto.name : 'Unbekanntes Konto';
        const typText = bewegung.typ === 'einzahlung' ? '‚Üë Einzahlung' : '‚Üì Auszahlung';
        
        this.showModal(
          '‚ö†Ô∏è Bewegung l√∂schen?',
          `M√∂chtest du diese Bewegung wirklich l√∂schen?\n\n${typText}: ${this.formatCurrency(bewegung.betrag)}\nKonto: ${kontoName}\nDatum: ${this.formatDate(bewegung.datum)}${bewegung.beschreibung ? '\nBeschreibung: ' + bewegung.beschreibung : ''}`,
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            {
              text: 'L√∂schen',
              class: 'bg-red-500 text-white',
              callback: () => {
                this.kontobewegungen[kontoId] = this.kontobewegungen[kontoId].filter(b => b.id !== bewegungId);
                this.updateKontostand(kontoId);
                this.saveData('kontobewegungen', this.kontobewegungen);
                this.invalidateCache();
                this.render();
                this.showNotification('Bewegung gel√∂scht', 'success');
              }
            }
          ]
        );
      }

      updateKontostand(kontoId) {
        const konto = this.sparkonten.find(k => k.id === kontoId);
        if (!konto) return;
        
        const bewegungen = this.kontobewegungen[kontoId] || [];
        let stand = 0;
        
        bewegungen.forEach(b => {
          if (b.typ === 'einzahlung') {
            stand += b.betrag;
          } else {
            stand -= b.betrag;
          }
        });
        
        konto.aktuellerStand = stand;
        this.saveData('sparkonten', this.sparkonten);
      }

      getMonatlicheSparraten() {
        let summe = 0;
        this.sparraten.forEach(rate => {
          if (!rate.aktiv) return;
          
          if (rate.intervall === 'monatlich') {
            summe += rate.betrag;
          } else if (rate.intervall === 'viertelj√§hrlich') {
            summe += rate.betrag / 3;
          } else if (rate.intervall === 'j√§hrlich') {
            summe += rate.betrag / 12;
          }
        });
        return summe;
      }

      changeMonth(delta) {
        const [year, month] = this.currentMonth.split('-').map(Number);
        const date = new Date(year, month - 1 + delta, 1);
        this.currentMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        this.currentYear = date.getFullYear();
        this.saveData('currentMonth', this.currentMonth);
        this.render();
      }

      changeYear(delta) {
        this.currentYear += delta;
        this.currentMonth = `${this.currentYear}-${this.currentMonth.split('-')[1]}`;
        this.saveData('currentMonth', this.currentMonth);
        this.render();
      }

      setTab(tab) {
        this.activeTab = tab;
        this.render();
      }

      addFixkosten(name, betrag, kategorie, benutzer = 'gemeinsam', intervall = 'monatlich') {
        const id = this.fixkosten.length > 0 ? Math.max(...this.fixkosten.map(f => f.id)) + 1 : 1;
        this.fixkosten.push({ 
          id, 
          name, 
          betrag: parseAmount(betrag), 
          kategorie,
          benutzer,
          intervall,
          typ: benutzer === 'gemeinsam' ? 'gemeinsam' : 'privat'
        });
        this.saveData('fixkosten', this.fixkosten);
        this.markAsChanged();
        this.render();
      }

      editFixkosten(id) {
        const fixkost = this.fixkosten.find(f => f.id === id);
        if (!fixkost) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.edit} <span>Fixkosten bearbeiten</span></h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Name</label>
                <input type="text" id="editFixName" value="${fixkost.name}" class="modal-input" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Betrag (‚Ç¨)</label>
                <input type="number" step="0.01" id="editFixBetrag" value="${fixkost.betrag}" class="modal-input" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Kategorie</label>
                <select id="editFixKat" class="modal-input">
                  ${this.kategorien.map(k => `
                    <option value="${k}" ${k === fixkost.kategorie ? 'selected' : ''}>${k}</option>
                  `).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Intervall</label>
                <select id="editFixIntervall" class="modal-input">
                  <option value="monatlich" ${(fixkost.intervall || 'monatlich') === 'monatlich' ? 'selected' : ''}>Monatlich</option>
                  <option value="viertelj√§hrlich" ${fixkost.intervall === 'viertelj√§hrlich' ? 'selected' : ''}>Viertelj√§hrlich</option>
                  <option value="halbj√§hrlich" ${fixkost.intervall === 'halbj√§hrlich' ? 'selected' : ''}>Halbj√§hrlich</option>
                  <option value="j√§hrlich" ${fixkost.intervall === 'j√§hrlich' ? 'selected' : ''}>J√§hrlich</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Person</label>
                <select id="editFixBenutzer" class="modal-input">
                  <option value="gemeinsam" ${fixkost.benutzer === 'gemeinsam' ? 'selected' : ''}>${icons.users} Gemeinsam</option>
                  ${Object.values(this.benutzer).map(u => `
                    <option value="${u.id}" ${u.id === fixkost.benutzer ? 'selected' : ''}>
                      ${u.emoji} ${u.name}
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
              <button onclick="app.saveEditedFixkosten(${id})" class="flex-1 px-4 py-3 text-white rounded-lg font-semibold" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                Speichern
              </button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">
                Abbrechen
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      saveEditedFixkosten(id) {
        const name = document.getElementById('editFixName').value.trim();
        const betrag = parseFloat(document.getElementById('editFixBetrag').value);
        const kategorie = document.getElementById('editFixKat').value;
        const intervall = document.getElementById('editFixIntervall')?.value || 'monatlich';
        const benutzer = document.getElementById('editFixBenutzer').value;
        
        if (!name || !betrag || isNaN(betrag)) {
          this.showNotification('‚ùå Bitte alle Felder ausf√ºllen!', 'error');
          return;
        }
        
        const fixkostIndex = this.fixkosten.findIndex(f => f.id === id);
        if (fixkostIndex !== -1) {
          this.fixkosten[fixkostIndex] = {
            ...this.fixkosten[fixkostIndex],
            name,
            betrag,
            kategorie,
            intervall,
            benutzer,
            typ: benutzer === 'gemeinsam' ? 'gemeinsam' : 'privat'
          };
          
          this.saveData('fixkosten', this.fixkosten);
          this.showNotification('‚úÖ Fixkosten aktualisiert!', 'success');
          document.querySelector('.modal-overlay').remove();
          this.render();
        } else {
          this.showNotification('‚ùå Fixkosten nicht gefunden!', 'error');
        }
      }

      deleteFixkosten(id) {
        // Finde die Fixkosten f√ºr die Anzeige
        const fixkost = this.fixkosten.find(f => f.id === id);
        if (!fixkost) return;
        
        this.showModal(
          '‚ö†Ô∏è Fixkosten l√∂schen?', 
          `M√∂chtest du diese Fixkosten wirklich l√∂schen?\n\n${fixkost.name}\n${this.formatCurrency(fixkost.betrag)} pro Monat`, 
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            { 
              text: 'L√∂schen', 
              class: 'btn-reset',
              callback: () => {
                this.fixkosten = this.fixkosten.filter(f => f.id !== id);
                this.saveData('fixkosten', this.fixkosten);
                this.showNotification('‚úÖ Fixkosten gel√∂scht', 'success');
                this.render();
              }
            }
          ]
        );
      }

      addAusgabe(datum, name, betrag, kategorie, benutzer = null) {
        const month = datum.substring(0, 7);
        name = sanitizeText(name, 120);
        kategorie = sanitizeText(kategorie, 40);
        if (!this.ausgabenAll[month]) this.ausgabenAll[month] = [];
        
        const id = Date.now();
        const ausgabe = { 
          id, 
          datum, 
          name, 
          betrag: parseAmount(betrag), 
          kategorie,
          benutzer: benutzer || this.aktiverBenutzer, // üë• Aktueller User als Default
          typ: benutzer === 'gemeinsam' ? 'gemeinsam' : 'privat'
        };
        
        this.ausgabenAll[month].push(ausgabe);
        this.saveData('ausgabenAll', this.ausgabenAll);
        this.render();
      }

      editAusgabe(month, id) {
        const ausgabe = this.ausgabenAll[month]?.find(a => a.id === id);
        if (!ausgabe) return;
        
        // Erstelle Modal mit Formular
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.edit} <span>Ausgabe bearbeiten</span></h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Datum</label>
                <input type="date" id="editAusgDatum" value="${h(ausgabe.datum)}" class="modal-input" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Beschreibung</label>
                <input type="text" id="editAusgName" value="${h(ausgabe.name)}" class="modal-input" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Betrag (‚Ç¨)</label>
                <input type="number" step="0.01" id="editAusgBetrag" value="${h(ausgabe.betrag)}" class="modal-input" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Kategorie</label>
                <select id="editAusgKat" class="modal-input">
                  ${this.kategorien.map(k => `
                    <option value="${k}" ${k === ausgabe.kategorie ? 'selected' : ''}>${k}</option>
                  `).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Person</label>
                <select id="editAusgBenutzer" class="modal-input">
                  ${Object.values(this.benutzer).map(u => `
                    <option value="${u.id}" ${u.id === ausgabe.benutzer ? 'selected' : ''}>
                      ${u.emoji} ${u.name}
                    </option>
                  `).join('')}
                </select>
              </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
              <button onclick="app.saveEditedAusgabe('${month}', ${id})" class="flex-1 px-4 py-3 text-white rounded-lg font-semibold" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                Speichern
              </button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">
                Abbrechen
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      saveEditedAusgabe(month, id) {
        const datum = document.getElementById('editAusgDatum').value;
        const name = document.getElementById('editAusgName').value.trim();
        const betrag = parseFloat(document.getElementById('editAusgBetrag').value);
        const kategorie = document.getElementById('editAusgKat').value;
        const benutzer = document.getElementById('editAusgBenutzer').value;
        
        if (!datum || !name || !betrag || isNaN(betrag)) {
          this.showNotification('‚ùå Bitte alle Felder ausf√ºllen!', 'error');
          return;
        }
        
        // Finde die Ausgabe und aktualisiere sie
        const ausgabeIndex = this.ausgabenAll[month]?.findIndex(a => a.id === id);
        if (ausgabeIndex !== -1) {
          this.ausgabenAll[month][ausgabeIndex] = {
            ...this.ausgabenAll[month][ausgabeIndex],
            datum,
            name,
            betrag,
            kategorie,
            benutzer,
            typ: benutzer === 'gemeinsam' ? 'gemeinsam' : 'privat'
          };
          
          this.saveData('ausgabenAll', this.ausgabenAll);
          this.showNotification('‚úÖ Ausgabe aktualisiert!', 'success');
          document.querySelector('.modal-overlay').remove();
          this.render();
        } else {
          this.showNotification('‚ùå Ausgabe nicht gefunden!', 'error');
        }
      }

      deleteAusgabe(month, id) {
        // Finde die Ausgabe f√ºr die Anzeige im Best√§tigungsdialog
        const ausgabe = this.ausgabenAll[month]?.find(a => a.id === id);
        if (!ausgabe) return;
        
        const ausgabeInfo = `${ausgabe.name} (${this.formatCurrency(ausgabe.betrag)})`;
        
        this.showModal(
          '‚ö†Ô∏è Ausgabe l√∂schen?', 
          `M√∂chtest du diese Ausgabe wirklich l√∂schen?\n\n${ausgabeInfo}\nKategorie: ${ausgabe.kategorie}\nDatum: ${ausgabe.datum}`, 
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            { 
              text: 'L√∂schen', 
              class: 'btn-reset',
              callback: () => {
                if (this.ausgabenAll[month]) {
                  this.ausgabenAll[month] = this.ausgabenAll[month].filter(a => a.id !== id);
                  this.saveData('ausgabenAll', this.ausgabenAll);
                  this.showNotification('‚úÖ Ausgabe gel√∂scht', 'success');
                  this.render();
                }
              }
            }
          ]
        );
      }

      addZusatzeinkommen(datum, name, betrag) {
        const month = datum.substring(0, 7);
        name = sanitizeText(name, 120);
        if (!this.zusatzeinkommenAll[month]) this.zusatzeinkommenAll[month] = [];
        
        const id = Date.now();
        this.zusatzeinkommenAll[month].push({ id, datum, name, betrag: parseAmount(betrag) });
        this.saveData('zusatzeinkommenAll', this.zusatzeinkommenAll);
        this.render();
      }

      deleteZusatzeinkommen(month, id) {
        // Finde das Zusatzeinkommen f√ºr die Anzeige
        const zusatz = this.zusatzeinkommenAll[month]?.find(z => z.id === id);
        if (!zusatz) return;
        
        this.showModal(
          '‚ö†Ô∏è Zusatzeinkommen l√∂schen?', 
          `M√∂chtest du dieses Zusatzeinkommen wirklich l√∂schen?\n\n${zusatz.name}\n${zusatthis.formatCurrency(z.betrag)}\nDatum: ${zusatz.datum}`, 
          [
            { text: 'Abbrechen', class: 'bg-gray-300 text-gray-700' },
            { 
              text: 'L√∂schen', 
              class: 'btn-reset',
              callback: () => {
                if (this.zusatzeinkommenAll[month]) {
                  this.zusatzeinkommenAll[month] = this.zusatzeinkommenAll[month].filter(z => z.id !== id);
                  this.saveData('zusatzeinkommenAll', this.zusatzeinkommenAll);
                  this.showNotification('‚úÖ Zusatzeinkommen gel√∂scht', 'success');
                  this.render();
                }
              }
            }
          ]
        );
      }

      setEinkommen(month, betrag, userId = null) {
        // Verwende aktiven User wenn kein userId angegeben
        const targetUser = userId || this.aktiverBenutzer;
        
        dlog('setEinkommen called:', { month, betrag, userId, targetUser });
        
        // Validiere Betrag
        const betragNum = parseFloat(betrag);
        if (isNaN(betragNum) || betragNum < 0) {
          console.error('Invalid betrag:', betrag, betragNum);
          this.showNotification('‚ùå Bitte einen g√ºltigen Betrag eingeben!', 'error');
          return;
        }
        
        // KRITISCH: Stelle sicher dass einkommenAll[month] ein Object ist, keine Zahl!
        if (typeof this.einkommenAll[month] === 'number') {
          console.warn('‚ö†Ô∏è einkommenAll[month] war eine Zahl, konvertiere zu Object');
          const oldValue = this.einkommenAll[month];
          this.einkommenAll[month] = {
            'ich': oldValue
          };
        }
        
        // Initialisiere month object falls nicht vorhanden
        if (!this.einkommenAll[month]) {
          this.einkommenAll[month] = {};
        }
        
        // SICHERHEITSCHECK: Falls es immer noch keine Object ist, zwinge es
        if (typeof this.einkommenAll[month] !== 'object' || Array.isArray(this.einkommenAll[month])) {
          console.error('einkommenAll[month] ist kein Object!', typeof this.einkommenAll[month]);
          this.einkommenAll[month] = {};
        }
        
        // Setze Einkommen f√ºr spezifischen User
        this.einkommenAll[month][targetUser] = betragNum;
        dlog('Einkommen gesetzt:', this.einkommenAll[month]);
        
        this.saveData('einkommenAll', this.einkommenAll);
        
        // Erfolgs-Benachrichtigung
        const userName = this.benutzer[targetUser]?.name || targetUser;
        this.showNotification(`‚úÖ Einkommen f√ºr ${userName} gespeichert: ${this.formatCurrency(betragNum)}`, 'success');
        
        this.render();
      }

      saveUserEinkommen(userId) {
        try {
          const inputId = 'einkommen_' + userId;
          const inputElement = document.getElementById(inputId);
          
          if (!inputElement) {
            console.error('Input-Feld nicht gefunden:', inputId);
            this.showNotification('‚ùå Fehler: Input-Feld nicht gefunden!', 'error');
            return;
          }
          
          const betrag = inputElement.value;
          
          if (!betrag || betrag === '') {
            this.showNotification('‚ùå Bitte einen Betrag eingeben!', 'error');
            return;
          }
          
          this.setEinkommen(this.currentMonth, betrag, userId);
        } catch (error) {
          console.error('Fehler in saveUserEinkommen:', error);
          this.showNotification('‚ùå Fehler beim Speichern: ' + error.message, 'error');
        }
      }

      saveStandardEinkommen(userId) {
        const betrag = parseFloat(document.getElementById(`standard_einkommen_${userId}`).value) || 0;
        
        if (!this.standardEinkommen) {
          this.standardEinkommen = {};
        }
        
        this.standardEinkommen[userId] = betrag;
        this.saveData('standardEinkommen', this.standardEinkommen);
        
        this.showNotification(`‚úÖ Standard-Einkommen f√ºr ${this.benutzer[userId].name} gespeichert!`, 'success');
      }

      editMonthEinkommen(userId) {
        const user = this.benutzer[userId];
        if (!user) return;
        
        const einkommenMonth = this.einkommenAll[this.currentMonth] || {};
        const currentEinkommen = einkommenMonth[userId] || this.standardEinkommen?.[userId] || 0;
        const isStandard = !einkommenMonth[userId] && this.standardEinkommen?.[userId];
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <h3 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.briefcase} <span>Einkommen bearbeiten</span></h3>
            <div class="space-y-4">
              <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-blue-200">
                <span style="font-size: 24px;">${user.emoji}</span>
                <div>
                  <div class="font-semibold text-[color:var(--text-primary)]">${user.name}</div>
                  <div class="kpi-sub text-[color:var(--text-tertiary)]">
                    ${isStandard ? `Standard-Einkommen: ${this.formatCurrency(this.standardEinkommen[userId])}` : 'Individuelles Einkommen f√ºr diesen Monat'}
                  </div>
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                  Einkommen f√ºr ${new Date(this.currentMonth + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })}
                </label>
                <input type="number" 
                    step="0.01" 
                    id="editMonthEinkommenBetrag" 
                    value="${currentEinkommen}" 
                    class="modal-input"
                    placeholder="${this.standardEinkommen?.[userId] || '0.00'}" />
                <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">
                  Leer lassen um Standard-Einkommen zu verwenden
                </div>
              </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
              <button onclick="app.saveEditedMonthEinkommen('${userId}')" class="btn-save flex-1 px-4 py-3">
                Speichern
              </button>
              <button onclick="document.querySelector('.modal-overlay').remove()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">
                Abbrechen
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      saveEditedMonthEinkommen(userId) {
        const betrag = document.getElementById('editMonthEinkommenBetrag').value;
        
        if (betrag && betrag !== '') {
          this.setEinkommen(this.currentMonth, parseFloat(betrag), userId);
          this.showNotification(`‚úÖ Einkommen f√ºr ${this.benutzer[userId].name} gespeichert!`, 'success');
        } else {
          // Leer = Standard verwenden, also Eintrag l√∂schen
          if (this.einkommenAll[this.currentMonth]) {
            delete this.einkommenAll[this.currentMonth][userId];
            this.saveData('einkommenAll', this.einkommenAll);
          }
          this.showNotification(`‚úÖ Standard-Einkommen wird verwendet!`, 'success');
        }
        
        document.querySelector('.modal-overlay').remove();
        this.render();
      }

      resetToStandardEinkommen(userId) {
        const user = this.benutzer[userId];
        const standardBetrag = this.standardEinkommen?.[userId];
        
        if (!standardBetrag) {
          this.showNotification('‚ö†Ô∏è Kein Standard-Einkommen festgelegt!', 'error');
          return;
        }
        
        // L√∂sche individuelles Einkommen f√ºr diesen Monat
        if (this.einkommenAll[this.currentMonth]) {
          delete this.einkommenAll[this.currentMonth][userId];
          this.saveData('einkommenAll', this.einkommenAll);
        }
        
        this.showNotification(`üîÑ ${user.name} verwendet jetzt Standard-Einkommen (${this.formatCurrency(standardBetrag)})`, 'success');
        this.render();
      }

      getMonthStats(month) {
        // üöÄ PERFORMANCE: Cache Check
        const cacheKey = `stats_${month}`;
        const cached = this.getCached('stats', cacheKey);
        if (cached) return cached;
        
        
        // Helper: Fixkosten-Intervalle auf monatlich umrechnen (f√ºr konsistente Statistik)
        const toMonthlyFix = (betrag, intervall) => {
          switch (intervall) {
            case 'viertelj√§hrlich': return betrag / 3;
            case 'halbj√§hrlich': return betrag / 6;
            case 'j√§hrlich': return betrag / 12;
            default: return betrag; // monatlich
          }
        };

// Summiere Einkommen aller User f√ºr diesen Monat
        // Verwende Standard-Einkommen als Fallback
        const einkommenMonth = this.einkommenAll[month] || {};
        
        let einkommen = 0;
        Object.keys(this.benutzer).forEach(userId => {
          // Nutze gespeichertes Einkommen oder Standard-Einkommen
          const userEinkommen = einkommenMonth[userId] || this.standardEinkommen?.[userId] || 0;
          einkommen += userEinkommen;
        });
        
        const zusatzeinkommen = (this.zusatzeinkommenAll[month] || []).reduce((sum, z) => sum + z.betrag, 0);
        const ausgaben = (this.ausgabenAll[month] || []).reduce((sum, a) => sum + a.betrag, 0);
        const fixkosten = this.fixkosten.reduce((sum, f) => sum + toMonthlyFix(f.betrag, f.intervall || 'monatlich'), 0);
        const sparraten = this.getMonatlicheSparraten();
        
        // Berechne Kreditraten f√ºr diesen Monat (nur innerhalb der Laufzeit)
        const kreditraten = this.getKreditratenForMonth(month);
const gesamtEinkommen = einkommen + zusatzeinkommen;
        const gesamtAusgaben = ausgaben + fixkosten + sparraten + kreditraten;
        const verfuegbar = gesamtEinkommen - gesamtAusgaben;
        
        const result = { einkommen, zusatzeinkommen, ausgaben, fixkosten, sparraten, kreditraten, gesamtEinkommen, gesamtAusgaben, verfuegbar };
        
        // üöÄ PERFORMANCE: In Cache speichern
        this.setCached('stats', cacheKey, result);
        
        return result;
      }

      getYearlyStats() {
        const months = [];
        const einkommenData = [];
        const ausgabenData = [];
        const sparquoteData = [];
        const fixkostenData = [];
        const sparratenData = [];
        const kreditratenData = [];
        const categoryTotals = {};
        
        let totalEinkommen = 0;
        let totalZusatzeinkommen = 0;
        let totalFixkosten = 0;
        let totalAusgaben = 0;
        let totalSparraten = 0;
        let totalKreditraten = 0;
        
        for (let i = 1; i <= 12; i++) {
          const month = `${this.currentYear}-${String(i).padStart(2, '0')}`;
          const stats = this.getMonthStats(month);
          
          months.push(new Date(this.currentYear, i - 1).toLocaleDateString('de-DE', { month: 'short' }));
          einkommenData.push(stats.gesamtEinkommen);
          ausgabenData.push(stats.gesamtAusgaben);
          fixkostenData.push(stats.fixkosten);
          sparratenData.push(stats.sparraten);
          kreditratenData.push(stats.kreditraten || 0);
          
          const sparquote = stats.gesamtEinkommen > 0 ? (stats.verfuegbar / stats.gesamtEinkommen) * 100 : 0;
          sparquoteData.push(sparquote);
          
          totalEinkommen += stats.einkommen;
          totalZusatzeinkommen += stats.zusatzeinkommen;
          totalFixkosten += stats.fixkosten;
          totalAusgaben += stats.ausgaben;
          totalSparraten += stats.sparraten;
          totalKreditraten += (stats.kreditraten || 0);
          
          const ausgaben = this.ausgabenAll[month] || [];
          ausgaben.forEach(a => {
            categoryTotals[a.kategorie] = (categoryTotals[a.kategorie] || 0) + a.betrag;
          });
        }
        
        const totalVerfuegbar = (totalEinkommen + totalZusatzeinkommen) - (totalFixkosten + totalAusgaben + totalSparraten + totalKreditraten);
        
        return {
          months,
          einkommenData,
          ausgabenData,
          sparquoteData,
          fixkostenData,
          sparratenData,
          kreditratenData,
          categoryTotals,
          totalEinkommen,
          totalZusatzeinkommen,
          totalFixkosten,
          totalAusgaben,
          totalSparraten,
          totalKreditraten,
          totalVerfuegbar
        };
      }

      
      exportToCSV() {
        const keys = [
          'fixkosten',
          'ausgabenAll',
          'einkommenAll',
          'zusatzeinkommenAll',
          'sparkonten',
          'sparraten',
          'kontobewegungen',
          'kredite',
          'ausgabenVorlagen',
          'haushalt',
          'benutzer',
          'aktiverBenutzer',
          'standardEinkommen',
          'currentMonth'
        ];

        const meta = {
          app: 'wallit',
          format: 'wallit-csv-v1',
          exportedAt: new Date().toISOString(),
          dataVersion: (typeof DATA_VERSION !== 'undefined' ? DATA_VERSION : (this.dataVersion || 1)),
          userId: this.userId
        };

        const rows = [['key', 'value']];
        rows.push(['__meta', JSON.stringify(meta)]);

        for (const k of keys) {
          try {
            // Prefer current in-memory state (single source of truth)
            const v = (k === 'currentMonth') ? this.currentMonth : this[k];
            rows.push([k, JSON.stringify(v ?? null)]);
          } catch (e) {
            rows.push([k, JSON.stringify(null)]);
          }
        }

        const csv = this._toCSV(rows);
        const safeDate = meta.exportedAt.slice(0, 10);
        this._downloadText(csv, `wallit_export_${safeDate}.csv`, 'text/csv;charset=utf-8');
        this.showNotification('CSV Export erstellt.', 'success');
      }

      openCSVImport() {
        const input = document.getElementById('csvImportInput');
        if (!input) {
          this.showNotification('CSV-Import nicht verf√ºgbar (Datei-Input fehlt).', 'error');
          return;
        }
        input.click();
      }

      async handleCSVImport(event) {
        const file = event?.target?.files?.[0];
        if (!file) return;
        try {
          await this.importFromCSV(file);
        } finally {
          // reset so same file can be picked again
          event.target.value = '';
        }
      }

      async importFromCSV(file) {
        const text = await file.text();
        const rows = this._parseCSV(text);
        if (!rows || rows.length < 2) {
          this.showNotification('CSV-Import fehlgeschlagen (Datei leer/ung√ºltig).', 'error');
          return;
        }

        // header mapping
        const header = rows[0].map(h => String(h || '').trim().toLowerCase());
        const keyIdx = header.indexOf('key');
        const valIdx = header.indexOf('value');
        if (keyIdx === -1 || valIdx === -1) {
          this.showNotification('CSV-Import fehlgeschlagen (Spalten key/value fehlen).', 'error');
          return;
        }

        const map = new Map();
        for (let r = 1; r < rows.length; r++) {
          const k = rows[r][keyIdx];
          const v = rows[r][valIdx];
          if (!k) continue;
          map.set(String(k).trim(), String(v ?? '').trim());
        }

        // Basic validation
        const metaRaw = map.get('__meta');
        if (!metaRaw) {
          this.showNotification('CSV-Import fehlgeschlagen (__meta fehlt).', 'error');
          return;
        }

        let meta = null;
        try { meta = JSON.parse(metaRaw); } catch (e) {}
        if (!meta || meta.app !== 'wallit' || !String(meta.format || '').startsWith('wallit-csv')) {
          this.showNotification('CSV-Import fehlgeschlagen (kein Wallit-Export).', 'error');
          return;
        }

        const apply = (key, value) => {
          this.saveData(key, value);
          if (key === 'currentMonth') {
            this.currentMonth = value;
          } else {
            this[key] = value;
          }
        };

        const keysToImport = [
          'fixkosten',
          'ausgabenAll',
          'einkommenAll',
          'zusatzeinkommenAll',
          'sparkonten',
          'sparraten',
          'kontobewegungen',
          'kredite',
          'ausgabenVorlagen',
          'haushalt',
          'benutzer',
          'aktiverBenutzer',
          'standardEinkommen',
          'currentMonth'
        ];

        for (const k of keysToImport) {
          if (!map.has(k)) continue;
          try {
            const parsed = JSON.parse(map.get(k));
            apply(k, parsed);
          } catch (e) {
            // ignore malformed keys but keep going
          }
        }

        // Ensure critical migrations/consistency
        try { this.migrateToMultiUser?.(); } catch (e) {}
        try { this.ensureDataIntegrity?.(); } catch (e) {}

        this.showNotification('CSV importiert. App wurde aktualisiert.', 'success');

        // Full rerender + refresh charts
        this.clearCache?.();
        this.render();
        try { this.updateAllCharts?.(); } catch (e) {}
      }

      _downloadText(text, filename, mime) {
        const blob = new Blob([text], { type: mime || 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      }

      _toCSV(rows) {
        const esc = (v) => {
          const s = String(v ?? '');
          const needs = /[",\n\r;]/.test(s);
          const out = s.replace(/"/g, '""');
          return needs ? `"${out}"` : out;
        };
        return rows.map(r => r.map(esc).join(',')).join('\n');
      }

      _parseCSV(text) {
        // RFC4180-ish parser with delimiter autodetect (',' vs ';')
        const sample = text.split(/\r?\n/, 1)[0] || '';
        const delim = (sample.split(';').length > sample.split(',').length) ? ';' : ',';

        const rows = [];
        let row = [];
        let cur = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const ch = text[i];

          if (inQuotes) {
            if (ch === '"') {
              if (text[i + 1] === '"') { cur += '"'; i++; }
              else { inQuotes = false; }
            } else {
              cur += ch;
            }
            continue;
          }

          if (ch === '"') { inQuotes = true; continue; }

          if (ch === delim) {
            row.push(cur);
            cur = '';
            continue;
          }

          if (ch === '\n') {
            row.push(cur);
            cur = '';
            rows.push(row);
            row = [];
            continue;
          }

          if (ch === '\r') continue;

          cur += ch;
        }

        // last field
        row.push(cur);
        rows.push(row);

        // trim empty trailing rows
        while (rows.length && rows[rows.length - 1].every(c => String(c || '').trim() === '')) rows.pop();
        return rows;
      }


      createCharts() {
        // üöÄ PERF: debounce + rAF instead of setTimeout
        if (!this._scheduleCharts) {
          this._scheduleCharts = debounce(() => {
            requestAnimationFrame(() => {
              if (this.activeTab === 'dashboard') {
                this.renderHeatmap();
                this.renderSankey();
                this.createYearlyCharts(); // Dashboard uses yearly charts too
              } else if (this.activeTab === 'year') {
                this.createYearlyCharts();
              } else if (this.activeTab === 'investments') {
                this.createInvestmentCharts();
              }
            });
          }, 120);
        }
        this._scheduleCharts();
      }

      destroyChartsExcept(keepKeys = []) {
        const keep = new Set(keepKeys);
        Object.keys(this.charts || {}).forEach(k => {
          if (!keep.has(k) && this.charts[k]) {
            try { this.charts[k].destroy(); } catch (e) {}
            delete this.charts[k];
          }
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      upsertChart(key, canvas, config) {
        if (!canvas) return;
        const existing = this.charts?.[key];
        if (existing) {
          const sameType = (existing.config?.type === config.type);
          if (!sameType) {
            try { existing.destroy(); } catch (e) {}
            this.charts[key] = new Chart(canvas, config);
            return;
          }
          existing.data = config.data;
          existing.options = config.options;
          existing.update();
          return;
        }
        this.charts[key] = new Chart(canvas, config);
      }


      renderCategoryLegend(containerId, chart) {
        const el = document.getElementById(containerId);
        if (!el) return;
        if (!chart || !chart.data || !chart.data.labels || !chart.data.datasets?.length) {
          el.innerHTML = '';
          return;
        }

        const labels = chart.data.labels || [];
        const values = (chart.data.datasets[0].data || []).map(v => (parseFloat(v) || 0));
        const colors = chart.data.datasets[0].backgroundColor || [];

        // Sort by value desc (keeps UI stable & readable)
        const items = labels.map((label, i) => ({
          label,
          value: values[i] ?? 0,
          color: Array.isArray(colors) ? (colors[i] || '#94a3b8') : colors
        })).sort((a, b) => (b.value || 0) - (a.value || 0));

        el.innerHTML = items.map(it => `
          <div class="flex items-center justify-between gap-3 p-2 rounded-lg border border-white/10 bg-white/5">
            <div class="flex items-center gap-2 min-w-0">
              <span class="w-3.5 h-3.5 rounded-sm shrink-0" style="background:${it.color}; border:1px solid rgba(255,255,255,0.35)"></span>
              <span class="text-sm text-white/80 truncate">${this.escapeHtml(String(it.label))}</span>
            </div>
            <span class="text-sm font-semibold text-white/90 whitespace-nowrap">${this.formatCurrency(it.value)}</span>
          </div>
        `).join('');
      }

      createYearlyCharts() {
        // Lazy-load Chart.js when charts are needed
        if (typeof Chart === "undefined") {
          // Fire and forget: createCharts() will call again after lib is ready
          (window.ensureChartJS?.() || Promise.resolve()).then(() => this.createYearlyCharts()).catch(()=>{});
          return;
        }
        const yearlyStats = this.getYearlyStats();
        this.destroyChartsExcept(['monthly','sparquote','category','cashflow']);
        
        const monthlyCanvas = document.getElementById('monthlyChart');
        if (monthlyCanvas) {
          this.upsertChart('monthly', monthlyCanvas, {
            type: 'bar',
            data: {
              labels: yearlyStats.months,
              datasets: [
                {
                  label: 'Einkommen',
                  data: yearlyStats.einkommenData,
                  backgroundColor: 'rgba(102, 126, 234, 0.8)',
                  borderColor: '#667eea',
                  borderWidth: 2
                },
                {
                  label: 'Ausgaben',
                  data: yearlyStats.ausgabenData,
                  backgroundColor: 'rgba(239, 68, 68, 0.8)',
                  borderColor: '#ef4444',
                  borderWidth: 2
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        const sparquoteCanvas = document.getElementById('sparquoteChart');
        if (sparquoteCanvas) {
          this.upsertChart('sparquote', sparquoteCanvas, {
            type: 'line',
            data: {
              labels: yearlyStats.months,
              datasets: [{
                label: 'Sparquote (%)',
                data: yearlyStats.sparquoteData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        const categoryCanvas = document.getElementById('categoryChart');
        if (categoryCanvas && Object.keys(yearlyStats.categoryTotals).length > 0) {
          const labels = Object.keys(yearlyStats.categoryTotals);
          const data = Object.values(yearlyStats.categoryTotals);
          
          this.upsertChart('category', categoryCanvas, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: [
                  '#667eea',
                  '#ef4444',
                  '#10b981',
                  '#f59e0b',
                  '#3b82f6',
                  '#8b5cf6'
                ],
                borderWidth: 2,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              }
            }
          });
          const catChart = this.charts?.category;
          this.renderCategoryLegend('categoryLegend', catChart);
        }
        

        // Neue Geldfluss-Chart mit allen Ausgaben
        const cashflowCanvas = document.getElementById('cashflowChart');
        if (cashflowCanvas) {
          this.upsertChart('cashflow', cashflowCanvas, {
            type: 'bar',
            data: {
              labels: yearlyStats.months,
              datasets: [
                {
                  label: 'Fixkosten',
                  data: yearlyStats.fixkostenData,
                  backgroundColor: 'rgba(239, 68, 68, 0.8)',
                  borderColor: '#ef4444',
                  borderWidth: 1
                },
                {
                  label: 'Variable Ausgaben',
                  data: yearlyStats.ausgabenData,
                  backgroundColor: 'rgba(251, 146, 60, 0.8)',
                  borderColor: '#fb923c',
                  borderWidth: 1
                },
                {
                  label: 'Sparraten',
                  data: yearlyStats.sparratenData,
                  backgroundColor: 'rgba(16, 185, 129, 0.8)',
                  borderColor: '#10b981',
                  borderWidth: 1
                },
                {
                  label: 'Kreditraten',
                  data: yearlyStats.kreditratenData,
                  backgroundColor: 'rgba(139, 92, 246, 0.8)',
                  borderColor: '#8b5cf6',
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                x: { stacked: true },
                y: { 
                  stacked: true,
                  beginAtZero: true
                }
              }
            }
          });
        }
      }

      createInvestmentCharts() {
        if (typeof Chart === "undefined") {
          (window.ensureChartJS?.() || Promise.resolve()).then(() => this.createInvestmentCharts()).catch(()=>{});
          return;
        }
        this.destroyChartsExcept(['distribution','development']);
        
        const distributionCanvas = document.getElementById('investmentDistributionChart');
        if (distributionCanvas && this.sparkonten.length > 0) {
          const labels = this.sparkonten.map(k => k.name);
          const data = this.sparkonten.map(k => k.aktuellerStand);
          const colors = this.sparkonten.map(k => k.farbe);
          
          this.upsertChart('distribution', distributionCanvas, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: colors,
                borderColor: '#fff',
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              }
            }
          });
        }
        
        const developmentCanvas = document.getElementById('investmentDevelopmentChart');
        if (developmentCanvas && this.sparkonten.length > 0) {
          const datasets = this.sparkonten.map(konto => {
            const bewegungen = this.kontobewegungen[konto.id] || [];
            const sortiert = [...bewegungen].sort((a, b) => new Date(a.datum) - new Date(b.datum));
            
            const monthlyData = {};
            let laufenderStand = 0;
            
            sortiert.forEach(b => {
              const month = b.datum.substring(0, 7);
              if (b.typ === 'einzahlung') {
                laufenderStand += b.betrag;
              } else {
                laufenderStand -= b.betrag;
              }
              monthlyData[month] = laufenderStand;
            });
            
            const now = new Date();
            const data = [];
            
            for (let i = 11; i >= 0; i--) {
              const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
              const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
              
              let stand = 0;
              Object.keys(monthlyData).forEach(m => {
                if (m <= monthKey) {
                  stand = monthlyData[m];
                }
              });
              data.push(stand);
            }
            
            return {
              label: konto.name,
              data: data,
              borderColor: konto.farbe,
              backgroundColor: konto.farbe + '33',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            };
          });
          
          const now = new Date();
          const labels = [];
          for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(d.toLocaleDateString('de-DE', { month: 'short', year: '2-digit' }));
          }
          
          this.upsertChart('development', developmentCanvas, {
            type: 'line',
            data: {
              labels: labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      }

      render() {
        const app = document.getElementById('app');
        app.innerHTML = `
          <div class="min-h-screen" style="background: var(--bg-gradient-page);">
            <div class="max-w-7xl mx-auto p-4 md:p-6 pb-28 md:pb-6">
              <div class="mb-6 text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-2 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent px-4 py-2" style="line-height: 1.3;">
                  Wallit
                </h1>
              </div>

              <!-- ${icons.smartphone} CLOUD SECTION - Mobile optimiert -->
              <div class="nav-section bg-white rounded-2xl border border-gray-100 p-4 md:p-6 mb-6 panel-card">
                <!-- Mobile: Collapsible Header -->
                <div class="md:hidden">
                  <button onclick="const content = this.nextElementSibling; const chevron = this.querySelector('.chevron'); content.classList.toggle('hidden'); chevron.classList.toggle('rotate-180');" 
                      class="w-full flex items-center justify-between py-2">
                    <div class="flex items-center gap-3 flex-1">
                      <div class="text-indigo-600 flex-shrink-0">${icons.cloud}</div>
                      <span class="text-base font-bold text-gray-700 flex-shrink-0">Cloud & Export</span>
                      <div class="flex-shrink-0">
                        ${window.firebaseReady ? '<span class="text-green-600 inline-flex">' + icons.check + '</span>' : '<span class="text-orange-600 inline-flex">' + icons.alertTriangle + '</span>'}
                      </div>
                    </div>
                    <div class="text-gray-400 chevron transition-transform flex-shrink-0 ml-3">${icons.chevronDown}</div>
                  </button>
                  
                  <div class="hidden mt-4">
                    <!-- User ID - kompakt -->
                    <div class="bg-gray-50 rounded-lg p-2 mb-2">
                      <div class="flex items-center justify-between gap-2">
                        <div class="kpi-sub text-[color:var(--text-tertiary)] flex items-center gap-1 overflow-hidden">
                          <span class="font-mono truncate">${this.userId.substring(0, 12)}...</span>
                        </div>
                        <div class="flex gap-1 flex-shrink-0">
                          <button onclick="app.copyUserId()" class="action-btn-small action-btn-primary" title="URL kopieren">
                            ${icons.clipboard}
                          </button>
                          <button onclick="app.changeUserId()" class="action-btn-small action-btn-warning" title="ID √§ndern">
                            ${icons.key}
                          </button>
                        </div>
                      </div>
                      ${!this.localStorageWorks ? '<div class="flex items-center gap-2 kpi-sub text-orange-600 font-semibold mt-1">' + icons.lightbulb + ' <span>Lesezeichen setzen!</span></div>' : ''}
                      ${!window.firebaseReady ? '<div class="kpi-sub text-orange-600 mt-1">‚ö†Ô∏è Nutze Chrome f√ºr Cloud-Sync</div>' : ''}
                    </div>

                    <!-- Action Buttons - kompakt 2x2 Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2" style="gap: var(--space-2);">
                      <button onclick="app.syncToCloud()" class="btn-upload text-white font-semibold text-sm transition-all flex items-center justify-center ${this.isSyncing ? 'opacity-50 cursor-not-allowed' : ''}" style="padding: var(--space-3); gap: var(--space-1); border-radius: var(--radius-md);" ${this.isSyncing ? 'disabled' : ''}>
                        <span class="${this.isSyncing ? 'sync-animation' : ''}" style="display: flex; align-items: center;">${icons.cloud}</span>
                        <span>${this.isSyncing ? 'Sync...' : 'Hochladen'}</span>
                      </button>
                      <button onclick="app.loadFromCloud()" class="btn-download text-white font-semibold text-sm transition-all flex items-center justify-center" style="padding: var(--space-3); gap: var(--space-1); border-radius: var(--radius-md);" ${this.isSyncing ? 'disabled' : ''}>
                        <span style="display: flex; align-items: center;">${icons.refresh}</span>
                        <span>Laden</span>
                      </button>
                      <button onclick="app.exportToCSV()" class="btn-export text-white font-semibold text-sm transition-all flex items-center justify-center" style="padding: var(--space-3); gap: var(--space-1); border-radius: var(--radius-md);">
                        <span style="display: flex; align-items: center;">${icons.download}</span>
                        <span>CSV Export</span>
                      </button>
<button onclick="app.openCSVImport()" class="btn-download text-white font-semibold text-sm transition-all flex items-center justify-center" style="padding: var(--space-3); gap: var(--space-1); border-radius: var(--radius-md);">
                        <span style="display: flex; align-items: center;">${icons.upload}</span>
                        <span>CSV Import</span>
                      </button>
                      <button onclick="app.resetAllData()" class="btn-reset text-white font-semibold text-sm transition-all flex items-center justify-center" style="padding: var(--space-3); gap: var(--space-1); border-radius: var(--radius-md);">
                        <span style="display: flex; align-items: center;">${icons.trash}</span>
                        <span>Alles zur√ºcksetzen</span>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Desktop: Accordion Layout (wie Mobile) -->
                <details class="wallit-accordion hidden md:block mt-6 mb-6">
                  <summary class="accordion-summary">
                    <div class="flex items-center gap-3 min-w-0">
                      <div class="text-indigo-600 flex-shrink-0">${icons.cloud}</div>
                      <div class="wallit-accordion__title">Cloud & Export</div>
                      <div class="wallit-accordion__meta">
                        ${window.firebaseReady
                          ? '<span class="flex items-center gap-1 text-green-600 kpi-sub">' + icons.check + '<span>Aktiv</span></span>'
                          : '<span class="flex items-center gap-1 text-orange-600 kpi-sub">' + icons.alertTriangle + '<span>Browser pr√ºfen</span></span>'}
                      </div>
                    </div>
                    <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </summary>
                  <div class="wallit-accordion__body">
                    <div class="wallit-accordion-item">
                      <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-3">
                          <div class="text-indigo-600">${icons.cloud}</div>
                          <div>
                            <div class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                              <span>Cloud Synchronisation</span>
                              ${!window.firebaseReady ? '<span class="flex items-center gap-1 text-red-500 kpi-sub ml-2">' + icons.alertTriangle + '<span>Nicht verf√ºgbar in Safari</span></span>' : '<span class="flex items-center gap-1 text-green-500 kpi-sub ml-2"><span>Aktiv</span>' + icons.check + '</span>'}
                            </div>
                            <div class="kpi-sub text-[color:var(--text-tertiary)] flex items-center gap-2">
                              <span>User ID: ${this.userId.substring(0, 20)}...</span>
                              <button onclick="app.copyUserId()" class="action-btn-small action-btn-primary" title="URL mit User-ID kopieren">
                                ${icons.clipboard} URL
                              </button>
                              <button onclick="app.changeUserId()" class="action-btn-small action-btn-warning" title="User-ID √§ndern">
                                ${icons.key} √Ñndern
                              </button>
                            </div>
                            ${!this.localStorageWorks ? '<div class="flex items-center gap-2 kpi-sub text-orange-600 font-semibold mt-1">' + icons.lightbulb + ' <span>Tipp: Setze ein LESEZEICHEN - User-ID bleibt in URL!</span></div>' : ''}
                            ${this.lastSync ? `<div class="kpi-sub text-indigo-600">Letzte Sync: ${new Date(this.lastSync).toLocaleString('de-DE')}</div>` : ''}
                            ${!window.firebaseReady ? '<div class="kpi-sub text-orange-600 mt-1">Nutze Chrome/Firefox f√ºr Cloud-Sync oder speichere lokal</div>' : ''}
                          </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                          <button onclick="app.syncToCloud()" class="btn-upload px-4 py-2 text-white rounded-lg font-semibold transition-all flex items-center gap-2 ${this.isSyncing ? 'opacity-50 cursor-not-allowed' : ''}" ${this.isSyncing ? 'disabled' : ''}>
                            <span class="${this.isSyncing ? 'sync-animation' : ''}" style="display: flex; align-items: center;">${icons.cloud}</span>
                            <span>${this.isSyncing ? 'Syncing...' : 'Hochladen'}</span>
                          </button>
                          <button onclick="app.loadFromCloud()" class="btn-download px-4 py-2 text-white rounded-lg font-semibold transition-all flex items-center gap-2" ${this.isSyncing ? 'disabled' : ''}>
                            <span style="display: flex; align-items: center;">${icons.refresh}</span>
                            <span>Laden</span>
                          </button>
                          <button onclick="app.exportToCSV()" class="btn-export px-4 py-2 text-white rounded-lg font-semibold transition-all flex items-center gap-2">
                            <span style="display: flex; align-items: center;">${icons.download}</span>
                            <span>CSV Export</span>
                          </button>
                          <button onclick="app.openCSVImport()" class="btn-download px-4 py-2 text-white rounded-lg font-semibold transition-all flex items-center gap-2">
                            <span style="display: flex; align-items: center;">${icons.upload}</span>
                            <span>CSV Import</span>
                          </button>
                          <button onclick="app.resetAllData()" class="btn-reset px-4 py-2 text-white rounded-lg font-semibold transition-all flex items-center gap-2">
                            <span style="display: flex; align-items: center;">${icons.trash}</span>
                            <span>Alles zur√ºcksetzen</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </details>
              </div>

              <!-- üë• USER TABS - Haushalt Navigation -->
              <div class="nav-section bg-white rounded-2xl border border-gray-100 p-4 mb-6 panel-card">
                <div class="flex items-center justify-between" style="margin-bottom: var(--space-4);">
                  <div class="flex items-center" style="gap: var(--space-2);">
                    ${icons.home}
                    <span class="font-bold text-[color:var(--text-primary)]">${this.haushalt.name}</span>
                  </div>
                  <button onclick="app.showUserManagement()" class="bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-semibold transition-colors flex items-center" style="padding: var(--space-2) var(--space-3); gap: var(--space-2);" title="Haushalt verwalten">
                    ${icons.settings} Verwalten
                  </button>
                </div>
                
                <div class="flex overflow-x-auto" style="gap: var(--space-3); padding: var(--space-3) var(--space-2);">
                  ${Object.values(this.benutzer).map(user => `
                    <button 
                      onclick="app.switchUser('${user.id}')" 
                      class="user-tab rounded-lg font-semibold transition-all whitespace-nowrap flex items-center ${this.aktiverBenutzer === user.id ? 'user-tab-active' : 'user-tab-inactive'}"
                      style="border: 2px solid ${user.farbe}${this.aktiverBenutzer === user.id ? '; background: ' + user.farbe + '20' : ''}; padding: var(--space-2) var(--space-4); gap: var(--space-2);">
                      <span>${user.emoji}</span>
                      <span>${user.name}</span>
                    </button>
                  `).join('')}
                </div>
              </div>

              <div class="md:flex md:gap-6">
                <!-- Desktop Sidebar Navigation -->
                <aside class="hidden md:block md:w-72 lg:w-80 shrink-0">
                  <div class="sidebar-nav-container bg-white rounded-2xl border border-gray-100 shadow-sm sticky top-6 panel-card">
                    <div class="sidebar-nav-title kpi-sub font-semibold text-[color:var(--text-tertiary)]">Navigation</div>
                    <div class="sidebar-nav-list">
                      <button onclick="app.setTab('dashboard')" class="sidebar-nav-button w-full flex items-center font-bold transition-all shadow-sm ${this.activeTab === 'dashboard' ? 'tab-active' : 'tab-inactive hover:shadow-md'}">
                        ${icons.barChart} <span>Dashboard</span>
                      </button>
                      <button onclick="app.setTab('month')" class="sidebar-nav-button w-full flex items-center font-bold transition-all shadow-sm ${this.activeTab === 'month' ? 'tab-active' : 'tab-inactive hover:shadow-md'}">
                        ${icons.calendar} <span>Monat</span>
                      </button>
                      <button onclick="app.setTab('year')" class="sidebar-nav-button w-full flex items-center font-bold transition-all shadow-sm ${this.activeTab === 'year' ? 'tab-active' : 'tab-inactive hover:shadow-md'}">
                        ${icons.trending} <span>Jahr</span>
                      </button>
                      <button onclick="app.setTab('investments')" class="sidebar-nav-button w-full flex items-center font-bold transition-all shadow-sm ${this.activeTab === 'investments' ? 'tab-active' : 'tab-inactive hover:shadow-md'}">
                        ${icons.piggyBank} <span>Anlagen</span>
                      </button>
                      <button onclick="app.setTab('stammdaten')" class="sidebar-nav-button w-full flex items-center font-bold transition-all shadow-sm ${this.activeTab === 'stammdaten' ? 'tab-active' : 'tab-inactive hover:shadow-md'}">
                        ${icons.settings} <span>Stammdaten</span>
                      </button>
                    </div>
                    
                  </div>
                </aside>

                <!-- Main Content -->
                <div class="flex-1 min-w-0">
                  <!-- Mobile Tabs Row - HIDDEN (Bottom Nav ersetzt diese) -->
                  <div class="hidden">
                    <button onclick="app.setTab('dashboard')" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all shadow-md ${this.activeTab === 'dashboard' ? 'tab-active' : 'tab-inactive hover:shadow-lg'}">
                      ${icons.barChart} <span>Dashboard</span>
                    </button>
                    <button onclick="app.setTab('month')" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all shadow-md ${this.activeTab === 'month' ? 'tab-active' : 'tab-inactive hover:shadow-lg'}">
                      ${icons.calendar} <span>Monat</span>
                    </button>
                    <button onclick="app.setTab('year')" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all shadow-md ${this.activeTab === 'year' ? 'tab-active' : 'tab-inactive hover:shadow-lg'}">
                      ${icons.trending} <span>Jahr</span>
                    </button>
                    <button onclick="app.setTab('investments')" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all shadow-md ${this.activeTab === 'investments' ? 'tab-active' : 'tab-inactive hover:shadow-lg'}">
                      ${icons.piggyBank} <span>Anlagen</span>
                    </button>
                    <button onclick="app.setTab('stammdaten')" class="flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all shadow-md ${this.activeTab === 'stammdaten' ? 'tab-active' : 'tab-inactive hover:shadow-lg'}">
                      ${icons.settings} <span>Stammdaten</span>
                    </button>
                  </div>

                  <div id="content">
                ${this.activeTab === 'dashboard' ? this.renderDashboard() : ''}
                ${this.activeTab === 'month' ? this.renderMonthView() : ''}
                ${this.activeTab === 'year' ? this.renderYearView() : ''}
                ${this.activeTab === 'investments' ? this.renderInvestmentsView() : ''}
                ${this.activeTab === 'stammdaten' ? this.renderStammdatenView() : ''}
              </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mobile Bottom Navigation -->
          <nav class="bottom-nav md:hidden" aria-label="Hauptnavigation">
            <button onclick="app.setTab('dashboard')" class="bn-item ${this.activeTab === 'dashboard' ? 'bn-active' : ''}" aria-label="Dashboard">
              ${icons.barChart}
              <span class="bn-label">Dash</span>
            </button>
            <button onclick="app.setTab('month')" class="bn-item ${this.activeTab === 'month' ? 'bn-active' : ''}" aria-label="Monat">
              ${icons.calendar}
              <span class="bn-label">Monat</span>
            </button>
            <button onclick="app.setTab('year')" class="bn-item ${this.activeTab === 'year' ? 'bn-active' : ''}" aria-label="Jahr">
              ${icons.trending}
              <span class="bn-label">Jahr</span>
            </button>
            <button onclick="app.setTab('investments')" class="bn-item ${this.activeTab === 'investments' ? 'bn-active' : ''}" aria-label="Anlagen">
              ${icons.piggyBank}
              <span class="bn-label">Anlagen</span>
            </button>
            <button onclick="app.setTab('stammdaten')" class="bn-item ${this.activeTab === 'stammdaten' ? 'bn-active' : ''}" aria-label="Stammdaten">
              ${icons.settings}
              <span class="bn-label">Data</span>
            </button>
          </nav>
        `;
        
        this.applyAriaLabels(document);
        this.createCharts();
      }

      // üë• USER STATISTIK F√úR DASHBOARD
      renderUserStats() {
        const stats = this.getUserStats(this.currentMonth, this.aktiverBenutzer);
        const activeUser = this.benutzer[this.aktiverBenutzer];
        
        if (!stats || !activeUser) return '';
        
        return `
          <div class="bg-white rounded-2xl shadow-xl p-6 border-l-4 mb-6" 
             style="border-left-color: ${activeUser.farbe} !important;">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-[color:var(--text-primary)]">
                ${activeUser.emoji} ${activeUser.name} - ${this.currentMonth}
              </h3>
              <span class="px-3 py-1 rounded-full text-sm font-semibold" 
                 style="background: ${activeUser.farbe}20; color: ${activeUser.farbe};">
                Aktiver Benutzer
              </span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200">
                <div class="flex items-center gap-2 kpi-label text-green-700 font-semibold mb-2">
                  ${this.getCurrentCurrencyIcon()}
                  <span>Einkommen</span>
                </div>
                <div class="kpi-value text-green-800">
                  ${this.formatCurrency(stats.einkommen)}
                </div>
              </div>
              
              <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200">
                <div class="flex items-center gap-2 kpi-label text-blue-700 font-semibold mb-2">${icons.shoppingCart} <span>Variable Ausgaben</span></div>
                <div class="kpi-value text-blue-800">
                  ${this.formatCurrency(stats.variableAusgaben)}
                </div>
                <div class="kpi-sub text-blue-600 mt-1">
                  Privat ${this.formatCurrency(stats.privateAusgaben)} ¬∑ Gemeinsam ${this.formatCurrency(stats.gemeinsameAusgabenAnteil)}
                </div>
              </div>
              
              <div class="p-4 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl border border-orange-200">
                <div class="flex items-center gap-2 kpi-label text-orange-700 font-semibold mb-2">${icons.home} <span>Fixkosten</span></div>
                <div class="text-xl font-bold text-orange-800">
                  ${this.formatCurrency(stats.fixkostenAnteil)}
                </div>
                <div class="kpi-sub text-orange-600 mt-1">
                  inkl. gemeinsamer Anteil (falls vorhanden)
                </div>
              </div>
              
              
<div class="p-4 bg-gradient-to-br from-rose-50 to-rose-100 rounded-xl border border-rose-200">
  <div class="flex items-center gap-2 kpi-label text-rose-700 font-semibold mb-2">${icons.creditCard} <span>Kreditraten</span></div>
  <div class="text-xl font-bold text-rose-800">
    ${this.formatCurrency(stats.kreditraten)}
  </div>
  <div class="kpi-sub text-rose-600 mt-1">
    Nur aktive Kredite im Monat
  </div>
</div>
            </div>
            
            <div class="mt-6 pt-6 summary-row">
              <div class="flex justify-between items-center">
                <div>
                  <div class="text-sm text-[color:var(--text-tertiary)] mb-1">Gesamt ausgegeben</div>
                  <div class="kpi-value text-[color:var(--text-primary)]">
                    ${this.formatCurrency(stats.gesamt)}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm text-[color:var(--text-tertiary)] mb-1">√úbrig f√ºr ${activeUser.name}</div>
                  <div class="kpi-value ${stats.uebrig >= 0 ? 'text-green-600' : 'text-red-400'}">
                    ${this.formatCurrency(stats.uebrig)}
                  </div>
                </div>
              </div>

              
            </div>
          </div>
        `;
      }

      renderDashboard() {
        const dash = this.getDashboardStats();
        const [year, month] = this.currentMonth.split('-').map(Number);
        const monthName = new Date(this.currentMonth + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
        
        return `
          <div class="space-y-6">
            <!-- Monats-Navigation -->
            <div class="flex items-center justify-center gap-4 bg-white p-4 rounded-xl shadow-md border border-gray-200">
              <button onclick="app.changeMonth(-1)" class="p-3 hover:bg-gray-100 rounded-lg transition-colors text-gray-700">
                ${icons.chevronLeft}
              </button>
              <div class="kpi-value month-nav-title text-[color:var(--text-primary)] min-w-[200px] sm:min-w-[280px] text-center">
                ${monthName}
              </div>
              <button onclick="app.changeMonth(1)" class="p-3 hover:bg-gray-100 rounded-lg transition-colors text-gray-700">
                ${icons.chevronRight}
              </button>
            </div>

            ${this.renderUserStats()}

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Aktuell Verf√ºgbar -->
              <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-6 rounded-2xl shadow-lg border border-emerald-200">
                <div class="flex items-center gap-2 kpi-label text-emerald-700 font-semibold mb-2">${this.getCurrentCurrencyIcon()} <span>Diesen Monat verf√ºgbar</span></div>
                <div class="kpi-value text-emerald-800">${this.formatCurrency(dash.current.verfuegbar)}</div>
                <div class="kpi-sub text-emerald-600 mt-2">
                  ${dash.current.verfuegbar > dash.last.verfuegbar ? '+' : ''}${(dash.current.verfuegbar - dash.last.verfuegbar).toFixed(2)} ‚Ç¨ vs. letzter Monat
                </div>
              </div>

              <!-- Sparquote -->
              <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-2xl shadow-lg border border-indigo-200">
                <div class="flex items-center gap-2 kpi-label text-indigo-700 font-semibold mb-2">${icons.trendingUp} <span>Sparquote</span></div>
                <div class="kpi-value text-indigo-800">
                  ${dash.current.gesamtEinkommen > 0 ? ((dash.current.verfuegbar / dash.current.gesamtEinkommen) * 100).toFixed(1) : '0.0'}%
                </div>
                <div class="kpi-sub text-indigo-600 mt-2">
                  ${dash.sparquoteChange > 0 ? '+' : ''}${dash.sparquoteChange.toFixed(1)}% vs. letzter Monat
                </div>
              </div>

              <!-- Gesamtverm√∂gen -->
              <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-2xl shadow-lg border border-purple-200">
                <div class="flex items-center gap-2 kpi-label text-purple-700 font-semibold mb-2">${icons.gem} <span>Gesamtverm√∂gen</span></div>
                <div class="kpi-value text-purple-800">${this.formatCurrency(dash.totalAssets)}</div>
                <div class="kpi-sub text-purple-600 mt-2">Sparkonten & Anlagen</div>
              </div>

              <!-- Jahresprognose -->
              <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 p-6 rounded-2xl shadow-lg border border-cyan-200">
                <div class="flex items-center gap-2 kpi-label text-cyan-700 font-semibold mb-2">${icons.zap} <span>Jahresprognose</span></div>
                <div class="kpi-value text-cyan-800">${this.formatCurrency(dash.prognosis.projectedTotal)}</div>
                <div class="kpi-sub text-cyan-600 mt-2">Gespart bis Jahresende</div>
              </div>
            </div>

            <!-- (Dashboard bereinigt: Prognose/Monatsvergleich/Jahres√ºbersicht entfernt) -->

            

            <!-- (Dashboard bereinigt: Fixkosten-Liste entfernt) -->

            ${(() => {
                  const aktiveKrediteUser = this.getAktiveKrediteForUserMonth(this.currentMonth, this.aktiverBenutzer);
                  if (aktiveKrediteUser.length === 0) return '';
                  return `
              <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.creditCard} <span>Aktive Kredite</span></h2>
                
                ${(() => {
                  const aktiveKredite = this.getAktiveKrediteForUserMonth(this.currentMonth, this.aktiverBenutzer);
                  const kreditlast = this.getGesamtKreditlastForUserMonth(this.currentMonth, this.aktiverBenutzer);
                  
                  if (aktiveKredite.length === 0) {
                    return '';
                  }
                  
                  return `
                    <!-- Gesamt-√úbersicht -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                      <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border border-red-200">
                        <div class="text-sm text-red-700 font-semibold mb-1">Gesamte Restschuld</div>
                        <div class="kpi-value text-red-800">${this.formatCurrency(kreditlast.restschuld)}</div>
                      </div>
                      <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl border border-orange-200">
                        <div class="text-sm text-orange-700 font-semibold mb-1">Monatliche Belastung</div>
                        <div class="kpi-value text-orange-800">${this.formatCurrency(kreditlast.monatlicheRate)}</div>
                      </div>
                      <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl border border-indigo-200">
                        <div class="text-sm text-indigo-700 font-semibold mb-1">Aktive Kredite</div>
                        <div class="kpi-value text-indigo-800">${kreditlast.anzahl}</div>
                      </div>
                    </div>
                    
                    
                    <!-- Kredit-Liste (eingeklappt) -->
                    <details class="mt-4 wallit-accordion">
 <summary>
  <span class="wallit-accordion__title">Details anzeigen</span>
  <span class="wallit-accordion__meta">
   <span></span>
   <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
   </svg>
  </span>
 </summary>
 <div class="wallit-accordion__body">
<div class="space-y-3">
                      ${aktiveKredite.map(k => {
                        const details = this.calculateKreditDetails(k);
                        return `
                          <div class="wallit-accordion-item">
                            <div class="flex items-start justify-between mb-2">
                              <div class="flex-1">
                                <h4 class="font-bold text-[color:var(--text-primary)]">${k.name}</h4>
                                <p class="text-sm text-[color:var(--text-tertiary)]">${k.kategorie} ‚Ä¢ ${this.formatCurrency(k.rate)}/Monat</p>
                              </div>
                              <div class="text-right">
                                <div class="text-sm text-[color:var(--text-tertiary)]">Restschuld</div>
                                <div class="text-lg font-bold text-red-400">${this.formatCurrency(details.restschuld)}</div>
                              </div>
                            </div>
                            <div class="mb-2">
                              <div class="flex justify-between kpi-sub mb-1">
                                <span class="text-[color:var(--text-tertiary)]">Fortschritt</span>
                                <span class="font-semibold">${details.fortschritt.toFixed(1)}%</span>
                              </div>
                              <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div class="h-full bg-indigo-600 transition-all" style="width: ${Math.min(details.fortschritt, 100)}%"></div>
                              </div>
                            </div>
                            <div class="kpi-sub text-[color:var(--text-tertiary)]">
                              Enddatum: ${this.formatDate(details.endDate.toISOString().split('T')[0])}
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
 </div>
</details>

                  `;
                })()}
              </div>
            `;
                  })()}

            

            <!-- (Dashboard bereinigt: Heatmap & Sankey entfernt) -->

          </div>
        `;
      }

      renderHeatmap() {
        setTimeout(() => {
          const container = document.getElementById('heatmap');
          if (!container) return;
          
          container.innerHTML = '';
          
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          
          // Sammle Ausgaben pro Tag
          const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
          const ausgaben = this.ausgabenAll[monthKey] || [];
          const dailyTotals = {};
          
          ausgaben.forEach(a => {
            const day = new Date(a.datum).getDate();
            dailyTotals[day] = (dailyTotals[day] || 0) + a.betrag;
          });
          
          // Finde max f√ºr Farbskala
          const maxAmount = Math.max(...Object.values(dailyTotals), 1);
          
          // Erstelle Heatmap
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('width', '100%');
          svg.setAttribute('height', '350');
          
          const cellSize = 40;
          const cols = 7;
          const rows = Math.ceil(daysInMonth / cols);
          
          for (let day = 1; day <= daysInMonth; day++) {
            const row = Math.floor((day - 1) / cols);
            const col = (day - 1) % cols;
            const amount = dailyTotals[day] || 0;
            const intensity = amount / maxAmount;
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', col * (cellSize + 5) + 5);
            rect.setAttribute('y', row * (cellSize + 5) + 5);
            rect.setAttribute('width', cellSize);
            rect.setAttribute('height', cellSize);
            rect.setAttribute('class', 'heatmap-day');
            
            if (amount === 0) {
              rect.setAttribute('fill', this.darkMode ? '#2a2a4a' : '#f3f4f6');
            } else {
              const r = Math.floor(239 - (intensity * 100));
              const g = Math.floor(68 + (intensity * 60));
              const b = Math.floor(68 + (intensity * 60));
              rect.setAttribute('fill', `rgb(${r}, ${g}, ${b})`);
            }
            
            rect.innerHTML = `<title>${day}. ${new Date(year, month).toLocaleDateString('de-DE', { month: 'long' })}: ${this.formatCurrency(amount)}</title>`;
            
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', col * (cellSize + 5) + cellSize / 2 + 5);
            text.setAttribute('y', row * (cellSize + 5) + cellSize / 2 + 10);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('class', 'heatmap-label');
            text.setAttribute('fill', intensity > 0.5 ? 'white' : (this.darkMode ? '#e0e0e0' : '#374151'));
            text.textContent = day;
            
            svg.appendChild(rect);
            svg.appendChild(text);
          }
          
          container.appendChild(svg);
        }, 100);
      }

      renderSankey() {
        setTimeout(async () => {
          const container = document.getElementById('sankey');
          if (!container) return;
          if (typeof d3 === 'undefined' || !(d3 && d3.sankey)) {
            try { await (window.ensureD3Sankey?.() || Promise.resolve()); } catch(e) { return; }
          }
          
          container.innerHTML = '';
          
          const stats = this.getMonthStats(this.currentMonth);
          const ausgaben = this.ausgabenAll[this.currentMonth] || [];
          
          // Gruppiere Ausgaben nach Kategorie
          const categoryTotals = {};
          ausgaben.forEach(a => {
            categoryTotals[a.kategorie] = (categoryTotals[a.kategorie] || 0) + a.betrag;
          });
          
          const nodes = [
            { name: 'Einkommen' },
            { name: 'Fixkosten' },
            { name: 'Kreditraten' },
            { name: 'Sparraten' },
            ...Object.keys(categoryTotals).map(k => ({ name: k })),
            { name: 'Verf√ºgbar' }
          ];
          
          const links = [
            { source: 0, target: 1, value: stats.fixkosten },
            { source: 0, target: 2, value: stats.kreditraten || 0 },
            { source: 0, target: 3, value: stats.sparraten }
          ];
          
          Object.keys(categoryTotals).forEach((cat, idx) => {
            links.push({ source: 0, target: 4 + idx, value: categoryTotals[cat] });
          });
          
          links.push({ source: 0, target: nodes.length - 1, value: Math.max(0, stats.verfuegbar) });
          
          const width = container.clientWidth;
          const height = 400;
          
          const svg = d3.select(container)
            .append('svg')
            .attr('width', width)
            .attr('height', height);
          
          const sankey = d3.sankey()
            .nodeWidth(15)
            .nodePadding(10)
            .extent([[10, 10], [width - 10, height - 10]]);
          
          const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
            nodes: nodes.map(d => Object.assign({}, d)),
            links: links.map(d => Object.assign({}, d))
          });
          
          const color = d3.scaleOrdinal(d3.schemeCategory10);
          
          svg.append('g')
            .selectAll('rect')
            .data(sankeyNodes)
            .join('rect')
            .attr('x', d => d.x0)
            .attr('y', d => d.y0)
            .attr('height', d => d.y1 - d.y0)
            .attr('width', d => d.x1 - d.x0)
            .attr('fill', (d, i) => color(i))
            .append('title')
            .text(d => `${d.name}\n${this.formatCurrency(d.value)}`);
          
          const link = svg.append('g')
            .selectAll('path')
            .data(sankeyLinks)
            .join('path')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke', d => color(d.source.index))
            .attr('stroke-width', d => Math.max(1, d.width))
            .attr('fill', 'none')
            .attr('class', 'sankey-link');
          
          link.append('title')
            .text(d => `${d.source.name} ‚Üí ${d.target.name}\n${this.formatCurrency(d.value)}`);
          
          svg.append('g')
            .selectAll('text')
            .data(sankeyNodes)
            .join('text')
            .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
            .attr('y', d => (d.y1 + d.y0) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
            .attr('fill', this.darkMode ? '#e0e0e0' : '#374151')
            .attr('font-size', '11px')
            .text(d => d.name);
        }, 100);
      }

      renderMonthView() {
        const stats = this.getMonthStats(this.currentMonth);
        const ausgaben = [...(this.ausgabenAll[this.currentMonth] || [])].sort((a, b) => new Date(b.datum) - new Date(a.datum));
        const ausgabenSum = ausgaben.reduce((s, a) => s + (parseFloat(a.betrag) || 0), 0);
        const zusatzeinkommen = [...(this.zusatzeinkommenAll[this.currentMonth] || [])].sort((a, b) => new Date(b.datum) - new Date(a.datum));
        const monatlicheSparraten = this.getMonatlicheSparraten();
        
        const monthName = new Date(this.currentMonth + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
        
        return `
          <div class="flex items-center justify-center gap-4 mb-6 bg-white p-4 rounded-xl shadow-md border border-gray-200">
            <button onclick="app.changeMonth(-1)" class="p-3 hover:bg-gray-100 rounded-lg transition-colors text-gray-700">
              ${icons.chevronLeft}
            </button>
            <div class="kpi-value month-nav-title text-[color:var(--text-primary)] min-w-[200px] sm:min-w-[280px] text-center">
              ${monthName}
            </div>
            <button onclick="app.changeMonth(1)" class="p-3 hover:bg-gray-100 rounded-lg transition-colors text-gray-700">
              ${icons.chevronRight}
            </button>
          </div>


          <div class="space-y-4">

          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.shoppingCart} <span>Variable Ausgaben</span></h2>
            
            <div class="mb-4">
              <button 
                id="openBrowserScanner" onclick="openReceiptScanner()"
                class="btn-primary w-full flex items-center justify-center gap-2"
                type="button">
                <svg aria-hidden="true" focusable="false" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                Bon scannen
              </button>
            </div>
            <div class="grid grid-cols-1 gap-3 mb-4">
              <!-- Mobile: 1 Spalte, Desktop: 3 Spalten -->
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <input type="date" id="ausgDatum" value="${this.getTodayDateString()}" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <input type="text" id="ausgName" placeholder="Beschreibung" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <input type="number" id="ausgBetrag" placeholder="Betrag" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <select id="ausgKat" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  ${this.kategorien.map(k => `<option value="${k}">${k}</option>`).join('')}
                </select>
                <select id="ausgBenutzer" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  ${Object.values(this.benutzer).map(u => `
                    <option value="${u.id}" ${u.id === this.aktiverBenutzer ? 'selected' : ''}>
                      ${u.emoji} ${u.name}
                    </option>
                  `).join('')}
                </select>
                <button onclick="app.addAusgabeFromForm()" class="btn-primary px-6 py-2 flex items-center justify-center gap-2">
                  ${icons.plus} Hinzuf√ºgen
                </button>
              </div>
            </div>
            <details class="wallit-accordion mt-4" id="monthAusgabenAccordion">
              <summary>
                  <div class="min-w-0 flex flex-col">
                    <div class="flex items-center gap-3 min-w-0">
                      <div class="wallit-accordion__title">Ausgaben-Details</div>
                      <div class="wallit-accordion__meta hidden sm:inline-flex">
                        <span>${ausgaben.length} Eintr√§ge</span>
                        <span>‚Ä¢</span>
                        <span>${this.formatCurrency(ausgabenSum)}</span>
                      </div>
                    </div>
                    <div class="wallit-accordion__meta mt-1 sm:hidden">
                      <span>${ausgaben.length} Eintr√§ge</span>
                      <span>‚Ä¢</span>
                      <span>${this.formatCurrency(ausgabenSum)}</span>
                    </div>
                  </div>
                  <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
              <div class="wallit-accordion__body">
                <div class="space-y-3 month-ausgaben-list">

              ${ausgaben.map(a => `
                <!-- Mobile: Card / Desktop: Horizontal -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                  <!-- Desktop (>= 768px) -->
                  <div class="hidden md:flex items-center justify-between p-3">
                    <div class="flex-1 flex items-center gap-2 flex-wrap">
                      <span class="font-semibold text-gray-700">${h(a.name)}</span>
                      <span class="kpi-sub text-[color:var(--text-tertiary)]">(${h(a.kategorie)})</span>
                      ${a.benutzer && this.benutzer[a.benutzer] ? `
                        <span class="kpi-sub px-2 py-1 rounded inline-block" 
                           style="background: ${this.benutzer[a.benutzer].farbe}20; 
                               color: ${this.benutzer[a.benutzer].farbe}; 
                               border: 1px solid ${this.benutzer[a.benutzer].farbe}40;">
                          ${h(this.benutzer[a.benutzer].emoji)} ${h(this.benutzer[a.benutzer].name)}
                        </span>
                      ` : ''}
                      <span class="kpi-sub text-[color:var(--text-tertiary)]">${this.formatDate(a.datum)}</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <span class="font-bold text-[color:var(--text-primary)]">${this.formatCurrency(a.betrag)}</span>
                      <button onclick="app.editAusgabe('${this.currentMonth}', ${a.id})" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bearbeiten">
                        ${icons.edit}
                      </button>
                      <button onclick="app.deleteAusgabe('${this.currentMonth}', ${a.id})" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" title="L√∂schen">
                        ${icons.trash}
                      </button>
                    </div>
                  </div>
                  
                  <!-- Mobile (< 768px) -->
                  <div class="md:hidden p-4">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex-1">
                        <div class="font-semibold text-[color:var(--text-primary)] text-base">${h(a.name)}</div>
                        <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">${h(a.kategorie)}</div>
                        <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">${this.formatDate(a.datum)}</div>
                      </div>
                      <div class="text-lg font-bold text-[color:var(--text-primary)] ml-3">
                        ${this.formatCurrency(a.betrag)}
                      </div>
                    </div>
                    ${a.benutzer && this.benutzer[a.benutzer] ? `
                      <div class="mb-3">
                        <span class="kpi-sub px-2 py-1 rounded inline-flex items-center gap-1" 
                           style="background: ${this.benutzer[a.benutzer].farbe}20; 
                               color: ${this.benutzer[a.benutzer].farbe}; 
                               border: 1px solid ${this.benutzer[a.benutzer].farbe}40;">
                          ${h(this.benutzer[a.benutzer].emoji)} ${h(this.benutzer[a.benutzer].name)}
                        </span>
                      </div>
                    ` : ''}
                    <div class="flex gap-2">
                      <button onclick="app.editAusgabe('${this.currentMonth}', ${a.id})" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold flex items-center justify-center gap-2">
                        ${icons.edit} Bearbeiten
                      </button>
                      <button onclick="app.deleteAusgabe('${this.currentMonth}', ${a.id})" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center" title="L√∂schen">
                        ${icons.trash}
                      </button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
              </div>
            </details>
          </div>


          <!-- Vorlagen -->
          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <div class="flex items-center justify-between mb-4">
              <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)]">${icons.fileText} <span>Ausgaben-Vorlagen</span></h2>
              <button onclick="app.setTab('stammdaten')" class="text-sm px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors font-semibold">
                Verwalten ‚Üí
              </button>
            </div>
            
            <!-- Vorlagen Liste - nur Verwenden -->
            ${(() => {
              if (this.ausgabenVorlagen.length === 0) {
                return '<p class="text-[color:var(--text-tertiary)] text-center py-8">Keine Vorlagen vorhanden. <a href="#" onclick="app.setTab(\'stammdaten\'); return false;" class="text-indigo-600 hover:underline font-semibold">Erstelle eine Vorlage</a></p>';
              }
              return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  ${this.ausgabenVorlagen.map(v => `
                    <button onclick="app.useVorlage(${v.id})" class="flex items-center gap-3 bg-gray-50 border-2 border-gray-200 p-4 rounded-xl hover:border-green-400 hover:bg-green-50 transition-all text-left group w-full">
                    <div class="text-2xl group-hover:scale-110 transition-transform">${icons.star}</div>
                    <div class="flex-1 min-w-0">
                      <div class="font-bold text-[color:var(--text-primary)] text-base truncate">${v.name}</div>
                      <div class="text-sm text-[color:var(--text-tertiary)]">${v.kategorie}</div>
                      <div class="text-lg font-bold text-green-600 mt-1">${this.formatCurrency(v.betrag)}</div>
                    </div>
                    <div class="text-green-500 opacity-0 group-hover:opacity-100 transition-opacity text-2xl">
                      ${icons.check}
                    </div>
                    </button>
                  `).join('')}
                </div>
              `;
            })()}
          </div>

          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${this.getCurrentCurrencyIcon()} <span>Zusatzeinkommen</span></h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 mb-4">
              <input type="date" id="zusatzDatum" value="${this.getTodayDateString()}" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              <input type="text" id="zusatzName" placeholder="Quelle" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              <input type="number" id="zusatzBetrag" placeholder="Betrag" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              <button onclick="app.addZusatzeinkommenFromForm()" class="btn-primary px-6 py-2 flex items-center justify-center gap-2">
                ${icons.plus} Hinzuf√ºgen
              </button>
            </div>
            <div class="space-y-3">
              ${zusatzeinkommen.map(z => `
                <!-- Mobile: Card / Desktop: Horizontal -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                  <!-- Desktop (>= 768px) -->
                  <div class="hidden md:flex items-center justify-between p-3">
                    <div class="flex-1">
                      <span class="font-semibold text-gray-700">${z.name}</span>
                      <span class="kpi-sub text-[color:var(--text-tertiary)] ml-3">${this.formatDate(z.datum)}</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <span class="font-bold text-[color:var(--text-primary)]">${this.formatCurrency(z.betrag)}</span>
                      <button onclick="app.deleteZusatzeinkommen('${this.currentMonth}', ${z.id})" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" title="L√∂schen">
                        ${icons.trash}
                      </button>
                    </div>
                  </div>
                  
                  <!-- Mobile (< 768px) -->
                  <div class="md:hidden p-4">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex-1">
                        <div class="font-semibold text-[color:var(--text-primary)] text-base">${z.name}</div>
                        <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">${this.formatDate(z.datum)}</div>
                      </div>
                      <div class="text-lg font-bold text-[color:var(--text-primary)] ml-3">
                        ${this.formatCurrency(z.betrag)}
                      </div>
                    </div>
                    <button onclick="app.deleteZusatzeinkommen('${this.currentMonth}', ${z.id})" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-semibold flex items-center justify-center gap-2">
                      ${icons.trash} L√∂schen
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.briefcase} <span>Einkommen pro Person</span></h2>
            <p class="text-sm text-[color:var(--text-tertiary)] mb-3">Das Standard-Einkommen wird automatisch verwendet. √Ñndere es hier f√ºr diesen Monat oder in den Stammdaten.</p>
            <div class="space-y-3">
              ${Object.values(this.benutzer).map(user => {
                const einkommenMonth = this.einkommenAll[this.currentMonth] || {};
                const userEinkommen = einkommenMonth[user.id] || this.standardEinkommen?.[user.id] || 0;
                const isStandard = !einkommenMonth[user.id] && this.standardEinkommen?.[user.id];
                return `
                  <!-- Mobile: Card Layout / Desktop: Horizontal -->
                  <div class="bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                    <!-- Desktop Layout (>= 768px) -->
                    <div class="hidden md:flex items-center justify-between p-3">
                      <div class="flex items-center gap-3 flex-1">
                        <span style="font-size: 20px;">${user.emoji}</span>
                        <span class="font-semibold text-gray-700">${user.name}</span>
                        ${isStandard ? '<span class="kpi-sub px-2 py-1 bg-blue-50 text-blue-600 rounded border border-blue-200">Standard</span>' : ''}
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="font-bold text-[color:var(--text-primary)]">${this.formatCurrency(userEinkommen)}</span>
                        <button onclick="app.editMonthEinkommen('${user.id}')" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bearbeiten">
                          ${icons.edit}
                        </button>
                        ${!isStandard && this.standardEinkommen?.[user.id] ? `
                          <button onclick="app.resetToStandardEinkommen('${user.id}')" class="p-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors" title="Auf Standard zur√ºcksetzen">
                            ${icons.refresh}
                          </button>
                        ` : ''}
                      </div>
                    </div>
                    
                    <!-- Mobile Layout (< 768px) -->
                    <div class="md:hidden p-4">
                      <!-- Header: Name + Betrag -->
                      <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2">
                          <span style="font-size: 20px;">${user.emoji}</span>
                          <span class="font-semibold text-[color:var(--text-primary)]">${user.name}</span>
                        </div>
                        <div class="text-xl font-bold text-[color:var(--text-primary)]">
                          ${this.formatCurrency(userEinkommen)}
                        </div>
                      </div>
                      
                      <!-- Badge -->
                      ${isStandard ? '<div class="mb-3"><span class="kpi-sub px-2 py-1 bg-blue-50 text-blue-600 rounded border border-blue-200">Standard</span></div>' : ''}
                      
                      <!-- Buttons -->
                      <div class="flex gap-2">
                        <button onclick="app.editMonthEinkommen('${user.id}')" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold flex items-center justify-center gap-2">
                          ${icons.edit} Bearbeiten
                        </button>
                        ${!isStandard && this.standardEinkommen?.[user.id] ? `
                          <button onclick="app.resetToStandardEinkommen('${user.id}')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors flex items-center justify-center" title="Auf Standard zur√ºcksetzen">
                            ${icons.refresh}
                          </button>
                        ` : ''}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            <div class="mt-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                <span class="text-sm font-semibold text-indigo-700">Gesamt-Haushaltseinkommen:</span>
                <span class="text-2xl sm:text-xl font-bold text-indigo-800">
                  ${(() => {
                    const einkommenMonth = this.einkommenAll[this.currentMonth] || {};
                    let total = 0;
                    Object.keys(this.benutzer).forEach(userId => {
                      const userEinkommen = einkommenMonth[userId] || this.standardEinkommen?.[userId] || 0;
                      total += userEinkommen;
                    });
                    return total.toFixed(2);
                  })()} ‚Ç¨
                </span>
              </div>
            </div>
          </div>
          <!-- Top 5 Ausgaben -->
          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.award} <span>Top 5 Ausgaben</span></h2>
            ${(() => {
              const top5 = this.getTop5Ausgaben(this.currentMonth);
              if (top5.length === 0) {
                return '<p class="text-[color:var(--text-tertiary)] text-center py-8">Noch keine Ausgaben vorhanden</p>';
              }
              return `
                <div class="space-y-3">
                  ${top5.map((ausgabe, index) => `
                    <div class="flex items-center gap-3 p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border border-gray-200">
                    <div class="kpi-value text-indigo-600 w-8">#${index + 1}</div>
                    <div class="flex-1">
                      <div class="font-semibold text-[color:var(--text-primary)]">${ausgabe.name}</div>
                      <div class="kpi-sub text-[color:var(--text-tertiary)]">${ausgabe.kategorie} ‚Ä¢ ${this.formatDate(ausgabe.datum)}</div>
                    </div>
                    <div class="text-xl font-bold text-gray-700">${this.formatCurrency(ausgabe.betrag)}</div>
                    </div>
                  `).join('')}
                </div>
              `;
            })()}
          </div>

          <!-- Monats-Statistiken am Ende -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-md border border-blue-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-blue-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.briefcase}</span> <span class="break-words">Einkommen</span></div>
              <div class="kpi-value text-blue-800">${this.formatCurrency(stats.einkommen)}</div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl shadow-md border border-green-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-green-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${this.getCurrentCurrencyIcon()}</span> <span class="break-words">Zusatzeinkommen</span></div>
              <div class="kpi-value text-green-800">${this.formatCurrency(stats.zusatzeinkommen)}</div>
            </div>
            <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl shadow-md border border-red-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-red-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.home}</span> <span class="break-words">Fixkosten</span></div>
              <div class="kpi-value text-red-800">${this.formatCurrency(stats.fixkosten)}</div>
            </div>
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl shadow-md border border-orange-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-orange-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.shoppingCart}</span> <span class="break-words">Variable Ausgaben</span></div>
              <div class="kpi-value text-orange-800">${this.formatCurrency(stats.ausgaben)}</div>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl shadow-md border border-purple-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-purple-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.barChart}</span> <span class="break-words">Sparraten</span></div>
              <div class="kpi-value text-purple-800">${this.formatCurrency(monatlicheSparraten)}</div>
            </div>
            <div class="bg-gradient-to-br ${stats.verfuegbar >= 0 ? 'from-emerald-50 to-emerald-100 border-emerald-200' : 'from-red-50 to-red-100 border-red-200'} p-6 rounded-xl shadow-md border">
              <div class="flex items-center gap-2 kpi-label font-semibold ${stats.verfuegbar >= 0 ? 'text-emerald-700' : 'text-red-700'} mb-1">${icons.gem} <span>Verf√ºgbar</span></div>
              <div class="kpi-value ${stats.verfuegbar >= 0 ? 'text-emerald-800' : 'text-red-800'}">
                ${this.formatCurrency(stats.verfuegbar)}
              </div>
            </div>
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-xl shadow-md border border-indigo-200 col-span-1 md:col-span-2">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-indigo-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.trendingUp}</span> <span class="break-words">Sparquote</span></div>
              <div class="flex items-center gap-3">
                <div class="kpi-value text-indigo-800">
                  ${stats.gesamtEinkommen > 0 ? ((stats.verfuegbar / stats.gesamtEinkommen) * 100).toFixed(1) : '0.0'}%
                </div>
                <div class="flex-1 bg-indigo-200 rounded-full h-4 overflow-hidden border-2 border-indigo-300">
                  <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-600 transition-all shadow-inner" 
                     style="width: ${stats.gesamtEinkommen > 0 ? Math.min(((stats.verfuegbar / stats.gesamtEinkommen) * 100), 100) : 0}%">
                  </div>
                </div>
              </div>
            </div>

          </div>
          </div>
        `;
      }

      renderYearView() {
        const ys = this.getYearlyStats();
        const totalIncome = ys.totalEinkommen + ys.totalZusatzeinkommen;
        const totalLoad = (ys.totalFixkosten + ys.totalAusgaben + ys.totalSparraten + (ys.totalKreditraten || 0));
        const avgSparquote = ys.sparquoteData.reduce((a, b) => a + b, 0) / 12;

        // Top categories (year)
        const topCats = Object.entries(ys.categoryTotals || {})
          .sort((a,b) => (b[1]||0) - (a[1]||0))
          .slice(0, 6);

        return `
          <div class="space-y-6">
            <!-- Jahres-Navigation -->
            <div class="flex items-center justify-center gap-4 bg-white p-4 rounded-xl shadow-md border border-gray-200">
              <button onclick="app.changeYear(-1)" class="p-3 hover:bg-gray-100 rounded-lg transition-colors text-gray-700" aria-label="Vorheriges Jahr">
                ${icons.chevronLeft}
              </button>
              <div class="kpi-value month-nav-title text-[color:var(--text-primary)] min-w-[140px] sm:min-w-[220px] text-center">
                ${this.currentYear}
              </div>
              <button onclick="app.changeYear(1)" class="p-3 hover:bg-gray-100 rounded-lg transition-colors text-gray-700" aria-label="N√§chstes Jahr">
                ${icons.chevronRight}
              </button>
            </div>

            <!-- Summary (immer 2 Spalten ab Desktop) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-6 rounded-2xl shadow-lg border border-emerald-200">
                <div class="flex items-center gap-2 kpi-label text-emerald-700 font-semibold mb-2">${this.getCurrentCurrencyIcon()} <span>Einkommen gesamt</span></div>
                <div class="kpi-value text-emerald-800">${this.formatCurrency(totalIncome)}</div>
                <div class="kpi-sub text-emerald-600 mt-2">‚àÖ ${(totalIncome / 12).toFixed(2)} ‚Ç¨ / Monat</div>
              </div>

              <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-2xl shadow-lg border border-red-200">
                <div class="flex items-center gap-2 kpi-label text-red-700 font-semibold mb-2">${icons.trash} <span>Belastung gesamt</span></div>
                <div class="kpi-value text-red-800">${this.formatCurrency(totalLoad)}</div>
                <div class="kpi-sub text-red-600 mt-2">Fixkosten + Variabel + Sparraten + Kreditraten</div>
              </div>

              <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-2xl shadow-lg border border-indigo-200">
                <div class="flex items-center gap-2 kpi-label text-indigo-700 font-semibold mb-2">${icons.trending} <span>√ò Sparquote</span></div>
                <div class="kpi-value text-indigo-800">${avgSparquote.toFixed(1)}%</div>
                <div class="kpi-sub text-indigo-600 mt-2">auf Basis ‚Äûverf√ºgbar / Einkommen‚Äú</div>
              </div>

              <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-2xl shadow-lg border border-blue-200">
                <div class="flex items-center gap-2 kpi-label text-blue-700 font-semibold mb-2">${this.getCurrentCurrencyIcon()} <span>Verf√ºgbar (Jahr)</span></div>
                <div class="kpi-value text-blue-800">${this.formatCurrency(ys.totalVerfuegbar)}</div>
                <div class="kpi-sub text-blue-600 mt-2">nach allen Ausgaben, Sparraten & Krediten</div>
              </div>
            </div>

            <!-- Breakdown -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-white p-5 rounded-2xl shadow-md border border-gray-200">
                <div class="kpi-label font-semibold mb-3 text-[color:var(--text-primary)]">Aufteilung (Jahr)</div>
                <div class="grid grid-cols-2 gap-3">
                  <div class="p-3 rounded-xl bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200">
                    <div class="text-xs font-semibold text-red-700 mb-1">Fixkosten</div>
                    <div class="text-base font-extrabold text-red-900">${this.formatCurrency(ys.totalFixkosten)}</div>
                  </div>
                  <div class="p-3 rounded-xl bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200">
                    <div class="text-xs font-semibold text-orange-700 mb-1">Variabel</div>
                    <div class="text-base font-extrabold text-orange-900">${this.formatCurrency(ys.totalAusgaben)}</div>
                  </div>
                  <div class="p-3 rounded-xl bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200">
                    <div class="text-xs font-semibold text-green-700 mb-1">Sparraten</div>
                    <div class="text-base font-extrabold text-green-900">${this.formatCurrency(ys.totalSparraten)}</div>
                  </div>
                  <div class="p-3 rounded-xl bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200">
                    <div class="text-xs font-semibold text-purple-700 mb-1">Kreditraten</div>
                    <div class="text-base font-extrabold text-purple-900">${this.formatCurrency(ys.totalKreditraten || 0)}</div>
                  </div>
                </div>
              </div>

              <div class="bg-white p-5 rounded-2xl shadow-md border border-gray-200">
                <div class="kpi-label font-semibold mb-3 text-[color:var(--text-primary)]">Top-Kategorien (Variabel)</div>
                ${topCats.length ? `
                  <div class="space-y-2">
                    ${topCats.map(([k,v]) => `
                      <div class="flex items-center justify-between gap-3 p-3 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200">
                        <div class="text-sm font-semibold text-blue-900 truncate">${this.escapeHtml(k)}</div>
                        <div class="text-sm font-extrabold text-indigo-900 whitespace-nowrap">${this.formatCurrency(v)}</div>
                      </div>
                    `).join('')}
                  </div>
                ` : `
                  <div class="text-sm text-[color:var(--text-tertiary)]">Keine variablen Ausgaben im Jahr.</div>
                `}
              </div>
            </div>

            <!-- Charts as accordions (Wallit style) -->
            <details class="wallit-accordion" open>
              <summary class="accordion-summary">
                <div class="flex items-center gap-3">
                  <div class="wallit-accordion__title">Monatsvergleich</div>
                  <div class="wallit-accordion__meta">
                    <span>Einkommen vs. Ausgaben</span>
                  </div>
                </div>
                <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="wallit-accordion__body">
                <div class="wallit-accordion-item">
                  <canvas id="monthlyChart" height="140"></canvas>
                </div>
              </div>
            </details>

            <details class="wallit-accordion" open>
              <summary class="accordion-summary">
                <div class="flex items-center gap-3">
                  <div class="wallit-accordion__title">Sparquote</div>
                  <div class="wallit-accordion__meta"><span>Monatlicher Verlauf</span></div>
                </div>
                <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="wallit-accordion__body">
                <div class="wallit-accordion-item">
                  <canvas id="sparquoteChart" height="140"></canvas>
                </div>
              </div>
            </details>

            <details class="wallit-accordion" open>
              <summary class="accordion-summary">
                <div class="flex items-center gap-3">
                  <div class="wallit-accordion__title">Kategorien</div>
                  <div class="wallit-accordion__meta"><span>Variable Ausgaben</span></div>
                </div>
                <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="wallit-accordion__body">
                <div class="wallit-accordion-item">
                  <div class="flex flex-col sm:flex-row gap-4 sm:items-start items-center">
                    <div class="w-full sm:w-[340px] max-w-[380px]">
                      <canvas id="categoryChart" height="180"></canvas>
                    </div>
                    <div id="categoryLegend" class="w-full sm:flex-1 space-y-2"></div>
                  </div>
                </div>
              </div>
            </details>
            
            <details class="wallit-accordion" open>
              <summary class="accordion-summary">
                <div class="flex items-center gap-3">
                  <div class="wallit-accordion__title">Geldfluss</div>
                  <div class="wallit-accordion__meta"><span>Alle Ausgaben im Detail</span></div>
                </div>
                <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </summary>
              <div class="wallit-accordion__body">
                <div class="wallit-accordion-item">
                  <canvas id="cashflowChart" height="200"></canvas>
                </div>
              </div>
            </details>
          </div>
        `;
      }

      renderInvestmentsView() {
        const gesamtAnlagen = this.sparkonten.reduce((sum, k) => sum + k.aktuellerStand, 0);
        const monatlicheRate = this.getMonatlicheSparraten();

        return `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-xl shadow-md border border-indigo-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-indigo-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.gem}</span> <span class="break-words">Gesamtverm√∂gen</span></div>
              <div class="kpi-value text-indigo-800">${this.formatCurrency(gesamtAnlagen)}</div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl shadow-md border border-green-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-green-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.barChart}</span> <span class="break-words">Monatliche Sparrate</span></div>
              <div class="kpi-value text-green-800">${this.formatCurrency(monatlicheRate)}</div>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl shadow-md border border-purple-200">
              <div class="flex items-start gap-2 kpi-sub sm:text-sm text-purple-700 font-semibold mb-1 leading-tight"><span class="w-5 h-5 flex items-center justify-center shrink-0 mt-0.5">${icons.briefcase}</span> <span class="break-words">Aktive Konten</span></div>
              <div class="kpi-value text-purple-800">${this.sparkonten.length}</div>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 mb-6">
            <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.plus} <span>Neues Sparkonto</span></h2>
            <div class="space-y-3">
              <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                <input type="text" id="kontoName" placeholder="Name (z.B. ETF Sparplan)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <select id="kontoTyp" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <option value="Sparen">${this.getCurrentCurrencyIcon()} Sparen</option>
                  <option value="ETF">${icons.trendingUp} ETF</option>
                  <option value="Aktien">${icons.barChart} Aktien</option>
                  <option value="Festgeld">${icons.bank} Festgeld</option>
                  <option value="Tagesgeld">${icons.creditCard} Tagesgeld</option>
                  <option value="Krypto">‚Çø Krypto</option>
                </select>
                <input type="number" id="kontoZiel" placeholder="Sparziel (optional)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <input type="color" id="kontoFarbe" value="#667eea">
              </div>
              <div class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <span class="font-semibold text-gray-700">Teilnehmer:</span>
                <div class="flex flex-wrap gap-3">${Object.values(this.benutzer).map(u => `
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="kontoTeilnehmer" value="${u.id}" ${u.id === this.aktiverBenutzer ? 'checked' : ''}>
                    <span class="text-sm">${u.emoji} ${u.name}</span>
                  </label>
                `).join('')}</div>
                <button onclick="app.addSparkontoFromForm()" class="btn-primary sm:ml-auto px-6 py-2 w-full sm:w-auto">
                  Konto erstellen
                </button>
              </div>
            </div>
          </div>

          ${this.sparkonten.length > 0 ? `
            <div class="grid grid-cols-1 gap-6 mb-6">
              ${this.sparkonten.map(konto => {
                const bewegungen = this.kontobewegungen[konto.id] || [];
                const sparraten = this.sparraten.filter(r => r.kontoId === konto.id && r.aktiv);
                const fortschritt = konto.ziel > 0 ? (konto.aktuellerStand / konto.ziel) * 100 : 0;
                
                return `
                  <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-200">
                    <div class="flex items-start justify-between mb-4">
                      <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full" style="background: ${konto.farbe};"></div>
                        <div>
                          <h3 class="text-xl font-bold text-[color:var(--text-primary)]">${konto.name}</h3>
                          <p class="text-sm text-[color:var(--text-tertiary)]">${konto.typ}</p>
                          ${(() => {
                            const teilnehmer = konto.teilnehmer || (konto.benutzer ? [konto.benutzer] : []);
                            if (teilnehmer.length === 0) return '';
                            
                            return `<div class="flex flex-wrap gap-1 mt-1">
                              ${teilnehmer.map(userId => {
                                const user = this.benutzer[userId];
                                if (!user) return '';
                                return `<span class="kpi-sub px-2 py-1 rounded inline-block" 
                                   style="background: ${user.farbe}20; 
                                       color: ${user.farbe}; 
                                       border: 1px solid ${user.farbe}40;">
                                  ${user.emoji} ${user.name}
                                </span>`;
                              }).join('')}
                            </div>`;
                          })()}
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button onclick="app.editSparkonto(${konto.id})" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bearbeiten">
                          ${icons.edit}
                        </button>
                        <button onclick="app.deleteSparkonto(${konto.id})" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" title="L√∂schen">
                          ${icons.trash}
                        </button>
                      </div>
                    </div>
                    
                    <div class="mb-4">
                      <div class="kpi-value mb-1" style="color: ${konto.farbe};">
                        ${this.formatCurrency(konto.aktuellerStand)}
                      </div>
                      ${konto.ziel > 0 ? `
                        <div class="kpi-sub text-[color:var(--text-tertiary)] mb-2">Ziel: ${this.formatCurrency(konto.ziel)}</div>
                        <div class="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                          <div class="h-full transition-all" 
                             style="width: ${Math.min(fortschritt, 100)}%; background: ${konto.farbe};">
                          </div>
                        </div>
                        <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">${fortschritt.toFixed(1)}% erreicht</div>
                      ` : ''}
                    </div>

                    ${sparraten.length > 0 ? `
                      <div class="mb-4">
                        <div class="kpi-sub text-[color:var(--text-tertiary)] font-bold mb-2">Aktive Sparraten:</div>
                        ${sparraten.map(rate => `
                          <div class="flex items-center justify-between bg-gray-50 p-2 rounded mb-1 text-sm">
                            <div class="flex items-center gap-2 flex-1">
                              <span class="text-gray-700 font-semibold">${this.formatCurrency(rate.betrag)}</span>
                              <span class="text-[color:var(--text-tertiary)]">${rate.intervall}</span>
                              ${rate.benutzer && this.benutzer[rate.benutzer] ? `
                                <span class="kpi-sub px-2 py-0.5 rounded" 
                                   style="background: ${this.benutzer[rate.benutzer].farbe}20; 
                                       color: ${this.benutzer[rate.benutzer].farbe}; 
                                       border: 1px solid ${this.benutzer[rate.benutzer].farbe}40;">
                                  ${this.benutzer[rate.benutzer].emoji} ${this.benutzer[rate.benutzer].name}
                                </span>
                              ` : ''}
                            </div>
                            <div class="flex gap-3">
                              <button onclick="app.editSparrate(${rate.id})" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bearbeiten">
                                ${icons.edit}
                              </button>
                              <button onclick="app.deleteSparrate(${rate.id})" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" title="L√∂schen">
                                ${icons.trash}
                              </button>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                      <input type="number" id="sparrate_${konto.id}" placeholder="Betrag" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                      <select id="sparrate_intervall_${konto.id}" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="monatlich">Monatlich</option>
                        <option value="viertelj√§hrlich">Viertelj√§hrlich</option>
                        <option value="j√§hrlich">J√§hrlich</option>
                      </select>
                      <select id="sparrate_benutzer_${konto.id}" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                        ${Object.values(this.benutzer).map(u => `
                          <option value="${u.id}" ${u.id === this.aktiverBenutzer ? 'selected' : ''}>
                            ${u.emoji} ${u.name}
                          </option>
                        `).join('')}
                      </select>
                      <button onclick="app.addSparrateFromForm(${konto.id})" class="btn-primary px-4 py-2">
                        + Rate
                      </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                      <input type="date" id="bewegung_datum_${konto.id}" value="${new Date().toISOString().split('T')[0]}" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                      <input type="number" id="bewegung_betrag_${konto.id}" placeholder="Betrag" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                      <input type="text" id="bewegung_beschreibung_${konto.id}" placeholder="Beschreibung" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                      <div class="flex gap-3">
                        <button onclick="app.addBewegungFromForm(${konto.id}, 'einzahlung')" 
                            class="flex-1 px-2 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center" 
                            title="Einzahlung">
                          ${icons.arrowUp}
                        </button>
                        <button onclick="app.addBewegungFromForm(${konto.id}, 'auszahlung')" 
                            class="flex-1 px-2 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center" 
                            title="Auszahlung">
                          ${icons.arrowDown}
                        </button>
                      </div>
                    </div>

                    ${bewegungen.length > 0 ? `
                      <div>
                        <div class="kpi-sub text-[color:var(--text-tertiary)] font-bold mb-2">Letzte Bewegungen:</div>
                        <div class="max-h-40 overflow-y-auto space-y-1">
                          ${[...bewegungen].reverse().slice(0, 10).map(b => `
                            <div class="flex items-center justify-between bg-gray-50 p-2 rounded kpi-sub">
                              <div class="flex items-center gap-2 flex-1">
                                <span class="${b.typ === 'einzahlung' ? 'text-green-600' : 'text-red-400'}">
                                  ${b.typ === 'einzahlung' ? icons.arrowUp : icons.arrowDown}
                                </span>
                                <span class="text-[color:var(--text-tertiary)]">${this.formatDate(b.datum)}</span>
                                <span class="text-gray-700">${b.beschreibung}</span>
                              </div>
                              <div class="flex items-center gap-2">
                                <span class="font-bold ${b.typ === 'einzahlung' ? 'text-green-600' : 'text-red-400'}">
                                  ${b.typ === 'einzahlung' ? '+' : '-'}${this.formatCurrency(b.betrag)}
                                </span>
                                <button onclick="app.deleteKontobewegung(${konto.id}, ${b.id})" 
                                    class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" 
                                    title="L√∂schen">
                                  ${icons.trash}
                                </button>
                              </div>
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
          ` : `
            <div class="bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-100">
              <div class="text-[color:var(--text-tertiary)] text-lg mb-2">Noch keine Sparkonten vorhanden</div>
              <div class="text-gray-400 text-sm">Erstelle dein erstes Sparkonto oben</div>
            </div>
          `}

          ${this.sparkonten.length > 0 ? `
            <div class="grid grid-cols-1 gap-6">
              <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                <h3 class="flex items-center gap-2 text-xl font-bold text-[color:var(--text-primary)] mb-4">${icons.target} <span>Verteilung</span></h3>
                <div style="height: 300px;">
                  <canvas id="investmentDistributionChart"></canvas>
                </div>
              </div>

              <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
                <h3 class="flex items-center gap-2 text-xl font-bold text-[color:var(--text-primary)] mb-4">${icons.trendingUp} <span>Entwicklung (12 Monate)</span></h3>
                <div style="height: 300px;">
                  <canvas id="investmentDevelopmentChart"></canvas>
                </div>
              </div>
            </div>
          ` : ''}
        `;
      }

      addSparkontoFromForm() {
        const name = document.getElementById('kontoName').value;
        const typ = document.getElementById('kontoTyp').value;
        const ziel = parseFloat(document.getElementById('kontoZiel').value) || 0;
        const farbe = document.getElementById('kontoFarbe').value;
        
        // Lese alle ausgew√§hlten Teilnehmer
        const checkboxes = document.querySelectorAll('input[name="kontoTeilnehmer"]:checked');
        const teilnehmer = Array.from(checkboxes).map(cb => cb.value);
        
        if (!name || !typ) {
          this.showRequiredFieldsModal();
          return;
        }
        
        if (teilnehmer.length === 0) {
          this.showRequiredFieldsModal();
          return;
        }
        
        this.addSparkonto(name, typ, ziel, farbe, teilnehmer);
        document.getElementById('kontoName').value = '';
        document.getElementById('kontoZiel').value = '';
        // Checkboxen zur√ºcksetzen - nur aktiver User bleibt selected
        document.querySelectorAll('input[name="kontoTeilnehmer"]').forEach(cb => {
          cb.checked = (cb.value === this.aktiverBenutzer);
        });
      }


      // ‚ôø MODAL ACCESSIBILITY (ESC, Fokus-Falle, ARIA)
      initModalObserver() {
        // Auto-enhance auch f√ºr "manuell" erzeugte Modals (editMonthEinkommen etc.)
        try {
          const obs = new MutationObserver((mutations) => {
            for (const m of mutations) {
              for (const node of m.addedNodes) {
                if (node && node.classList && node.classList.contains('modal-overlay')) {
                  this.enhanceModalAccessibility(node);
                }
              }
            }
          });
          obs.observe(document.body, { childList: true });
          this._modalObserver = obs;
        } catch (e) {
          console.warn('ModalObserver nicht verf√ºgbar:', e);
        }
      }

      enhanceModalAccessibility(modal) {
        if (!modal || modal._a11yEnhanced) return;
        modal._a11yEnhanced = true;

        const content = modal.querySelector('.modal-content') || modal.firstElementChild;
        if (content) {
          content.setAttribute('role', 'dialog');
          if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex','-1');
          content.setAttribute('aria-modal', 'true');

          // Titel als aria-labelledby nutzen, wenn vorhanden
          const heading = content.querySelector('h1,h2,h3,[data-modal-title]');
          if (heading) {
            if (!heading.id) heading.id = 'modal_title_' + Math.random().toString(36).slice(2);
            content.setAttribute('aria-labelledby', heading.id);
          } else {
            content.setAttribute('aria-label', 'Dialog');
          }

          // Fokus initial setzen
          const focusable = this.getFocusableElements(content);
          const prevFocus = document.activeElement;
          modal._prevFocus = prevFocus;

          requestAnimationFrame(() => {
            (focusable[0] || content).focus?.();
          });

          // Fokus-Falle
          const onKeyDown = (e) => {
            if (e.key === 'Escape') {
              e.preventDefault();
              this.closeTopModal();
              return;
            }
            if (e.key !== 'Tab') return;

            const els = this.getFocusableElements(content);
            if (!els.length) return;

            const first = els[0];
            const last = els[els.length - 1];

            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          };

          modal._onKeyDown = onKeyDown;
          document.addEventListener('keydown', onKeyDown, true);

          // Cleanup bei Close (wenn entfernt)
          const cleanup = () => {
            try { document.removeEventListener('keydown', onKeyDown, true); } catch {}
            if (modal._prevFocus && modal._prevFocus.focus) {
              try { modal._prevFocus.focus(); } catch {}
            }
          };
          modal._cleanupA11y = cleanup;
        }

        // aria-label f√ºr Icon-Buttons (wenn title gesetzt ist)
        this.applyAriaLabels(modal);
      }

      getFocusableElements(root) {
        const sel = [
          'a[href]',
          'button:not([disabled])',
          'input:not([disabled])',
          'select:not([disabled])',
          'textarea:not([disabled])',
          '[tabindex]:not([tabindex="-1"])'
        ].join(',');
        return Array.from(root.querySelectorAll(sel))
          .filter(el => !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length));
      }

      closeTopModal() {
        const modals = Array.from(document.querySelectorAll('.modal-overlay'));
        const modal = modals[modals.length - 1];
        if (!modal) return;

        try {
          modal._cleanupA11y?.();
        } catch {}
        modal.remove();
      }

      applyAriaLabels(scope = document) {
        try {
          scope.querySelectorAll('button[title]:not([aria-label])').forEach(btn => {
            const t = btn.getAttribute('title');
            if (t) btn.setAttribute('aria-label', t);
          });
        } catch {}
      }

      addSparrateFromForm(kontoId) {
        const betrag = document.getElementById(`sparrate_${kontoId}`).value;
        const intervall = document.getElementById(`sparrate_intervall_${kontoId}`).value;
        const benutzer = document.getElementById(`sparrate_benutzer_${kontoId}`)?.value || this.aktiverBenutzer;
        
        if (betrag && parseFloat(betrag) > 0) {
          this.addSparrate(kontoId, betrag, intervall, null, benutzer);
          document.getElementById(`sparrate_${kontoId}`).value = '';
        }
        else {
          this.showRequiredFieldsModal();
        }
      }

      addBewegungFromForm(kontoId, typ) {
        const datum = document.getElementById(`bewegung_datum_${kontoId}`).value;
        const betrag = document.getElementById(`bewegung_betrag_${kontoId}`).value;
        const beschreibung = document.getElementById(`bewegung_beschreibung_${kontoId}`).value;
        
        if (datum && betrag && parseFloat(betrag) > 0) {
          this.addKontobewegung(kontoId, datum, betrag, typ, beschreibung);
          document.getElementById(`bewegung_betrag_${kontoId}`).value = '';
          document.getElementById(`bewegung_beschreibung_${kontoId}`).value = '';
        }
      }

      addFixkostenFromForm() {
        const name = document.getElementById('fixName').value;
        const betrag = document.getElementById('fixBetrag').value;
        const kategorie = document.getElementById('fixKat').value;
        const intervall = document.getElementById('fixIntervall')?.value || 'monatlich';
        const benutzer = document.getElementById('fixBenutzer')?.value || 'gemeinsam';

        if (name && betrag) {
          this.addFixkosten(name, betrag, kategorie, benutzer, intervall);
          document.getElementById('fixName').value = '';
          document.getElementById('fixBetrag').value = '';
        } else {
          this.showRequiredFieldsModal();
        }
      }


      addAusgabeFromForm() {
        const datum = document.getElementById('ausgDatum').value;
        const name = sanitizeText(document.getElementById('ausgName').value, 120);
        const betrag = parseAmount(document.getElementById('ausgBetrag').value);
        const kategorie = document.getElementById('ausgKat').value;
        const benutzer = document.getElementById('ausgBenutzer')?.value || this.aktiverBenutzer;

        if (datum && name && betrag) {
          this.addAusgabe(datum, name, betrag, kategorie, benutzer);
          document.getElementById('ausgDatum').value = this.getTodayDateString();
          document.getElementById('ausgName').value = '';
          document.getElementById('ausgBetrag').value = '';
        } else {
          this.showRequiredFieldsModal();
        }
      }


      addZusatzeinkommenFromForm() {
        const datum = document.getElementById('zusatzDatum').value;
        const name = sanitizeText(document.getElementById('zusatzName').value, 120);
        const betrag = parseAmount(document.getElementById('zusatzBetrag').value);

        if (datum && name && betrag) {
          this.addZusatzeinkommen(datum, name, betrag);
          document.getElementById('zusatzDatum').value = this.getTodayDateString();
          document.getElementById('zusatzName').value = '';
          document.getElementById('zusatzBetrag').value = '';
        } else {
          this.showRequiredFieldsModal();
        }
      }


      addVorlageFromForm() {
        const name = sanitizeText(document.getElementById('vorlName').value, 120);
        const betrag = parseAmount(document.getElementById('vorlBetrag').value);
        const kategorie = document.getElementById('vorlKat').value;
        if (name && betrag) {
          this.addVorlage(name, betrag, kategorie);
          document.getElementById('vorlName').value = '';
          document.getElementById('vorlBetrag').value = '';
        } else {
          this.showRequiredFieldsModal();
        }
      }

      renderStammdatenView() {
        const toMonthlyFix = (betrag, intervall) => {
          switch (intervall) {
            case 'viertelj√§hrlich': return betrag / 3;
            case 'halbj√§hrlich': return betrag / 6;
            case 'j√§hrlich': return betrag / 12;
            default: return betrag; // monatlich
          }
        };
        const fixkostenCount = (this.fixkosten || []).length;
        const fixkostenSumMonthly = (this.fixkosten || []).reduce((sum, f) => sum + toMonthlyFix((parseFloat(f.betrag) || 0), (f.intervall || 'monatlich')), 0);

        return `
          <div>
            <h2 class="flex items-center gap-2 text-3xl font-bold text-[color:var(--text-primary)] mb-6">${icons.settings} <span>Stammdaten & Einstellungen</span></h2>
            
            <!-- üí± W√§hrungs-Einstellungen -->
            <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 mb-6">
              <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">
                ${this.getCurrentCurrencyIcon()} <span>Einstellungen</span>
              </h2>
              
              <div class="grid md:grid-cols-2 gap-6">
                <!-- W√§hrung -->
                <div>
                  <label class="flex items-center gap-2 kpi-label font-semibold text-gray-700 mb-2">
                    ${icons.repeat} <span>W√§hrung</span>
                  </label>
                  <select 
                    id="currencySelect" 
                    onchange="app.changeCurrency(this.value)"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    ${Object.entries(this.currencies).map(([code, curr]) => `
                      <option value="${code}" ${this.settings.currency === code ? 'selected' : ''}>
                        ${curr.symbol} ${curr.name} (${code})
                      </option>
                    `).join('')}
                  </select>
                  <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">
                    Alle Betr√§ge werden in dieser W√§hrung angezeigt
                  </div>
                </div>
                
                <!-- Vorschau -->
                <div>
                  <label class="flex items-center gap-2 kpi-label font-semibold text-gray-700 mb-2">
                    ${icons.eye} <span>Vorschau</span>
                  </label>
                  <div class="p-4 bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg border border-indigo-200">
                    <div class="kpi-sub text-[color:var(--text-tertiary)] mb-1">Beispiel:</div>
                    <div class="kpi-value text-indigo-800">
                      ${this.formatCurrency(1234.56)}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Dark Mode Toggle -->
              <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center transition-all" style="background: ${this.darkMode ? 'rgba(102, 126, 234, 0.2)' : 'rgba(99, 102, 241, 0.1)'};">
                      <div style="color: ${this.darkMode ? '#a78bfa' : '#6366f1'};">
                        ${this.darkMode ? icons.moon : icons.sun}
                      </div>
                    </div>
                    <div>
                      <label class="text-sm font-semibold text-gray-700">Dark Mode</label>
                      <div class="kpi-sub text-[color:var(--text-tertiary)]">Dunkles Design f√ºr bessere Lesbarkeit</div>
                    </div>
                  </div>
                  <button 
                    onclick="app.toggleDarkMode()" 
                    class="dark-mode-switch ${this.darkMode ? 'active' : ''}"
                    role="switch"
                    aria-checked="${this.darkMode}">
                    <span class="dark-mode-switch-thumb"></span>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Standard-Einkommen pro Person -->
            <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 mb-6">
              <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.briefcase} <span>Standard-Einkommen pro Person</span></h2>
              <p class="text-sm text-[color:var(--text-tertiary)] mb-4">Dieses Einkommen wird automatisch f√ºr jeden Monat verwendet. Du kannst es im Monat-Tab bei Bedarf anpassen.</p>
              <div class="space-y-3">
                ${Object.values(this.benutzer).map(user => {
                  const standardEinkommen = this.standardEinkommen?.[user.id] || 0;
                  return `
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                      <div class="flex items-center gap-2 sm:min-w-[120px]">
                        <span style="font-size: 20px;">${user.emoji}</span>
                        <span class="font-semibold text-gray-700">${user.name}</span>
                      </div>
                      <input type="number" 
                          id="standard_einkommen_${user.id}" 
                          value="${standardEinkommen}" 
                          placeholder="0.00"
                          step="0.01"
                          min="0"
                          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                      <button onclick="window.app.saveStandardEinkommen('${user.id}')"
                          class="px-4 py-2 text-white rounded-lg font-semibold hover:shadow-lg transition-all whitespace-nowrap"
                          style="background: ${user.farbe}">
                        Speichern
                      </button>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>

            <!-- Fixkosten -->
            <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 mb-6">
              <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.home} <span>Fixkosten</span></h2>
              <p class="text-sm text-[color:var(--text-tertiary)] mb-4">Diese Kosten gelten automatisch f√ºr jeden Monat und werden in den Berechnungen ber√ºcksichtigt.</p>
              <div class="grid grid-cols-1 gap-3 mb-4">
                <!-- Zeile 1: Name, Betrag, Kategorie -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <input type="text" id="fixName" placeholder="Name" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <input type="number" id="fixBetrag" placeholder="Betrag" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <select id="fixKat" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    ${this.kategorien.map(k => `<option value="${k}">${k}</option>`).join('')}
                  </select>
                </div>
                <!-- Zeile 2: Intervall, Benutzer, Button -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <select id="fixIntervall" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="monatlich">Monatlich</option>
                    <option value="viertelj√§hrlich">Viertelj√§hrlich</option>
                    <option value="halbj√§hrlich">Halbj√§hrlich</option>
                    <option value="j√§hrlich">J√§hrlich</option>
                  </select>
                  <select id="fixBenutzer" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="gemeinsam">${icons.users} Gemeinsam</option>
                    ${Object.values(this.benutzer).map(u => `
                      <option value="${u.id}" ${u.id === this.aktiverBenutzer ? 'selected' : ''}>
                        ${u.emoji} ${u.name}
                      </option>
                    `).join('')}
                  </select>
                  <button onclick="app.addFixkostenFromForm()" class="btn-primary px-6 py-2 flex items-center justify-center gap-2">
                    ${icons.plus} Hinzuf√ºgen
                  </button>
                </div>
              </div>
              <details class="wallit-accordion mt-4" id="stammFixkostenAccordion">
                <summary>
                  <div class="min-w-0 flex flex-col">
                    <div class="flex items-center gap-3 min-w-0">
                      <div class="wallit-accordion__title">Fixkosten-Details</div>
                      <div class="wallit-accordion__meta hidden sm:inline-flex">
                        <span>${fixkostenCount} Eintr√§ge</span>
                        <span>‚Ä¢</span>
                        <span>${this.formatCurrency(fixkostenSumMonthly)}</span>
                        <span class="hidden sm:inline">/ Monat</span>
                      </div>
                    </div>
                    <div class="wallit-accordion__meta mt-1 sm:hidden">
                      <span>${fixkostenCount} Eintr√§ge</span>
                      <span>‚Ä¢</span>
                      <span>${this.formatCurrency(fixkostenSumMonthly)}</span>
                    </div>
                  </div>
                  <svg class="wallit-accordion__chev" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </summary>
                <div class="wallit-accordion__body">
                  <div class="space-y-3">
                    ${this.fixkosten.map(f => `
                  <!-- Mobile: Card Layout / Desktop: Horizontal -->
                  <div class="bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                    <!-- Desktop Layout (>= 768px) -->
                    <div class="hidden md:flex items-center justify-between p-3">
                      <div class="flex-1 flex items-center gap-3">
                        <div>
                          <span class="font-semibold text-gray-700">${f.name}</span>
                          <span class="kpi-sub text-[color:var(--text-tertiary)] ml-2">(${f.kategorie})</span>
                        </div>
                        ${f.benutzer ? `
                          <span class="kpi-sub px-2 py-1 rounded inline-flex items-center gap-1" 
                             style="background: ${f.benutzer === 'gemeinsam' ? '#f59e0b20' : (this.benutzer[f.benutzer]?.farbe + '20' || '#gray')}; 
                                 color: ${f.benutzer === 'gemeinsam' ? '#f59e0b' : (this.benutzer[f.benutzer]?.farbe || '#666')}; 
                                 border: 1px solid ${f.benutzer === 'gemeinsam' ? '#f59e0b40' : (this.benutzer[f.benutzer]?.farbe + '40' || '#gray')};">
                            ${f.benutzer === 'gemeinsam' ? icons.users + '<span>Gemeinsam</span>' : (this.benutzer[f.benutzer] ? this.benutzer[f.benutzer].emoji + ' ' + this.benutzer[f.benutzer].name : f.benutzer)}
                          </span>
                        ` : ''}
                        <span class="kpi-sub px-2 py-1 rounded border ${(f.intervall || 'monatlich') === 'monatlich' ? 'bg-gray-100 text-gray-700 border-gray-300' : 'bg-purple-50 text-purple-700 border-purple-200'}">
                          ${f.intervall || 'monatlich'}
                        </span>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="font-bold text-[color:var(--text-primary)]">${this.formatCurrency(f.betrag)}</span>
                        <button onclick="app.editFixkosten(${f.id})" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bearbeiten">
                          ${icons.edit}
                        </button>
                        <button onclick="app.deleteFixkosten(${f.id})" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" title="L√∂schen">
                          ${icons.trash}
                        </button>
                      </div>
                    </div>
                    
                    <!-- Mobile Layout (< 768px) -->
                    <div class="md:hidden p-4">
                      <!-- Header: Name + Betrag -->
                      <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                          <div class="font-semibold text-[color:var(--text-primary)] text-lg">${f.name}</div>
                          <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">${f.kategorie}</div>
                        </div>
                        <div class="text-xl font-bold text-[color:var(--text-primary)] ml-3">
                          ${this.formatCurrency(f.betrag)}
                        </div>
                      </div>
                      
                      <!-- Badges: User + Intervall -->
                      <div class="flex flex-wrap gap-2 mb-3">
                        ${f.benutzer ? `
                          <span class="kpi-sub px-2 py-1 rounded inline-flex items-center gap-1" 
                             style="background: ${f.benutzer === 'gemeinsam' ? '#f59e0b20' : (this.benutzer[f.benutzer]?.farbe + '20' || '#gray')}; 
                                 color: ${f.benutzer === 'gemeinsam' ? '#f59e0b' : (this.benutzer[f.benutzer]?.farbe || '#666')}; 
                                 border: 1px solid ${f.benutzer === 'gemeinsam' ? '#f59e0b40' : (this.benutzer[f.benutzer]?.farbe + '40' || '#gray')};">
                            ${f.benutzer === 'gemeinsam' ? icons.users + '<span>Gemeinsam</span>' : (this.benutzer[f.benutzer] ? this.benutzer[f.benutzer].emoji + ' ' + this.benutzer[f.benutzer].name : f.benutzer)}
                          </span>
                        ` : ''}
                        <span class="kpi-sub px-2 py-1 rounded border ${(f.intervall || 'monatlich') === 'monatlich' ? 'bg-gray-100 text-gray-700 border-gray-300' : 'bg-purple-50 text-purple-700 border-purple-200'}">
                          ${f.intervall || 'monatlich'}
                        </span>
                      </div>
                      
                      <!-- Buttons -->
                      <div class="flex gap-2">
                        <button onclick="app.editFixkosten(${f.id})" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold flex items-center justify-center gap-2">
                          ${icons.edit} Bearbeiten
                        </button>
                        <button onclick="app.deleteFixkosten(${f.id})" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center" title="L√∂schen">
                          ${icons.trash}
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
                  </div>
                </div>
              </details>
            </div>

            <!-- Kredite -->
            <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
              <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.creditCard} <span>Kredite & Darlehen</span></h2>
              <p class="text-sm text-[color:var(--text-tertiary)] mb-4">Verwalte deine laufenden Kredite und behalte die Restschuld im Blick.</p>
              
              <!-- Neuer Kredit -->
              <div class="grid grid-cols-1 gap-3 mb-4">
                <!-- Zeile 1: Name, Betrag, Zinssatz -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <input type="text" id="kreditName" placeholder="Name (z.B. Autokredit)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <input type="text" id="kreditBetrag" placeholder="Kreditbetrag (Netto)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" inputmode="decimal">
                  <div class="relative">
                    <input type="text" id="kreditGesamtbetrag" placeholder="Gesamtbetrag (optional)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent w-full" inputmode="decimal" style="padding-right: 40px;">
                    <button type="button" onclick="app.calculateTotalFromForm()" class="input-icon absolute right-0 top-0 bottom-0 w-10 flex items-center justify-center transition-colors pointer-events-auto" style="pointer-events: auto;" title="Aus Rate √ó Laufzeit berechnen">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="4" y="2" width="16" height="20" rx="2"/>
                        <line x1="8" y1="6" x2="16" y2="6"/>
                        <line x1="16" y1="14" x2="16" y2="18"/>
                        <path d="M16 10h.01"/>
                        <path d="M12 10h.01"/>
                        <path d="M8 10h.01"/>
                        <path d="M12 14h.01"/>
                        <path d="M8 14h.01"/>
                        <path d="M12 18h.01"/>
                        <path d="M8 18h.01"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <!-- Zeile 2: Zinssatz, Laufzeit, Startdatum -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <input type="text" id="kreditZins" placeholder="Zinssatz %" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" inputmode="decimal">
                  <input type="number" id="kreditLaufzeit" placeholder="Laufzeit (Monate)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <input type="date" id="kreditStart" value="${new Date().toISOString().split('T')[0]}" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <!-- Zeile 3: Rate mit Rechner -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div class="relative sm:col-span-1">
                    <input type="text" id="kreditRate" placeholder="Monatliche Rate" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent w-full" inputmode="decimal" style="padding-right: 40px;">
                    <button type="button" onclick="app.calculateRateFromForm()" class="input-icon absolute right-0 top-0 bottom-0 w-10 flex items-center justify-center transition-colors" style="pointer-events: auto;" title="Rate berechnen">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="4" y="2" width="16" height="20" rx="2"/>
                        <line x1="8" y1="6" x2="16" y2="6"/>
                        <line x1="16" y1="14" x2="16" y2="18"/>
                        <path d="M16 10h.01"/>
                        <path d="M12 10h.01"/>
                        <path d="M8 10h.01"/>
                        <path d="M12 14h.01"/>
                        <path d="M8 14h.01"/>
                        <path d="M12 18h.01"/>
                        <path d="M8 18h.01"/>
                      </svg>
                    </button>
                  </div>
                  <div class="hidden sm:block sm:col-span-2"></div>
                </div>
                <!-- Zeile 4: Kategorie, Benutzer, Button -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <select id="kreditKat" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="Auto">Auto</option>
                    <option value="Immobilie">Immobilie</option>
                    <option value="Konsumkredit">Konsumkredit</option>
                    <option value="Bildung">Bildung</option>
                    <option value="Sonstiges">Sonstiges</option>
                  </select>
                  <select id="kreditBenutzer" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <option value="gemeinsam">${icons.users} Gemeinsam</option>
                    ${Object.values(this.benutzer).map(u => `
                      <option value="${u.id}" ${u.id === this.aktiverBenutzer ? 'selected' : ''}>
                        ${u.emoji} ${u.name}
                      </option>
                    `).join('')}
                  </select>
                  <button onclick="app.addKreditFromForm()" class="btn-primary px-6 py-2 flex items-center justify-center gap-2">
                    ${icons.plus} Hinzuf√ºgen
                  </button>
                </div>
              </div>
              
              <!-- Kredite-Liste -->
              <div class="space-y-3">
                ${this.kredite.length === 0 ? `
                  <div class="text-center py-8 text-[color:var(--text-tertiary)]">
                    <p>Noch keine Kredite erfasst</p>
                  </div>
                ` : this.kredite.map(k => {
                  const details = this.calculateKreditDetails(k);
                  const katIcons = {
                    'Auto': icons.car,
                    'Immobilie': icons.building,
                    'Konsumkredit': icons.creditCard,
                    'Bildung': icons.book,
                    'Sonstiges': icons.dollarSign
                  };
                  
                  return `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-shadow p-4">
                      <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                          <div class="flex items-center gap-2 mb-1">
                            <span class="text-gray-700">${katIcons[k.kategorie] || icons.dollarSign}</span>
                            <h4 class="text-lg font-bold text-[color:var(--text-primary)]">${k.name}</h4>
                            ${details.isAbbezahlt ? '<span class="kpi-sub px-2 py-1 bg-green-100 text-green-700 rounded-full font-semibold">Abbezahlt</span>' : ''}
                          </div>
                          <p class="text-sm text-[color:var(--text-tertiary)]">${k.kategorie} ‚Ä¢ ${k.zinssatz.toString().replace('.', ',')}% Zinsen ‚Ä¢ ${k.laufzeit} Monate</p>
                          ${k.benutzer ? `
                            <span class="inline-block kpi-sub px-2 py-1 rounded mt-1" 
                               style="background: ${k.benutzer === 'gemeinsam' ? '#f59e0b20' : (this.benutzer[k.benutzer]?.farbe + '20' || '#gray')}; 
                                   color: ${k.benutzer === 'gemeinsam' ? '#f59e0b' : (this.benutzer[k.benutzer]?.farbe || '#666')}; 
                                   border: 1px solid ${k.benutzer === 'gemeinsam' ? '#f59e0b40' : (this.benutzer[k.benutzer]?.farbe + '40' || '#gray')};">
                              ${k.benutzer === 'gemeinsam' ? icons.users + ' Gemeinsam' : (this.benutzer[k.benutzer] ? this.benutzer[k.benutzer].emoji + ' ' + this.benutzer[k.benutzer].name : k.benutzer)}
                            </span>
                          ` : ''}
                        </div>
                        <div class="flex gap-2 ml-4">
                          <button onclick="app.editKredit(${k.id})" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bearbeiten">
                            ${icons.edit}
                          </button>
                          <button onclick="app.deleteKredit(${k.id})" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" title="L√∂schen">
                            ${icons.trash}
                          </button>
                        </div>
                      </div>
                      
                      <!-- Fortschrittsbalken -->
                      <div class="mb-3">
                        <div class="flex justify-between text-sm mb-1">
                          <span class="text-[color:var(--text-tertiary)]">Fortschritt</span>
                          <span class="font-semibold text-[color:var(--text-primary)]">${details.fortschritt.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                          <div class="h-full ${details.isAbbezahlt ? 'bg-green-500' : 'bg-indigo-600'} transition-all" style="width: ${Math.min(details.fortschritt, 100)}%"></div>
                        </div>
                      </div>
                      
                      <!-- Details Grid -->
                      <div class="grid grid-cols-2 ${k.gesamtbetrag ? 'md:grid-cols-5' : 'md:grid-cols-4'} gap-3 text-sm">
                        <div>
                          <div class="text-[color:var(--text-tertiary)] kpi-sub">Kreditbetrag</div>
                          <div class="font-bold text-base text-[color:var(--text-primary)]">${this.formatCurrency(k.betrag)}</div>
                        </div>
                        ${k.gesamtbetrag ? `
                          <div>
                            <div class="text-[color:var(--text-tertiary)] kpi-sub">Gesamtbetrag</div>
                            <div class="font-bold text-base text-orange-700">${this.formatCurrency(k.gesamtbetrag)}</div>
                          </div>
                        ` : ''}
                        <div>
                          <div class="text-[color:var(--text-tertiary)] kpi-sub">Restschuld</div>
                          <div class="font-bold text-base ${details.isAbbezahlt ? 'text-green-600' : 'text-red-400'}">
                            ${this.formatCurrency(details.restschuld)}
                          </div>
                        </div>
                        <div>
                          <div class="text-[color:var(--text-tertiary)] kpi-sub">Monatliche Rate</div>
                          <div class="font-bold text-base text-[color:var(--text-primary)]">${this.formatCurrency(k.rate)}</div>
                        </div>
                        <div>
                          <div class="text-[color:var(--text-tertiary)] kpi-sub">${k.gesamtbetrag ? 'Mehrkosten' : 'Gesamtzinsen'}</div>
                          <div class="font-bold text-base text-[color:var(--text-primary)]">${this.formatCurrency(k.gesamtbetrag ? (k.gesamtbetrag - k.betrag) : details.gesamtZinsen)}</div>
                        </div>
                        <div>
                          <div class="text-[color:var(--text-tertiary)] kpi-sub">Enddatum</div>
                          <div class="font-semibold text-base text-[color:var(--text-primary)]">${this.formatDate(details.endDate.toISOString().split('T')[0])}</div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              ${this.kredite.length > 0 ? `
                <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                  <span class="font-semibold text-gray-700">Gesamte Restschuld:</span>
                  <span class="kpi-value text-red-800">${this.formatCurrency(this.getGesamtKreditlast().restschuld)}</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                  <span class="font-semibold text-gray-700">Monatliche Belastung:</span>
                  <span class="text-xl font-bold text-[color:var(--text-primary)]">${this.formatCurrency(this.getGesamtKreditlast().monatlicheRate)}</span>
                </div>
              ` : ''}
            </div>

            <!-- Vorlagen -->
            <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 mt-6">
              <h2 class="flex items-center gap-2 text-2xl font-bold text-[color:var(--text-primary)] mb-4">${icons.fileText} <span>Ausgaben-Vorlagen</span></h2>
              <p class="text-sm text-[color:var(--text-tertiary)] mb-4">Erstelle Vorlagen f√ºr h√§ufig wiederkehrende Ausgaben.</p>
              
              <!-- Neue Vorlage erstellen -->
              <div class="mb-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                <div class="text-sm font-semibold text-indigo-700 mb-3">Neue Vorlage</div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
                  <input type="text" id="vorlName" placeholder="Name" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <input type="number" id="vorlBetrag" placeholder="Betrag" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <select id="vorlKat" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    ${this.kategorien.map(k => `<option value="${k}">${k}</option>`).join('')}
                  </select>
                  <button onclick="app.addVorlageFromForm()" class="btn-primary px-6 py-2 flex items-center justify-center gap-2">
                    ${icons.plus} Erstellen
                  </button>
                </div>
              </div>

              <!-- Vorlagen Liste -->
              <div class="space-y-3">
                ${this.ausgabenVorlagen.map(v => `
                  <!-- Mobile: Card Layout / Desktop: Horizontal -->
                  <div class="bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                    <!-- Desktop Layout (>= 768px) -->
                    <div class="hidden md:flex items-center justify-between p-3">
                      <div class="flex-1">
                        <span class="font-semibold text-gray-700">${v.name}</span>
                        <span class="kpi-sub text-[color:var(--text-tertiary)] ml-2">(${v.kategorie})</span>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="font-bold text-[color:var(--text-primary)]">${this.formatCurrency(v.betrag)}</span>
                        <button onclick="app.editVorlage(${v.id})" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors" title="Bearbeiten">
                          ${icons.edit}
                        </button>
                        <button onclick="app.deleteVorlage(${v.id})" class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors" title="L√∂schen">
                          ${icons.trash}
                        </button>
                      </div>
                    </div>
                    
                    <!-- Mobile Layout (< 768px) -->
                    <div class="md:hidden p-4">
                      <!-- Header: Name + Betrag -->
                      <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                          <div class="font-semibold text-[color:var(--text-primary)] text-lg">${v.name}</div>
                          <div class="kpi-sub text-[color:var(--text-tertiary)] mt-1">${v.kategorie}</div>
                        </div>
                        <div class="text-xl font-bold text-[color:var(--text-primary)] ml-3">
                          ${this.formatCurrency(v.betrag)}
                        </div>
                      </div>
                      
                      <!-- Buttons -->
                      <div class="flex gap-2">
                        <button onclick="app.editVorlage(${v.id})" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold flex items-center justify-center gap-2">
                          ${icons.edit} Bearbeiten
                        </button>
                        <button onclick="app.deleteVorlage(${v.id})" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center" title="L√∂schen">
                          ${icons.trash}
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }
    }

    setTimeout(() => {
      try {
        
        // --- v15.1 hotfix: ensure escapeHtml exists on instance (used by year view) ---
        if (!FinanceManagerCloud.prototype.escapeHtml) {
          FinanceManagerCloud.prototype.escapeHtml = function (value) {
            const s = String(value ?? '');
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return s.replace(/[&<>"']/g, (ch) => map[ch]);
          };
        }
        // --- end hotfix ---

window.app = new FinanceManagerCloud();
        dlog('‚úÖ Wallit erfolgreich initialisiert');
        
        // Initialize FAB
        setTimeout(() => {
          if (window.app && window.app.updateFAB) {
            window.app.updateFAB();
          }
        }, 500);
      } catch (error) {
        console.error('‚ùå Fehler beim Initialisieren:', error);
        document.body.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: #f3f4f6;">
            <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); max-width: 600px;">
              <h1 style="color: #ef4444; font-size: 24px; font-weight: bold; margin-bottom: 20px;">‚ö†Ô∏è Fehler beim Laden</h1>
              <p style="color: #666; margin-bottom: 20px;">Es gab einen Fehler beim Initialisieren der App:</p>
              <pre style="background: #fee; padding: 15px; border-radius: 8px; color: #ef4444; overflow-x: auto; font-size: 12px;">${error.message}\n\n${error.stack}</pre>
              <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                Neu laden
              </button>
            </div>
          </div>
        `;
      }
    }, 100);
  </script>
  
  <!-- Floating Action Button for Quick Cloud Upload (Mobile + Desktop) -->
  <div id="fabUpload" onclick="app.performSync()" title="In Cloud hochladen" style="position: fixed; top: 16px; right: 16px; width: 56px; height: 56px; cursor: pointer; display: none; z-index: 9999;">
    <svg width="56" height="56" viewBox="0 0 56 56" style="filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));">
      <circle cx="28" cy="28" r="28" fill="#10b981"/>
      <g transform="translate(16, 16)">
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"
           stroke="white"
           stroke-width="2.4"
           stroke-linecap="round"
           stroke-linejoin="round"
           fill="none"/>
      </g>
    </svg>
  </div>




<!-- Legacy browser scanner removed: use manual receiptScannerModal (no loop) -->

<!-- RECEIPT SCANNER (manual capture, iOS Safari-safe) -->
<div id="receiptScannerModal" class="notification-modal" style="display:none;">
 <div class="modal-content" style="max-width:560px;">
  <div class="rs-modal-header">
   <h3 style="margin:0;">Kassenbon scannen</h3>
   <div id="rsStatePill" class="rs-pill rs-pill-idle" aria-live="polite">
    <span id="rsPillLabel">Bereit</span>
    <span id="rsPillSpinner" class="rs-spinner" style="display:none;" aria-hidden="true"></span>
   </div>
  </div>

  <div id="rsLiveWrap" style="margin-top:10px;">
   <video id="rsVideo" autoplay playsinline muted
       style="width:100%;border-radius:12px;background:#0b1220;"></video>
   <p style="margin-top:10px;font-size:12px;opacity:.75;">
    Tipp: Bon flach hinlegen, gut ausleuchten und die Kamera ruhig halten. QR-Codes werden automatisch erkannt.
   </p>
  </div>

  <div id="rsPreviewWrap" style="display:none;margin-top:10px;">
   <img id="rsPreviewImg" alt="Bon Vorschau"
      style="width:100%;border-radius:12px;display:block;" />
   <p style="margin-top:10px;font-size:12px;opacity:.75;">
    Vorschau: Wenn Text unscharf ist, bitte erneut aufnehmen.
   </p>
  </div>

  <p id="rsStatus" style="margin-top:10px;font-size:13px;opacity:.85;"></p>

  <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;">
   <button id="rsCaptureBtn" class="btn-primary w-full" type="button">Foto aufnehmen</button>
   <button id="rsReshootBtn" class="secondary-btn w-full" type="button" style="display:none;">Erneut aufnehmen</button>
   <button id="rsScanBtn" class="btn-primary w-full" type="button" style="display:none;">Jetzt scannen</button>
   <button id="rsCloseBtn" class="secondary-btn w-full" type="button">Schlie√üen</button>
  </div>

  <p style="margin-top:10px;font-size:12px;opacity:.65;">
   Hinweis: Das Foto wird nicht gespeichert. Es wird nur kurz im Arbeitsspeicher verarbeitet.
  </p>
 </div>
</div>
<!-- END RECEIPT SCANNER -->


<script>
/* Receipt Scanner ‚Äî manual capture (no auto-scan), iOS Safari safe */
let rsStream = null;
let rsCapturedDataUrl = null;
let rsLastMerchantKey = null;

// Receipt Scanner state machine (single entry-point, race-safe)
const RS_STATE = Object.freeze({
 IDLE: "idle",
 CAMERA: "camera",
 CAPTURED: "captured",
 OCR: "ocr",
 DONE: "done",
 ERROR: "error"
});
let rsState = RS_STATE.IDLE;
let rsOcrInFlight = false;

function rsSetState(next, message){
 rsState = next;

 const status = rsEl("rsStatus");
 if(status && message) status.textContent = message;

 // State pill + spinner
 const pill = rsEl("rsStatePill");
 const pillLabel = rsEl("rsPillLabel");
 const pillSpin = rsEl("rsPillSpinner");
 if(pill){
  pill.classList.remove("rs-pill-idle","rs-pill-camera","rs-pill-captured","rs-pill-ocr","rs-pill-done","rs-pill-error");
  pill.classList.add("rs-pill-" + next);
 }
 if(pillLabel){
  const txt = (next === RS_STATE.CAMERA) ? "Kamera"
       : (next === RS_STATE.CAPTURED) ? "Vorschau"
       : (next === RS_STATE.OCR) ? "OCR"
       : (next === RS_STATE.DONE) ? "Fertig"
       : (next === RS_STATE.ERROR) ? "Fehler"
       : "Bereit";
  pillLabel.textContent = txt;
 }
 if(pillSpin){
  pillSpin.style.display = (next === RS_STATE.OCR) ? "" : "none";
 }

 // Button gating
 const cap = rsEl("rsCaptureBtn");
 const reshoot = rsEl("rsReshootBtn");
 const scan = rsEl("rsScanBtn");

 const inCamera = (next === RS_STATE.CAMERA);
 const hasCapture = (next === RS_STATE.CAPTURED || next === RS_STATE.ERROR);
 const isOcr = (next === RS_STATE.OCR);

 if(cap){
  cap.disabled = !inCamera || rsOcrInFlight;
  cap.style.display = inCamera ? "" : "none";
 }
 if(reshoot){
  reshoot.disabled = rsOcrInFlight;
  reshoot.style.display = hasCapture ? "" : "none";
 }
 if(scan){
  scan.disabled = !hasCapture || rsOcrInFlight || isOcr;
  scan.style.display = hasCapture ? "" : "none";
 }
}

async function rsStartCamera(){
 // Guard: don't start camera during OCR
 if(rsOcrInFlight) return;
 rsStopCamera();
 rsCapturedDataUrl = null;
 rsEl("rsPreviewImg").src = "";
 rsShowLive();
 rsSetState(RS_STATE.CAMERA, "Kamera wird vorbereitet ‚Ä¶");

 try {
  rsStream = await navigator.mediaDevices.getUserMedia({
   video: { facingMode: { ideal: "environment" } },
   audio: false
  });

  const video = rsEl("rsVideo");
  video.srcObject = rsStream;

  await new Promise(resolve => {
   const done = () => { video.removeEventListener("loadedmetadata", done); resolve(); };
   video.addEventListener("loadedmetadata", done);
   setTimeout(resolve, 900);
  });

  rsSetState(RS_STATE.CAMERA, "Bon oder QR-Code in den Rahmen halten");
 } catch(e) {
  console.error(e);
  rsSetState(RS_STATE.ERROR, "Kamera konnte nicht gestartet werden. Bitte Kamera-Berechtigung erlauben.");
 }
}

const VISION_OCR_ENDPOINT = "https://ocr-receipt-74837873538.europe-west3.run.app";

function rsStopCamera(){
 // Also stop QR + Barcode loops to avoid decoding on a dead stream
 rsStopQrScan();
 try { rsStopBarcodeScan(); } catch(e) {}
 try {
  if(rsStream){
   rsStream.getTracks().forEach(t => t.stop());
   rsStream = null;
  }
 } catch(e) {}
}

function rsEl(id){ return document.getElementById(id); }

// ----------------------------------------
// In-app confirm modal (replaces window.confirm)
// - Injected on first use (no layout changes to existing modals)
// ----------------------------------------
function rsEnsureConfirmModal(){
 if(document.getElementById("rsConfirmOverlay")) return;

 const overlay = document.createElement("div");
 overlay.id = "rsConfirmOverlay";
 overlay.style.cssText = "position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:100000;background:rgba(0,0,0,.55);";

 const dialog = document.createElement("div");
 dialog.id = "rsConfirmDialog";
 dialog.style.cssText = "width:100%;max-width:520px;border-radius:20px;overflow:hidden;background:var(--card-bg, #0b1220);border:1px solid rgba(255,255,255,.12);box-shadow:0 18px 60px rgba(0,0,0,.35);";

 const header = document.createElement("div");
 header.style.cssText = "display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08);";

 const title = document.createElement("h3");
 title.id = "rsConfirmTitle";
 title.style.cssText = "margin:0;font-size:16px;line-height:1.2;";
 title.textContent = "Best√§tigen";

 const pill = document.createElement("div");
 pill.style.cssText = "display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;opacity:.85;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);";
 pill.innerHTML = "<span>Hinweis</span>";

 header.appendChild(title);
 header.appendChild(pill);

 const body = document.createElement("div");
 body.style.cssText = "padding:14px 18px 6px 18px;";
 const text = document.createElement("p");
 text.id = "rsConfirmText";
 text.style.cssText = "margin:0;font-size:14px;line-height:1.35;opacity:.92;";
 body.appendChild(text);

 const footer = document.createElement("div");
 footer.style.cssText = "display:flex;gap:10px;flex-wrap:wrap;padding:14px 18px 18px 18px;";

 const ok = document.createElement("button");
 ok.id = "rsConfirmOk";
 ok.type = "button";
 ok.className = "btn-primary w-full";
 ok.textContent = "√úbernehmen";

 const cancel = document.createElement("button");
 cancel.id = "rsConfirmCancel";
 cancel.type = "button";
 cancel.className = "secondary-btn w-full";
 cancel.textContent = "Abbrechen";

 footer.appendChild(ok);
 footer.appendChild(cancel);

 dialog.appendChild(header);
 dialog.appendChild(body);
 dialog.appendChild(footer);
 overlay.appendChild(dialog);

 // backdrop click cancels
 overlay.addEventListener("click", (e) => {
  if(e.target === overlay) {
   cancel.click();
  }
 });

 document.body.appendChild(overlay);
}

function rsConfirmDialog({ title="Best√§tigen", text="", okText="√úbernehmen", cancelText="Abbrechen" } = {}){
 rsEnsureConfirmModal();
 const overlay = document.getElementById("rsConfirmOverlay");
 const t = document.getElementById("rsConfirmTitle");
 const p = document.getElementById("rsConfirmText");
 const ok = document.getElementById("rsConfirmOk");
 const cancel = document.getElementById("rsConfirmCancel");

 if(t) t.textContent = title;
 if(p) p.textContent = text;
 if(ok) ok.textContent = okText;
 if(cancel) cancel.textContent = cancelText;

 return new Promise(resolve => {
  const cleanup = () => {
   overlay.style.display = "none";
   ok.onclick = null;
   cancel.onclick = null;
  };

  ok.onclick = () => { cleanup(); resolve(true); };
  cancel.onclick = () => { cleanup(); resolve(false); };

  overlay.style.display = "flex";
 });
}


// ========================================
// QR scanning (optional, uses same camera feed)
// - Runs in background while the scanner modal is open
// - No layout changes: uses toast + confirm()
// ========================================
let rsQrTimer = null;
let rsQrLast = "";
let rsQrBusy = false;

function rsStopQrScan(){
 try { if (rsQrTimer) { clearInterval(rsQrTimer); rsQrTimer = null; } } catch(e){}
 rsQrBusy = false;
}

// ========================================
// Barcode scanning (EAN/UPC/Code128, etc.)
// - Uses same camera feed (rsVideo)
// - No layout changes: uses toast + confirm()
// - Uses ZXingBrowser (lazy-loaded) for iOS compatibility
// ========================================
let rsBcControls = null;
let rsBcLast = "";
let rsBcActive = false;

function rsStopBarcodeScan(){
 rsBcActive = false;
 try { if (rsBcControls && rsBcControls.stop) rsBcControls.stop(); } catch(e){}
 rsBcControls = null;
}

function rsIsMaybeBarcode(payload){
 const s = String(payload||"").trim();
 // Common retail codes: EAN-13/8, UPC-A(12), UPC-E(6), Code128 etc.
 // We accept digits 6-14 (to not block smaller codes), allow leading zeros.
 return /^[0-9]{6,14}$/.test(s);
}

async function rsStartBarcodeScan(){
 try {
  if(rsBcActive) return;
  const modal = rsEl("receiptScannerModal");
  if(!modal || modal.style.display === "none") return;
  if(rsState !== RS_STATE.CAMERA) return;

  const video = rsEl("rsVideo");
  if(!video || !video.srcObject) return;

  // Load ZXing only when needed
  if(window.ensureZXing) await window.ensureZXing();
  if(!window.ZXingBrowser) return;

  rsBcActive = true;

  // Configure supported formats if enums are available (optional)
  let hints;
  try {
   const ZX = window.ZXingBrowser;
   if (ZX.DecodeHintType && ZX.BarcodeFormat) {
    hints = new Map();
    const formats = [
     ZX.BarcodeFormat.EAN_13,
     ZX.BarcodeFormat.EAN_8,
     ZX.BarcodeFormat.UPC_A,
     ZX.BarcodeFormat.UPC_E,
     ZX.BarcodeFormat.CODE_128,
     ZX.BarcodeFormat.CODE_39
    ].filter(Boolean);
    if (formats.length) hints.set(ZX.DecodeHintType.POSSIBLE_FORMATS, formats);
   }
  } catch(e){}

  const ZX = window.ZXingBrowser;

  // BrowserMultiFormatReader exists in newer versions; fallback to BrowserCodeReader if not.
  let reader;
  try {
   reader = ZX.BrowserMultiFormatReader ? new ZX.BrowserMultiFormatReader(hints) : null;
  } catch(e) { reader = null; }
  if(!reader){
   try { reader = new ZX.BrowserCodeReader(hints); } catch(e) { reader = null; }
  }
  if(!reader){
   rsBcActive = false;
   return;
  }

  // Continuous decode from the existing <video> element.
  // Returns controls with .stop()
  rsBcControls = await reader.decodeFromVideoElement(video, async (result, err, controls) => {
   if(!rsBcControls && controls) rsBcControls = controls;
   if(!rsBcActive) { try { controls && controls.stop && controls.stop(); } catch(e){}; return; }

   // ignore NotFound errors; act on results
   if(result && result.getText){
    const payload = String(result.getText() || "").trim();
    if(!payload) return;

    // De-dupe and prefer numeric retail-like codes
    if(payload === rsBcLast) return;
    if(!rsIsMaybeBarcode(payload)) return;

    rsBcLast = payload;

    if(window.showToast) window.showToast("Barcode erkannt", "success");
    rsStopBarcodeScan();

    const ok = await rsConfirmDialog({ title: "Barcode erkannt", text: "Betr√§ge und Datum sind meist nicht enthalten. Trotzdem √ºbernehmen?", okText: "√úbernehmen", cancelText: "Abbrechen" });
    if(ok){
     // Reuse the same flow as QR/OCR: parse payload and fill Ausgaben-Formfelder.
     const parsed = rsParseQrPayload(payload);
     const fields = rsExtractFieldsFromQr(parsed);
     rsApplyQrToForm(fields);
     if(window.showToast) window.showToast("Vorschl√§ge √ºbernommen. Bitte kurz pr√ºfen.", "success");
    } else {
     // Resume after short delay
     setTimeout(()=>{ try { rsStartBarcodeScan(); } catch(e){} }, 600);
    }
   }
  });
 } catch(e){
  // Fail silently; barcode scanning is optional
  rsBcActive = false;
 }
}

function rsParseQrPayload(payload){
 const raw = String(payload || "").trim();
 if(!raw) return null;

 // Try JSON
 try {
  const obj = JSON.parse(raw);
  if(obj && typeof obj === "object") return { type:"json", raw, obj };
 } catch(e){}

 // Try URL params
 try {
  const u = new URL(raw);
  const params = Object.fromEntries(u.searchParams.entries());
  return { type:"url", raw, url: u, params };
 } catch(e){}

 return { type:"text", raw };
}

function rsExtractFieldsFromQr(qr){
 const out = { datum:"", betrag:"", name:"" };

 const takeAmount = (s) => {
  const m = String(s||"").match(/\b\d{1,6}([.,]\d{2})\b/);
  if(!m) return "";
  return m[0].replace(",", ".");
 };

 const takeDate = (s) => {
  const t = String(s||"");
  // yyyy-mm-dd
  let m = t.match(/\b\d{4}-\d{2}-\d{2}\b/);
  if(m) return m[0];
  // dd.mm.yyyy
  m = t.match(/\b\d{2}[.\-/]\d{2}[.\-/]\d{4}\b/);
  if(m){
   const s2 = m[0].replace(/\//g,".").replace(/-/g,".");
   const [d,mo,y] = s2.split(".");
   return `${y}-${mo}-${d}`;
  }
  return "";
 };

 const firstNonEmpty = (...arr) => arr.find(v => String(v||"").trim()) || "";

 if(qr.type === "json"){
  const o = qr.obj || {};
  out.name = firstNonEmpty(o.name, o.desc, o.description, o.merchant, o.vendor, o.title);
  out.betrag = firstNonEmpty(o.amount, o.total, o.sum, "");
  if(!out.betrag) out.betrag = takeAmount(JSON.stringify(o));
  out.datum = firstNonEmpty(o.date, o.datum, "");
  if(!out.datum) out.datum = takeDate(JSON.stringify(o));
 } else if(qr.type === "url"){
  const p = qr.params || {};
  out.name = firstNonEmpty(p.name, p.desc, p.description, p.merchant, p.vendor, p.title, qr.url?.hostname);
  out.betrag = firstNonEmpty(p.amount, p.total, p.sum, "");
  if(!out.betrag) out.betrag = takeAmount(qr.raw);
  out.datum = firstNonEmpty(p.date, p.datum, "");
  if(!out.datum) out.datum = takeDate(qr.raw);
 } else {
  out.name = qr.raw.length <= 80 ? qr.raw : qr.raw.slice(0, 80);
  out.betrag = takeAmount(qr.raw);
  out.datum = takeDate(qr.raw);
 }

 // normalize amount
 if(out.betrag) out.betrag = String(out.betrag).replace(",", ".").replace(/[^0-9.]/g,"");
 return out;
}

function rsApplyQrToForm(fields){
 try {
  const nameEl = document.getElementById("ausgName");
  const betragEl = document.getElementById("ausgBetrag");
  const datumEl = document.getElementById("ausgDatum");

  if(fields.name && nameEl) nameEl.value = fields.name;
  if(fields.betrag && betragEl) betragEl.value = fields.betrag;
  if(fields.datum && datumEl) datumEl.value = fields.datum;

  // Nudge UI update if your app listens to input events
  if(nameEl) nameEl.dispatchEvent(new Event("input", {bubbles:true}));
  if(betragEl) betragEl.dispatchEvent(new Event("input", {bubbles:true}));
  if(datumEl) datumEl.dispatchEvent(new Event("input", {bubbles:true}));
 } catch(e){}
}

async function rsStartQrScan(){
 // Avoid scanning during OCR / preview / no camera
 if(rsOcrInFlight) return;
 if(rsQrTimer) return;

 try {
  await window.ensureJSQR?.();
  if(!window.jsQR) return;
 } catch(e){
  return;
 }

 const video = rsEl("rsVideo");
 if(!video) return;

 // Small offscreen canvas for speed
 const c = document.createElement("canvas");
 const ctx = c.getContext("2d", { willReadFrequently: true });

 rsQrTimer = setInterval(async () => {
  if(rsQrBusy) return;
  if(!rsEl("receiptScannerModal") || rsEl("receiptScannerModal").style.display === "none") return;
  if(rsState !== RS_STATE.CAMERA) return;
  if(!video.videoWidth || !video.videoHeight) return;

  rsQrBusy = true;
  try {
   // Center crop (QR codes are usually central). Keeps work small on iPhone.
   const vw = video.videoWidth;
   const vh = video.videoHeight;
   const size = Math.min(vw, vh, 520);
   const sx = Math.floor((vw - size) / 2);
   const sy = Math.floor((vh - size) / 2);

   const dw = 360; // decode resolution
   const dh = 360;
   c.width = dw; c.height = dh;
   ctx.drawImage(video, sx, sy, size, size, 0, 0, dw, dh);

   const img = ctx.getImageData(0, 0, dw, dh);
   const code = window.jsQR(img.data, dw, dh, { inversionAttempts: "attemptBoth" });

   if(code && code.data){
    const payload = String(code.data).trim();
    if(payload && payload !== rsQrLast){
     rsQrLast = payload;

     // Ask user before applying, keep modal/layout intact
     if(window.showToast) window.showToast("QR-Code erkannt", "success");

     // Prevent spamming: pause scanning until user reacts
     rsStopQrScan();

     const ok = await rsConfirmDialog({ title: "QR-Code erkannt", text: "M√∂chtest du die erkannten Daten √ºbernehmen?", okText: "√úbernehmen", cancelText: "Abbrechen" });
     if(ok){
      const parsed = rsParseQrPayload(payload);
      const fields = rsExtractFieldsFromQr(parsed || {type:"text", raw:payload});
      rsApplyQrToForm(fields);
      // Close scanner; user can still scan receipts later
      closeReceiptScanner();
      if(window.showToast) window.showToast("Daten √ºbernommen. Bitte kurz pr√ºfen.", "success");
     } else {
      // resume scanning
      rsQrLast = payload; // keep last to avoid immediate re-trigger
      setTimeout(()=>{ try { rsStartQrScan(); } catch(e){} }, 600);
     }
    }
   }
  } catch(e){
   // ignore decode errors
  } finally {
   rsQrBusy = false;
  }
 }, 220);
}


function rsShowLive() {
 rsEl("rsLiveWrap").style.display = "";
 rsEl("rsPreviewWrap").style.display = "none";
 rsEl("rsCaptureBtn").style.display = "";
 rsEl("rsReshootBtn").style.display = "none";
 rsEl("rsScanBtn").style.display = "none";
 rsCapturedDataUrl = null;
 rsEl("rsStatus").textContent = "Bon oder QR-Code in den Rahmen halten";
}

function rsShowPreview(dataUrl) {
 rsEl("rsPreviewImg").src = dataUrl;
 rsEl("rsLiveWrap").style.display = "none";
 rsEl("rsPreviewWrap").style.display = "";
 rsEl("rsCaptureBtn").style.display = "none";
 rsEl("rsReshootBtn").style.display = "";
 rsEl("rsScanBtn").style.display = "";
 rsEl("rsStatus").textContent = "Vorschau OK? Dann ‚ÄûJetzt scannen‚Äú.";
}

async function openReceiptScanner(){
 rsEl("receiptScannerModal").style.display = "flex";
 rsShowLive();
 await rsStartCamera();
 // QR + Barcode scanning run in background (same camera feed), no UI changes required
 try { rsStartQrScan(); } catch(e){}
 try { rsStartBarcodeScan(); } catch(e){}
}

function closeReceiptScanner(){
 rsStopQrScan();

 rsStopCamera();
 rsEl("receiptScannerModal").style.display = "none";
 rsCapturedDataUrl = null;
 rsOcrInFlight = false;
 rsSetState(RS_STATE.IDLE, "");
}

function rsCaptureFrame(){
 if(rsOcrInFlight) return;
 if(rsState !== RS_STATE.CAMERA){
  rsSetState(rsState, "Bitte zuerst die Kamera starten.");
  return;
 }
 const video = rsEl("rsVideo");
 const status = rsEl("rsStatus");

 if(!video.videoWidth || !video.videoHeight){
  status.textContent = "Kamera wird vorbereitet ‚Ä¶";
  return;
 }

 // Capture single sharp frame (in memory)
 const maxW = 1600; // higher for better OCR
 const scale = Math.min(1, maxW / video.videoWidth);
 const cw = Math.floor(video.videoWidth * scale);
 const ch = Math.floor(video.videoHeight * scale);

 const canvas = document.createElement("canvas");
 canvas.width = cw;
 canvas.height = ch;
 const ctx = canvas.getContext("2d");
 ctx.drawImage(video, 0, 0, cw, ch);

 // Optional: slight contrast boost for receipts
 // (kept minimal to avoid artifacts)

 rsCapturedDataUrl = canvas.toDataURL("image/jpeg", 0.92);

 // Immediately free canvas memory
 canvas.width = 1; canvas.height = 1;

 // Stop camera to freeze + privacy + battery
 rsStopCamera();

 rsShowPreview(rsCapturedDataUrl);
 rsSetState(RS_STATE.CAPTURED, "Vorschau OK? Dann ‚ÄûJetzt scannen‚Äú.");
}

function rsNormalizeText(s){
 return String(s||"")
  .toUpperCase()
  .replace(/√Ñ/g,"AE").replace(/√ñ/g,"OE").replace(/√ú/g,"UE").replace(/√ü/g,"SS")
  .replace(/[^A-Z0-9 ]+/g," ")
  .replace(/\s+/g," ")
  .trim();
}

function rsIsNoiseLine(line){
 const u = rsNormalizeText(line);
 if(!u) return true;
 const noise = [
  "KUNDENBELEG","BELEG","RECHNUNG","BON","KASSE","BEDIEN","FILIALE","TEL","TELEFON","WWW","HTTP","HTTPS",
  "UST","MWST","STEUER","BRUTTO","NETTO","SUMME","GESAMT","ZU ZAHLEN","ZAHLUNG","VISA","MASTERCARD","EC",
  "KARTENZAHLUNG","TERMINAL","TRANSAKTION","TID","AID","NR","KASSENNR","KARTENNR","AUTORISIERUNG",
  "RUECKGELD","GEGEBEN","CHANGE","BAR","CASH","EUR","‚Ç¨"
 ];
 if(noise.some(n => u.includes(n))) return true;
 // Mostly digits => not a merchant line
 const digits = (u.match(/\d/g)||[]).length;
 if(digits >= Math.max(4, u.length*0.5)) return true;
 return false;
}

function rsMerchantFromText(fullText){
 const lines = String(fullText||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
 // Brand aliases (fuzzy-ish contains)
 const brands = [
  {k:"HORNBACH", v:"Hornbach", aliases:["HORNACH","HORN BACH","HORN-BACH"]},
  {k:"REWE", v:"REWE", aliases:["REW3","REWF"]},
  {k:"EDEKA", v:"EDEKA", aliases:["EDEK4"]},
  {k:"LIDL", v:"LIDL", aliases:["LID1","LIDl"]},
  {k:"ALDI", v:"ALDI", aliases:["ALDl","ALD1"]},
  {k:"NETTO", v:"NETTO", aliases:["NETT0"]},
  {k:"KAUFLAND", v:"Kaufland", aliases:["KAUF LAND"]},
  {k:"PENNY", v:"PENNY", aliases:[]},
  {k:"ROSSMANN", v:"Rossmann", aliases:["ROSMANN"]},
  {k:"DM", v:"dm", aliases:[]},
  {k:"MUELLER", v:"M√ºller", aliases:["MUELLER","MULLER"]},
  {k:"IKEA", v:"IKEA", aliases:[]},
  {k:"OBI", v:"OBI", aliases:[]},
  {k:"BAUHAUS", v:"BAUHAUS", aliases:["BAU HAUS"]},
  {k:"TOOM", v:"toom", aliases:[]},
  {k:"HAGEBAU", v:"hagebau", aliases:["HAGE BAU"]}
 ];

 // Build candidates, favor top half but skip obvious noise
 const cand = [];
 for(let i=0;i<lines.length;i++){
  const raw = lines[i];
  if(rsIsNoiseLine(raw)) continue;
  const norm = rsNormalizeText(raw);

  // strong hints for legal forms
  const legal = /\b(GMBH|AG|KG|E\.K\.|EK|SE|OHG|UG)\b/.test(norm);
  const scoreBase = legal ? 5 : 0;

  // brand match
  let brandHit = null;
  for(const b of brands){
   if(norm.includes(b.k) || b.aliases.some(a => norm.includes(rsNormalizeText(a)))) {
    brandHit = b;
    break;
   }
  }

  let score = scoreBase;
  if(brandHit) score += 20;

  // Earlier lines are more likely merchant, but not always. Add small bias.
  score += Math.max(0, 10 - Math.floor(i/2));

  // Too long lines are often address; penalize
  if(norm.length > 28) score -= 2;

  cand.push({ raw, norm, i, score, brandHit });
 }

 // Choose best candidate
 cand.sort((a,b)=>b.score-a.score);
 if(!cand.length) return { merchant:"", key:"" };

 const best = cand[0];
 let merchant = best.raw;
 let key = best.norm;

 if(best.brandHit) {
  merchant = best.brandHit.v;
  key = best.brandHit.k;
 } else {
  // Clean legal suffixes and extra
  merchant = merchant.replace(/\b(GmbH|AG|KG|e\.K\.|EK|SE|OHG|UG)\b.*$/i, (m)=>m.trim());
  merchant = merchant.trim();
 }

 // learning override
 const learned = localStorage.getItem("wallit_merchant_learn_" + key);
 if(learned) merchant = learned;

 return { merchant, key };
}

function rsParseDate(fullText){
 const m = String(fullText||"").match(/\d{2}[.\-\/]\d{2}[.\-\/]\d{4}/);
 if(!m) return "";
 const s = m[0].replace(/\//g,".").replace(/-/g,".");
 const [d,mo,y] = s.split(".");
 return `${y}-${mo}-${d}`;
}

function rsParseTotal(fullText){
 const text = String(fullText||"");
 const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
 const keys = ["ZU ZAHLEN","GESAMT","SUMME","BRUTTO","BETRAG","TOTAL"];
 for(const line of lines){
  const u = rsNormalizeText(line);
  if(keys.some(k => u.includes(k))){
   const m = line.match(/\d+[,.]\d{2}/);
   if(m) return parseFloat(m[0].replace(",", "."));
  }
 }
 const amounts = text.match(/\d+[,.]\d{2}/g) || [];
 if(!amounts.length) return null;
 return Math.max(...amounts.map(a=>parseFloat(a.replace(",", "."))));
}

async function rsSendToVision(dataUrl){
 const resp = await fetch(VISION_OCR_ENDPOINT, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ imageBase64: dataUrl })
 });
 const data = await resp.json();
 if(!resp.ok) {
  throw new Error(data?.error || "OCR request failed");
 }
 // support both shapes: {fullText,...} or {text,...}
 return data.fullText || data.text || "";
}

async function rsScanNow(){
 const status = rsEl("rsStatus");

 if(rsOcrInFlight) return;

 if(rsState !== RS_STATE.CAPTURED && rsState !== RS_STATE.ERROR){
  rsSetState(rsState, "Bitte zuerst ein Foto aufnehmen.");
  return;
 }
 if(!rsCapturedDataUrl){
  rsSetState(rsState, "Bitte zuerst ein Foto aufnehmen.");
  return;
 }

 rsOcrInFlight = true;
 rsSetState(RS_STATE.OCR, "Beleg wird analysiert ‚Ä¶");

 try {
  const fullText = await rsSendToVision(rsCapturedDataUrl);

  if(!fullText) {
 status.textContent = "Keine Daten erkannt. Du kannst die Angaben manuell eingeben.";
 // Speicher freigeben (DataURL kann gro√ü sein)
 rsCapturedDataUrl = null;
 rsEl("rsPreviewImg").src = "";
 rsSetState(RS_STATE.ERROR);
 return;
}

  rsEl("rsStatus").textContent = "Daten werden zugeordnet ‚Ä¶";

  const m = rsMerchantFromText(fullText);
  rsLastMerchantKey = m.key || null;

  const dateISO = rsParseDate(fullText);
  const total = rsParseTotal(fullText);

  // Fill fields in the Variable Ausgaben form (cache lookups)
const beschreibung = window.__wallitBeschrEl || (window.__wallitBeschrEl = document.querySelector("input[placeholder='Beschreibung']"));
const betrag = window.__wallitBetragEl || (window.__wallitBetragEl = document.querySelector("input[placeholder='Betrag']"));
const datum = window.__wallitDatumEl || (window.__wallitDatumEl = document.querySelector("input[type='date']"));
if(beschreibung && m.merchant) beschreibung.value = m.merchant;
  if(betrag && total != null) betrag.value = Number(total).toFixed(2);
  if(datum && dateISO) datum.value = dateISO;

  rsSetState(RS_STATE.DONE, "Vorschl√§ge √ºbernommen. Bitte kurz pr√ºfen.");

  // Clear image from memory ASAP
  rsCapturedDataUrl = null;
  rsEl("rsPreviewImg").src = "";
  setTimeout(closeReceiptScanner, 450);
 } catch(e) {
  console.error(e);
  rsSetState(RS_STATE.ERROR, "OCR Fehler: " + (e?.message || String(e)));
 } finally {
  rsOcrInFlight = false;
  // refresh button states without overriding message
  rsSetState(rsState);
 }
}

// Learning: if user edits Beschreibung after scan, store mapping
(function setupMerchantLearning(){
 document.addEventListener("input", (ev) => {
  const el = ev.target;
  if(!el) return;
  if(el.matches('input[placeholder="Beschreibung"]')) {
   // store last edit time
   el.dataset._wallitEdited = "1";
  }
 });

 document.addEventListener("change", (ev) => {
  const el = ev.target;
  if(!el) return;
  if(el.matches('input[placeholder="Beschreibung"]')) {
   if(!rsLastMerchantKey) return;
   const v = (el.value||"").trim();
   if(v.length < 2) return;
   localStorage.setItem("wallit_merchant_learn_" + rsLastMerchantKey, v);
  }
 });
})();

// Wire modal buttons
(function initReceiptScannerUI(){
 const cap = rsEl("rsCaptureBtn");
 const reshoot = rsEl("rsReshootBtn");
 const scan = rsEl("rsScanBtn");
 const close = rsEl("rsCloseBtn");

 if(cap) cap.addEventListener("click", rsCaptureFrame);
 if(reshoot) reshoot.addEventListener("click", async () => { await rsStartCamera(); });
 if(scan) scan.addEventListener("click", rsScanNow);
 if(close) close.addEventListener("click", closeReceiptScanner);
 // init state
 rsSetState(RS_STATE.IDLE, "");
})();
</script>


  <!-- CSV Import (hidden) -->
  <input id="csvImportInput" type="file" accept=".csv,text/csv" class="hidden" onchange="app.handleCSVImport(event)" />

</body>
</html>